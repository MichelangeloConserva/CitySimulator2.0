define("modules/clean/comments/collection_utils",["require","exports","tslib","modules/clean/annotations/annotation","modules/clean/datetime","modules/core/i18n"],function(t,e,o,n,i,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),i=o.__importStar(i);var r=function(t){for(var e={},o=[],n=Date.now(),r=0,a=Array.from(t);r<a.length;r++){var l,c=a[r],u=new Date(c.comment.when_mses),d=n-c.comment.when_mses;l=d<12e4?s._("Just now"):d<864e5?s._("Today"):d<1728e5?s._("Yesterday"):i.format_date(u,"MMM d, yyyy"),e[l]?e[l].push(c):(o.push(l),e[l]=[c])}return[o,e]};e.groupCommentActivitiesByTime=r;var a=function(t){for(var e={},o=[],i=0,s=Array.from(t);i<s.length;i++){var r=s[i];if(r.comment.hasMetadata()&&r.comment.comment_metadata.hasAnnotationData()){var a,l=n.Annotation.createAnnotationFromDict(r.comment.comment_metadata.annotation);a=l.isImageAnnotation()?1:l.getFirstPdfPage(),e[a]?e[a].push(r):(o.push(a),e[a]=[r])}}return o.sort(function(t,e){return t-e}),[o,e]};e.groupAnnotationActivitiesByPage=a;var l=function(t){for(var e=[],o=[],n=0;n<t.length;n++){var i=t[n];null==i.comment?(o.push(i),n+1===t.length&&e.push(o)):(o.length&&e.push(o.slice()),o=[])}return e};e.groupFileRevisions=l;var c=function(t,e){void 0===e&&(e={}),null==e.includeAnnotations||e.includeAnnotations;for(var o=null==e.includeDocLevel||e.includeDocLevel,n=null==e.includeNotResolved||e.includeNotResolved,i=null!=e.includeResolved&&e.includeResolved,s=null!=e.sortBy?e.sortBy:null,r=[],a=0,l=Array.from(t);a<l.length;a++){var c=l[a],u=c.comment.hasMetadata()&&c.comment.comment_metadata.hasAnnotationData();!e.includeAnnotations&&u||(o||u)&&(i&&c.comment.resolved&&r.push(c),n&&!c.comment.resolved&&r.push(c))}return s&&r.sort(function(t,e){return s(t,e)}),r};e.filterCommentActivities=c;var u=function(t){for(var e=0,o=0,n=Array.from(t);o<n.length;o++){n[o].comment.resolved&&e++}return e};e.getNumResolved=u;var d=function(t,e){return t.comment.when_mses-e.comment.when_mses};e.sortByTime=d;var p=function(t,e){var o,n;return o=null!=t.comment?t.comment.when_mses:t.when_mses,n=null!=e.comment?e.comment.when_mses:e.when_mses,n-o};e.sortByTimeOfCommentOrFileRevision=p;var m=function(t,e){var o,n;return o=null!=t.comment?t.comment.when_mses:t[0].when_mses,n=null!=e.comment?e.comment.when_mses:e[0].when_mses,n-o};e.sortByTimeOfCommentOrFileRevisions=m;var h=function(t,e){var o=t.comment.when_mses;t.comment_activities.length>0&&(o=t.comment_activities[t.comment_activities.length-1].when_mses);var n=e.comment.when_mses;return e.comment_activities.length>0&&(n=e.comment_activities[e.comment_activities.length-1].when_mses),n-o};e.sortByReplyTime=h;var _=function(t,e){var o=n.Annotation.createAnnotationFromDict(t.comment.comment_metadata.annotation),i=n.Annotation.createAnnotationFromDict(e.comment.comment_metadata.annotation),s=o.getFirstCoordindates().x,r=o.getFirstCoordindates().y,a=i.getFirstCoordindates().x;return i.getFirstCoordindates().y-r||a-s};e.sortByCoordinates=_}),define("modules/clean/comments/components/stickers",["require","exports","tslib","jquery","react","external/react-dom","external/classnames","modules/core/i18n","modules/clean/sticker_util","modules/clean/react/pure_render","modules/clean/react/file_comments/live_sticker"],function(t,e,o,n,i,s,r,a,l,c,u){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importStar(s),r=o.__importDefault(r);var d=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.onClick=function(t){t.preventDefault(),e.props.onClick&&e.props.onClick(e.props.value.id)},e}return o.__extends(e,t),e.prototype.render=function(){var t=this.props.value,e=t.id,o=t.live_sticker,n=o?i.default.createElement(u.LiveSticker,{size:"small",skipInitial:!0,stickerId:e}):i.default.createElement("img",{src:this.props.stickerUtil.getStickerImageUrl(e)});return i.default.createElement("button",{onClick:this.onClick,"data-sticker-id":e},n)},e=o.__decorate([c.pureRender],e)})(i.default.Component),p=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o.__extends(e,t),e.prototype.render=function(){var t=this,e=this.props,o=e.isSelected,n=e.data,s=e.stickerUtil,a=r.default("sticker-set",{"is-selected":o});return i.default.createElement("div",{className:a},n.stickers.map(function(e){return i.default.createElement(d,{value:e,onClick:t.props.onStickerClick,stickerUtil:s})}))},e=o.__decorate([c.pureRender],e)})(i.default.Component),m=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.onClick=function(t){e.props.onChangeSelection&&e.props.onChangeSelection(e.props.data.id)},e}return o.__extends(e,t),e.prototype.render=function(){var t=this.props,e=t.isSelected,o=t.data,n=r.default({"sticker-nav-item":!0,"is-selected":e});return i.default.createElement("button",{className:n,onClick:this.onClick,"aria-pressed":e},i.default.createElement("img",{src:this.props.stickerUtil.getStickerSetImageUrl(o.id),alt:a._("Sticker set")}))},e=o.__decorate([c.pureRender],e)})(i.default.Component),h=(function(t){function e(e){var o=t.call(this,e)||this;o.onChangeSelection=function(t){o.setState({selected:t})},o.onStickerSelected=function(t){o.props.onStickerSelected&&o.props.onStickerSelected(t)},o.onLeftArrowPress=function(t){o.setState({scrollOffset:Math.min(0,o.state.scrollOffset+l.SCROLL_DISTANCE)})},o.onRightArrowPress=function(t){o.setState({scrollOffset:Math.max(o.getMaxScroll(),o.state.scrollOffset-l.SCROLL_DISTANCE)})};var n=e.stickerUtil.getStickers();return o.state={stickerSets:n,selected:n[0].id,scrollOffset:0,maxScroll:-1},o}return o.__extends(e,t),l=e,e.prototype.componentWillUpdate=function(){var t=this.getMaxScroll();t!==this.state.maxScroll&&this.setState({maxScroll:t})},e.prototype.getMaxScroll=function(){var t=0;n.default(s.findDOMNode(this)).find(".sticker-nav-item").each(function(e){t+=n.default(this).outerWidth(!0)});return n.default(s.findDOMNode(this.refs.tabs)).width()-t-60},e.prototype.renderTabs=function(t){var e=this.props.isPopupAbove,o=this.state,n=o.scrollOffset,s=o.maxScroll,l=r.default({"sticker-nav":!0,"show-left":n<0,"show-right":n!==s,"on-top":e,"on-bottom":!e});return i.default.createElement("div",{className:l,ref:"tabs"},i.default.createElement("button",{"aria-label":a._("Scroll sticker set left"),className:"arrow left",onClick:this.onLeftArrowPress}),i.default.createElement("div",{className:"sticker-nav-inner",style:{marginLeft:n}},t),i.default.createElement("button",{"aria-label":a._("Scroll sticker set right"),className:"arrow right",onClick:this.onRightArrowPress}))},e.prototype.render=function(){for(var t=this.props,e=t.isPopupAbove,o=t.stickerUtil,n=[],s=[],r=0,a=o.getStickers();r<a.length;r++){var l=a[r];n.push(i.default.createElement(m,{data:l,isSelected:l.id===this.state.selected,onChangeSelection:this.onChangeSelection,stickerUtil:o})),s.push(i.default.createElement(p,{data:l,isSelected:l.id===this.state.selected,onStickerClick:this.onStickerSelected,stickerUtil:o}))}return i.default.createElement("div",{className:"sticker-container"},i.default.createElement("div",{className:"sticker-menu"},e&&this.renderTabs(n),i.default.createElement("div",{className:"sticker-sets-scrollable"},s),!e&&this.renderTabs(n)))},e.SCROLL_DISTANCE=200,e=l=o.__decorate([c.pureRender],e);var l})(i.default.Component);e.Stickers=l.withAsyncStickerUtil(h,i.default.createElement("div",{className:"sticker-container-placeholder"}))}),define("modules/clean/contacts/bloodhound_contacts",["require","exports","tslib","external/bloodhound","external/lodash","modules/clean/contacts/cache_store","modules/clean/contacts/contact","modules/clean/contacts/list","modules/clean/profile_services/profile_services_link","modules/clean/viewer","modules/core/exception"],function(t,e,o,n,i,s,r,a,l,c,u){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),a=o.__importDefault(a);var d=(function(){function t(t,e,o,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===o&&(o=10),void 0===i&&(i=!1);var a=this;this._get=this._get.bind(this),this.contacts_filter=t,this.for_user=e,this.limit=o,this._filter_dr_users=i,this.contacts=new n.default({datumTokenizer:function(t){return[t.name,t.email,t.fname,t.lname].concat(t.name_tokens)},queryTokenizer:function(t){return t.query},identify:r.ContactCommon.get_key,sufficient:this.limit,sorter:this._contacts_sorter,local:[],remote:null}),this.contacts.initialize(),this.sortedContacts=[],this.extraContacts=[],this._batchGetQueue=[],this._getRequest=null,this._updatedCallbacks=[],this.contacts_cache=s.DefaultContactsCacheStore.getOrCreateForViewer(),c.Viewer.get_viewer().is_signed_in&&this.contacts_cache.load_contacts(!0,function(t){return a._init_contacts(t)});for(var u=0,d=Array.from(c.Viewer.get_viewer().get_users());u<d.length;u++){var p=d[u];l.LinkedProfileServices.get_linked_profile_services_for_user(p.id).register_for_service_changes("bloodhound_contacts",function(t){return a.contacts.clearRemoteCache()})}}return t.prototype._contacts_sorter=function(t,e){return t.sort_key>e.sort_key?-1:t.sort_key<e.sort_key?1:0},t.prototype._init_contacts=function(t){var e=this;return this._update_contacts(t),this.contacts_cache.register_for_updates("bloodhound_contacts",function(t){return e._update_contacts(t)})},t.prototype._filter_contacts=function(t){var e;return e=null!=this.for_user&&c.Viewer.get_viewer().is_user_signed_in(this.for_user)?t.includeForUser(this.for_user.id):t.excludePairedUserDuplicates(),this.contacts_filter&&(e=e.filterContacts(this.contacts_filter)),e.contacts},t.prototype._update_contacts=function(t){var e=this;this.contacts.clearRemoteCache(),this.contacts.clear();var o=this._filter_contacts(t).filter(r.ContactCommon.is_valid);this.contacts.add(o);var n=this._dedupe_extra_contacts().filter(r.ContactCommon.is_valid);this.contacts.add(n);var i=o.concat(n);return i.sort(function(t,o){return e._contacts_sorter(t,o)}),this.sortedContacts=i.slice(0,this.limit),Array.from(this._updatedCallbacks).map(function(t){return"function"==typeof t?t():void 0})},t.prototype.setExtraContacts=function(t){return this.extraContacts=t},t.prototype._dedupe_extra_contacts=function(){for(var t=this.contacts.all(),e={},o={},n=0,i=Array.from(t);n<i.length;n++){var s=i[n];e[s.email]=!0,o[s.dbx_account_id]=!0}return this.extraContacts.filter(function(t){return!o[t.dbx_account_id]&&!e[t.email]})},t.prototype._add_request=function(t,e){var o=Boolean(0===this._batchGetQueue.length&&null===this._getRequest),n=Array.isArray(t),i={query:n?t:t.trim().split(/\s+/),callback:e,match_any:n,blocking:!0};return i.match_any?this._batchGetQueue.push(i):this._getRequest=i,o},t.prototype._next_get_request=function(){var t=null;return null!=this._getRequest?(t=this._getRequest,this._getRequest=null):this._batchGetQueue.length>0&&(t=this._batchGetQueue[0],this._batchGetQueue.splice(0,1)),t},t.prototype._get=function(){var t=this,e=this._next_get_request();if(e){var o=function(o){var n=a.default.create_contacts_list(o);return"function"==typeof e.callback&&e.callback(t._filter_contacts(n)),t._get()};if(e.match_any){for(var n=[],s=function(t){return n.push.apply(n,Array.from(t||[]))},r=0,l=Array.from(e.query);r<l.length;r++){var c=l[r];this.contacts.search({query:[c]},s,s)}return o(n)}return this.contacts.search(i.omit(e,"callback"),o,o)}},t._is_directory_restricted=function(t,e){if(void 0===t||void 0===e)return!1;var o=Array.isArray(t)?t:[t];o=o.map(function(t){return t.trim().toLowerCase()});var n=e.email&&o.indexOf(e.email.toLocaleLowerCase())!==-1;return!!e.is_directory_restricted&&!n},t.prototype.get=function(e,o){var n=this;u.assert(Array.isArray(e)||i.isString(e),"query has unexpected type");var s=function(i){n._filter_dr_users&&(i=i.filter(function(o){return!t._is_directory_restricted(e,o)})),o(i)};if(this._add_request(e,s))return this.contacts_cache.is_loaded()?this._get():this.contacts_cache.load_contacts(!0,this._get)},t.prototype.registerForUpdates=function(t){return this._updatedCallbacks.push(t)},t})();e.default=d}),define("modules/clean/react/activity/annotation_button",["require","exports","tslib","react","external/react-dom-factories","external/prop-types","external/lodash","modules/clean/annotations/annotation","modules/clean/datetime","modules/clean/image_preview_util","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l,c,u){"use strict";function d(t,e){return void 0!==t&&null!==t?e(t):void 0}Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),s=o.__importStar(s),r=o.__importStar(r),l=o.__importStar(l),c=o.__importDefault(c);var p=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.state={},e._getThumbnail=function(t,o,n){if(e.props.thumbnailUrl)return e._getThumbnailImageFromUrl();var s=28*o/n;return i.div({className:"annotation-thumbnail-page",style:{width:s,height:28}},e._getAnnotationThumbnail(t,o,n,s,28))},e._getAnnotationThumbnail=function(t,o,n,s,l){var c=e.props.annotation;switch(c.type){case a.AnnotationTypes.MARKER:var u=d(null!=t?t[0].coordinates:void 0,function(t){return t[0]});return i.div({className:"annotation-thumbnail-page__marker",style:{left:e._calculateThumbnailDistance(null!=u?u.x:void 0,o,s,6),top:e._calculateThumbnailDistance(null!=u?u.y:void 0,n,l,6)}});case a.AnnotationTypes.HIGHLIGHT:for(var p=[],m=c.getFirstPdfPage(),h=0,_=Array.from(t);h<_.length;h++){var f=_[h];if(f.page===m){var v=f.coordinates[1].x-f.coordinates[0].x;p.push(i.div({className:"annotation-thumbnail-page__highlight",style:{left:e._calculateThumbnailDistance(f.coordinates[0].x,o,s),top:e._calculateThumbnailDistance(f.coordinates[0].y,n,l,3),width:e._calculateThumbnailDistance(v,o,s)}}))}}return p;case a.AnnotationTypes.REGION:p=[],m=c.getFirstPdfPage();for(var g=0,y=Array.from(t);g<y.length;g++){var C=y[g];if(C.page===m){var b=r.map(C.coordinates,"x"),S=r.map(C.coordinates,"y"),w=r.min(b),T=r.max(b),N=r.min(S),A=r.max(S);p.push(i.div({className:"annotation-thumbnail-page__region",style:{left:e._calculateThumbnailDistance(w,o,s),top:e._calculateThumbnailDistance(N,n,l),width:e._calculateThumbnailDistance(T-w,o,s),height:Math.abs(e._calculateThumbnailDistance(A,n,l)-e._calculateThumbnailDistance(N,n,l))}}))}}return p}},e._getThumbnailImageFromUrl=function(){return i.div({className:"annotation-thumbnail-image"},i.img({src:e.props.thumbnailUrl}))},e._getAnnotationText=function(){var t=e.props.annotation.text_highlight.text;return t.length>120&&(t=t.substring(0,117)+"..."),'"'+t+'"'},e._calculateThumbnailDistance=function(t,e,o,n){return void 0===n&&(n=0),o-=n,t/e*o+n/2},e._translateCoordinates=function(t,e,o){for(var n=[],i=0,s=Array.from(t);i<s.length;i++){for(var r=s[i],a=[],l=0,c=Array.from(r.coordinates);l<c.length;l++){var u=c[l],d=e(u.x),p=o(u.y);a.push({x:d,y:p})}n.push({coordinates:a,page:r.page})}return n},e}return o.__extends(e,t),e.prototype.render=function(){var t,e,o,n=this.props.annotation;if(n.isImageAnnotation()){var i=c.default.getPreviewImage();o=i.width(),e=i.height(),t=this._translateCoordinates(n.image_coordinates,function(t){return t*o},function(t){return t*e})}else o=610,e=790,null!=(null!=n.pdf_coordinates?n.pdf_coordinates[0].page_size:void 0)&&(o=n.pdf_coordinates[0].page_size.width,e=n.pdf_coordinates[0].page_size.height),t=this._translateCoordinates(n.pdf_coordinates,function(t){return t},function(t){return e-t});return this._getThumbnail(t,o,e)},e.displayName="AnnotationThumbnail",e.propTypes={annotation:s.object,thumbnailUrl:s.string},e.defaultProps={},e})(n.default.Component);e.AnnotationThumbnailClass=p;var m=n.default.createFactory(p),h=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._getAnnotationText=function(){var t=e.props.annotation.text_highlight.text;return t.length>120&&(t=t.substring(0,117)+"..."),'"'+t+'"'},e._getPageText=function(){return e.props.annotation.isPdfAnnotation()?u._("Page %(page_number)s").format({page_number:e.props.annotation.getFirstPdfPage()}):e.props.annotation.isImageAnnotation()?u._("Annotation"):void 0},e._getLabelSubtext=function(){var t;if(null!=e.props.revision.when&&!isNaN(new Date(null!=e.props.revision.when))&&e.props.isOldRevision){var o=l.ago(new Date(1e3*e.props.revision.when));t=u._("on older revision, updated %(time_ago)s").format({time_ago:o})}else t=u._("on latest revision");var n=e._getPageText();return u._("%(page_text)s %(revision_text)s").format({page_text:n,revision_text:t})},e.onAnnotationButtonMouseUp=function(t){return e.props.onAnnotationButtonMouseUp(t)},e}return o.__extends(e,t),e.prototype.render=function(){return i.a({className:"comment-annotation-button",onMouseUp:this.onAnnotationButtonMouseUp},i.div({className:"annotation-page-label"},m({annotation:this.props.annotation,thumbnailUrl:this.props.thumbnailUrl}),i.div({className:"annotation-thumbnail-label"},i.div({className:"annotation-thumbnail-label__page"},u._("Go to comment")),i.div({className:"annotation-thumbnail-label__info"},this._getLabelSubtext()))),this.props.annotation.type===a.AnnotationTypes.HIGHLIGHT?i.div({className:"annotation-thumbnail-text"},this._getAnnotationText()):void 0)},e.displayName="AnnotationButton",e.propTypes={annotation:s.object,revision:s.object,isOldRevision:s.bool,onAnnotationButtonMouseUp:s.func,thumbnailUrl:s.string},e})(n.default.Component);e.AnnotationButtonClass=h}),define("modules/clean/react/activity/comment_activity_ui",["require","exports","tslib","external/classnames","external/create-react-class","react","external/react-dom","external/react-dom-factories","external/prop-types","external/react-addons-pure-render-mixin","external/lodash","modules/clean/annotations/annotation","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/viewer_avatar","modules/clean/comments/comment_dom","modules/clean/comments/constants","modules/clean/comments/lib/animation","modules/clean/comments/logging","modules/clean/comments/revisions","modules/clean/datetime","modules/clean/event_handler","modules/clean/file_activity/models/file_activity","modules/clean/react/activity/time_counter","modules/clean/react/file_comments/live_sticker","modules/clean/react/file_comments/threaded_comment_header","modules/clean/react/modal","modules/clean/react/title_bubble","modules/clean/sticker_util","modules/clean/viewer","modules/core/exception","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h,_,f,v,g,y,C,b,S,w,T,N,A,x,I,k,E,D){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importDefault(s),r=o.__importStar(r),a=o.__importStar(a),l=o.__importStar(l),c=o.__importStar(c),u=o.__importStar(u),p=o.__importDefault(p),h=o.__importDefault(h),_=o.__importStar(_),g=o.__importStar(g),y=o.__importStar(y),w=o.__importDefault(w),N=o.__importDefault(N);var M=s.default.createFactory(w.default),O=s.default.createFactory(p.default),R=s.default.createFactory(h.default),P=s.default.createFactory(N.default),L=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o.__extends(e,t),e.prototype.render=function(){var t=this.props,e=t.stickerUtil,o=t.stickerId;return e.isLiveSticker(o)?s.default.createElement(T.LiveSticker,{stickerId:o,size:"normal"}):s.default.createElement(I.StickerImage,{className:"comment-sticker-body",stickerId:o})},e})(s.default.PureComponent),U=I.withAsyncStickerUtil(L),H=i.default({displayName:"CommentActivityUI",mixins:[c,b.EventHandlerMixin],propTypes:{parentActivity:l.object.isRequired,fileActivity:l.instanceOf(S.FileActivity).isRequired,comment_activity:l.object.isRequired,user:l.object.isRequired,shouldAnnotationButtonUseThumbnailUrls:l.bool,shouldAutoLinkify:l.bool,shouldUseSimpleModals:l.bool,shouldHidePhotoAvatars:l.bool,isReply:l.bool,shouldShowReplyButton:l.bool,onReplyButtonMouseUp:l.func,isOffline:l.bool,isExpanded:l.bool,truncateLength:l.number,annotationNumber:l.number,scrollIntoView:l.func,isInAnnotationBubble:l.bool,actionCreators:l.object.isRequired},getInitialState:function(){return{showAnnotationThumbnail:!1}},getDefaultProps:function(){return{shouldAutoLinkify:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,shouldShowReplyButton:!1,isOffline:!1,shouldAnnotationButtonUseThumbnailUrls:!1,isExpanded:!1}},componentDidMount:function(){var t=r.findDOMNode(this);return this.events.on(t,v.ANIMATION_END_EVENT,this.onAnimationEnd,this)},onAnimationEnd:function(){return this.setState({highlighting:!1})},onHeaderClick:function(t){var e=this.props.comment_activity;return this.props.shouldAnnotationButtonUseThumbnailUrls?this.setState({showAnnotationThumbnail:!this.state.showAnnotationThumbnail}):this.props.actionCreators.revealAnnotationInPreview(e.activity_key),g.logAnnotationEvent(f.FileActivityLogEventType.CLIENT_ANNOTATION_BUTTON_CLICKED,e.activity_key)},isPendingComment:function(){return this.props.comment_activity.is_pending},isFailedPendingComment:function(){return this.isPendingComment()&&"FAILED"===this.props.comment_activity.status},onUpdateResolve:function(t){return this.props.actionCreators.setCommentResolved({commentActivityKey:this.props.comment_activity.activity_key,resolved:t})},onDeleteComment:function(t){var e=this,o=this.props.shouldUseSimpleModals?"simple":"default";return t.preventDefault(),A.SimpleModal.show({title_text:D._("Delete comment?"),body_html:D._("Are you sure you want to delete this comment?"),cancel_text:D._("Cancel"),confirm_text:D._("Delete"),style:o,confirm_callback:function(){return e.props.actionCreators.deleteComment({commentActivityKey:e.props.comment_activity.activity_key})}})},_isCommentForOldRevision:function(){var t=null!=this.props.comment_activity.comment.comment_metadata?this.props.comment_activity.comment.comment_metadata.revision:void 0;return null!=t&&!y.isRevisionEqual(t,this.props.fileActivity.latest_revision)},onReplyButtonMouseUp:function(){return"function"==typeof this.props.onReplyButtonMouseUp?this.props.onReplyButtonMouseUp():void 0},onRetryPendingComment:function(){return E.assert(this.isPendingComment(),"Cannot retry posting non-pending comment"),this.props.actionCreators.retryPostingComment({targetActivityKey:this.props.parentActivity.activity_key,pendingCommentActivity:this.props.comment_activity})},_renderAnnotationHeader:function(){var t=this.props.comment_activity.comment;if(t.hasMetadata()&&t.comment_metadata.hasAnnotationData()){var e=t.comment_metadata,o=d.Annotation.createAnnotationFromDict(e.annotation);return P({revision:e.revision,annotation:o,isOldRevision:this._isCommentForOldRevision(),onClick:this.onHeaderClick,onUpdateResolve:this.onUpdateResolve,isOffline:this.props.isOffline,shouldShowResolveButton:!1,resolved:t.resolved,annotationNumber:this.props.annotationNumber,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,showAnnotationThumbnail:this.state.showAnnotationThumbnail})}},renderPhoto:function(){var t,e,o={dimension:24,defaultAvatar:s.default.createElement(m.InitialsAvatarWithColorDerivedFromName,{dimension:24,shape:"CIRCLE",initials:this.props.comment_activity.comment.commenter.initials,name:this.props.comment_activity.comment.commenter.display_name})};return this.props.shouldHidePhotoAvatars||""===this.props.comment_activity.comment.commenter.photo_circle_url||(o.photoUrl=this.props.comment_activity.comment.commenter.photo_circle_url),e=this.props.comment_activity.comment.commenter.id,t=Array.from(k.Viewer.get_viewer().get_user_ids(!0)).includes(e)?new R(o):new O(o),a.div({className:"commenter-photo"},t)},renderCommentBody:function(){var t=this.props.comment_activity.comment.raw_comment_text;return _.convertRawCommentTextToReactDom(t,this.props.shouldAutoLinkify,!this.props.isExpanded&&this.props.truncateLength)},renderDelete:function(){var t=this;return a.div({className:"delete-icon",onMouseDown:function(e){return t.onDeleteComment(e)}},D._("Delete"))},renderBody:function(){var t=this,e=k.Viewer.get_viewer(),o=u.intersection(e.get_user_ids(!0),null!=this.props.comment_activity.permissions?this.props.comment_activity.permissions.user_ids_who_can_delete:void 0).length,i=o&&!this.props.isOffline&&!this.isPendingComment(),r=this.props.comment_activity.comment,l=r.hasMetadata()&&r.comment_metadata.hasAnnotationData(),c=n.default({"comment-body":!0,"has-annotation":l});return a.div({className:c},a.div({className:"comment-top-bar"},a.div({className:"commenter-name"},r.commenter.display_name),a.div({className:"comment-when"},s.default.createElement(x.TitleBubble,{content:C.nice_date_with_month_name(new Date(r.when_mses)),position:x.TitleBubble.POSITIONS.TOP},M({when_mses:r.when_mses})))),r.hasMetadata()&&r.comment_metadata.hasStickerData()?s.default.createElement(U,{stickerId:r.comment_metadata.getStickerId()}):a.span({},a.div({className:"comment-text"},this.renderCommentBody())),i?a.div({className:"comment-delete"},this.renderDelete()):void 0,(function(){if(t.isFailedPendingComment())return a.div({className:"comment-bottom-bar"},a.div({className:"pending-comment--failed"},a.span({className:"pending-comment__warning"},D._("Unable to post comment.")),a.a({className:"pending-comment__retry",onClick:t.onRetryPendingComment},D._("Retry"))));if(!t.props.isExpanded&&t.props.shouldShowReplyButton){var e=n.default({"reply-button":!0});return a.div({className:"comment-bottom-bar"},a.a({className:e,onMouseUp:t.onReplyButtonMouseUp},D._("Reply...")))}})())},render:function(){var t=n.default({comment:!0,resolved:this.props.comment_activity.comment.resolved,"comment--old-revision":this._isCommentForOldRevision(),"comment--reply":this.props.isReply,"comment--pending":this.isPendingComment(),"comment--highlighting":this.state.highlighting,expanded:this.props.isExpanded});return a.div({className:"comment-activity","data-comment-activity-key":this.props.comment_activity.activity_key},this._renderAnnotationHeader(),a.div({className:t},this.renderPhoto(),this.renderBody()))}});e.default=H}),define("modules/clean/react/activity/comment_input",["require","exports","tslib","external/classnames","external/create-react-class","react","external/react-dom","external/react-dom-factories","external/prop-types","external/react-addons-pure-render-mixin","jquery","modules/clean/activity/activity_user","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/viewer_avatar","modules/clean/comments/components/stickers","modules/clean/comments/constants","modules/clean/comments/logging","modules/clean/contacts/util","modules/clean/file_activity/models/file_activity","modules/clean/keycode","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/activity/mentions_controller","modules/clean/react/bubble_dropdown","modules/clean/react/button","modules/clean/react/file_comments/logger","modules/clean/react/sprite","modules/clean/react/title_bubble","modules/clean/storage","modules/clean/viewer","modules/constants/comments_panel","modules/core/exception","modules/core/i18n","modules/core/notify"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h,_,f,v,g,y,C,b,S,w,T,N,A,x,I,k,E,D,M,O){"use strict";function R(t,e){return void 0!==t&&null!==t?e(t):void 0}Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importDefault(s),r=o.__importStar(r),a=o.__importStar(a),l=o.__importStar(l),c=o.__importStar(c),u=o.__importDefault(u),p=o.__importDefault(p),h=o.__importDefault(h),v=o.__importStar(v),g=o.__importDefault(g),b=o.__importDefault(b),S=o.__importDefault(S),w=o.__importDefault(w),T=o.__importStar(T),N=o.__importDefault(N),E=o.__importStar(E),D=o.__importStar(D);var P=s.default.createFactory(S.default),L=s.default.createFactory(p.default),U=s.default.createFactory(m.InitialsAvatarWithColorDerivedFromName),H=s.default.createFactory(h.default),B=s.default.createFactory(T.button);e.default=i.default({displayName:"CommentInput",mixins:[c],propTypes:{activity:l.instanceOf(y.FileActivity),usersToNotify:l.arrayOf(l.instanceOf(d.ActivityUser)),metadata:l.object,onAddComment:l.func,onCancelComment:l.func,resizeCallback:l.func,positionDropdownCallback:l.func,onFocus:l.func,onBlur:l.func,user:l.instanceOf(d.ActivityUser).isRequired,onShowNewComment:l.func,enableNoNotifyHint:l.bool,shouldPopupsDropdown:l.bool,initialText:l.string,shouldInitiallyFocusInput:l.bool,shouldAlwaysInEditMode:l.bool,shouldEnableStickers:l.bool,onAddSticker:l.func,contactSearchLogger:l.object,enableImport:l.bool,shouldHidePhotoAvatars:l.bool,isReplyInput:l.bool,shouldUseSimpleModals:l.bool,shouldEnableCancelButton:l.bool,isOffline:l.bool,shouldShowAvatar:l.bool,onContactsSelectorPopupShown:l.func,onContactsSelectorSuggestionsUpdate:l.func,shouldDisableBubbleDropdownHideOnResize:l.bool,shouldDisplayRegionCreationButton:l.bool,onMentionedUsersChanged:l.func,setShouldShowNotifyHint:l.func,isRegionCreationEnabled:l.bool,onChange:l.func,isCommentsServerView:l.bool,actionCreators:l.object,isCommentInputDisabled:l.bool,shouldShowPostText:l.bool,onEditModeChange:l.func},getInitialState:function(){var t,e=!0,o=this.props.shouldAlwaysInEditMode;return t=null!=this.props.initialText?this.props.initialText:this._getCommentLocalStorage(null!=this.props.activity?this.props.activity.activity_key:void 0),t.length>0&&(e=!1,o=!0),E.COMMENTS_COLLAPSE_INPUT||(o=!0),{inputIsEmpty:e,shouldShowPostButton:o,shouldShowPostText:!1,initialText:t,commentMetadata:null}},getDefaultProps:function(){return{onShowNewComment:u.default.noop,shouldAlwaysInEditMode:!1,isCommentInputDisabled:!1,enableImport:!0,shouldHidePhotoAvatars:!1,isReplyInput:!1,shouldEnableCancelButton:!1,shouldShowPostText:!1,isOffline:!1,shouldShowAvatar:!0,metadata:null,shouldDisplayRegionCreationButton:!1,onEditModeChange:u.default.noop}},componentDidMount:function(){var t=this,e=function(t,e){var o=r.findDOMNode(e)||null;return!!o&&(t.target===o||u.default.contains(o,t.target))};if(u.default(r.findDOMNode(this)).on("click.comment-input",function(o){e(o,t.refs.postButton)&&t.verifySubscribersBeforePost()}),null!=this.state.initialText?this.state.initialText.length:void 0)return this.onChange()},componentWillUnmount:function(){return u.default(r.findDOMNode(this)).off(".comment-input")},_emailEnteredCallback:function(t){return null!=this.refs.mentions&&this.refs.mentions.addMentionIntoRangeUnicode(null!=this.refs.mentions?this.refs.mentions.createMentionObject(t):void 0),this.setCursorToEndOfInput(),null!=this.refs.mentionsHintDropdown?this.refs.mentionsHintDropdown.hide():void 0},_contactHighlightedCallback:function(){return null!=this.refs.mentions?this.refs.mentions.contactHighlightedCallback():void 0},_clearContactHighlightedCallback:function(){return null!=this.refs.mentions?this.refs.mentions.clearContactHighlightedCallback():void 0},_contactsSelectorPopupShown:function(){return this.setState({selectorPopupShown:!0}),null!=this.refs.mentions&&this.refs.mentions.contactsSelectorPopupShown(this.refs.mentionsContactSelectorPopup),N.default.log_event(E.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,null!=this.props.activity?this.props.activity.activity_key:void 0,null,E.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id),"function"==typeof this.props.onContactsSelectorPopupShown?this.props.onContactsSelectorPopupShown():void 0},_contactsSelectorPopupHidden:function(){return this.setState({selectorPopupShown:!1}),null!=this.refs.mentions?this.refs.mentions.contactsSelectorPopupHidden():void 0},_onContactsSelectorSuggestionsUpdate:function(){return this._updateInputIsEmptyState(),"function"==typeof this.props.onContactsSelectorSuggestionsUpdate?this.props.onContactsSelectorSuggestionsUpdate():void 0},_onAtSignKeyPress:function(){
if(this.props.user.is_signed_in)return N.default.log_event(E.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,E.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,this.props.user.id)},_onNoAtSignKeyPress:function(){return N.default.log_event(E.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,E.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS,this.props.user.id)},_contactPopupSelectedCallback:function(t){return null!=this.refs.mentions&&this.refs.mentions.addMentionIntoRangeUnicode(null!=this.refs.mentions?this.refs.mentions.createMentionObjectFromSuggestion(t):void 0),null!=this.refs.mentions&&this.refs.mentions.setCursorToEndOfInput(),null!=this.refs.mentionsHintDropdown&&this.refs.mentionsHintDropdown.hide(),D.assert(this.props.user.is_signed_in,"Contact selected from popup when user is logged out"),N.default.log_event(E.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,E.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id)},_contactSelectedCallback:function(t){var e;return D.assert(this.props.user.is_signed_in,"Contact selected when user is logged out"),e=t?E.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS:E.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,N.default.log_event(E.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,e,this.props.user.id)},onMention:function(){return this.onChange(),"function"==typeof this.props.onMention?this.props.onMention():void 0},onChange:function(){var t=this.refs.mentions.extractMentions(),e=t.map(function(t){return d.ActivityUser.fromUser({id:t.dbx_account_id||t.identifier,display_name:t.name})});return this.props.shouldShowPostText&&(this.getRawCommentInput().length>0?this.setState({shouldShowPostText:!0}):this.setState({shouldShowPostText:!1})),"function"==typeof this.props.onMentionedUsersChanged&&this.props.onMentionedUsersChanged(e),"function"==typeof this.props.onChange?this.props.onChange(this.getRawCommentInput()):void 0},onMentionsFocus:function(t){return this.togglePostButton(!0),"function"==typeof this.props.onFocus?this.props.onFocus(t):void 0},onMentionsBlur:function(t){if("function"==typeof this.props.onBlur&&this.props.onBlur(),this.refs.mentions.getEncodedMessage()){if(this.shouldSaveText())return this._storeCommentLocalStorage(this.refs.mentions.getRawMessage(),this.props.activity.activity_key)}else if(!this.props.shouldAlwaysInEditMode)return},onMentionsCancel:function(t){return"function"==typeof this.props.onCancelComment?this.props.onCancelComment():void 0},onKeyDown:function(t){return t.keyCode===C.KeyCode.ENTER&&(t.ctrlKey||t.metaKey)?(this.verifySubscribersBeforePost(),t.preventDefault()):this._updateInputIsEmptyState()},onKeyUp:function(t){return this._updateInputIsEmptyState(),this.onChange()},onPaste:function(t){var e=this;return t.clipboardData.getData("text/plain").length>4e3?(O.Notify.error(M._("The text you're trying to paste is too long.")),t.preventDefault()):setTimeout(function(){return e._updateInputIsEmptyState(),e.onChange()},10)},showNoNotifyHint:function(){return this.refreshDropdownDirection(),null!=this.refs.mentionsHintDropdown&&this.refs.mentionsHintDropdown.show(),null!=this.refs.mentionsContactSelectorPopup?this.refs.mentionsContactSelectorPopup.showNoNotifyHint():void 0},refreshDropdownDirection:function(){return"function"==typeof this.props.positionDropdownCallback?this.props.positionDropdownCallback():void 0},togglePostButton:function(t){var e=this,o=function(){return"function"==typeof e.props.resizeCallback&&e.props.resizeCallback(t),"function"==typeof e.props.setShouldShowNotifyHint?e.props.setShouldShowNotifyHint(t):void 0};return this.setState({shouldShowPostButton:t},o)},shouldSaveText:function(){return!this.props.user.is_signed_in||!this.props.user.is_email_verified},setCursorToEndOfInput:function(){return this.refs.mentions.setCursorToEndOfInput()},_onSkipAddMention:function(t){return null!=this.refs.mentionsHintDropdown&&this.refs.mentionsHintDropdown.hide(),this.postComment()},_updateInputIsEmptyState:function(){var t=""===this.refs.mentions.getEncodedMessage();if(this.state.inputIsEmpty!==t)return this.setState({inputIsEmpty:t})},verifySubscribersBeforePost:function(t){var e,o=this;if(this.props.user.is_signed_in&&null!=this.props.usersToNotify){var n=(function(){for(var t=[],n=0,i=Array.from(o.props.usersToNotify);n<i.length;n++)e=i[n],e.id!==o.props.user.id&&t.push(e);return t})();if(n&&0===n.length&&0===R(null!=this.props.activity?this.props.activity.comment_activities:void 0,function(t){return t.length})&&this.props.enableNoNotifyHint)return void this.showNoNotifyHint()}return this.postComment()},_clearText:function(){return this.refs.mentions.disableMentions(),this.refs.mentions.clearTextField(),this._updateInputIsEmptyState()},postComment:function(){var t=this.refs.mentions.getEncodedMessage();if(t)return t.length>4e3?void O.Notify.error(M._("The comment is too long.")):(this.shouldSaveText()||(this._clearText(),this.setState({shouldShowPostText:!1})),"function"==typeof this.props.onAddComment?this.props.onAddComment(t):void 0)},focusInput:function(){return null!=this.refs.mentions?this.refs.mentions.focusInput():void 0},getRawCommentInput:function(){return null!=this.refs.mentions?this.refs.mentions.getRawMessage():void 0},getPlaceholderText:function(){return this.props.isReplyInput?M._("Reply"):M._("Write a comment")},_usersToNotifyToContacts:function(t){for(var e=[],o=0,n=Array.from(t);o<n.length;o++){var i=n[o];i.id!==this.props.user.id&&e.push(g.default.activityUserToContact(i,Number.MAX_VALUE))}return e},_onCancelMouseUp:function(){return"function"==typeof this.props.onCancelComment?this.props.onCancelComment():void 0},_onRegionCreationClick:function(){var t,e=!this.props.isRegionCreationEnabled;return t=e?f.FileActivityLogEventType.CLIENT_ANNOTATION_MODE_ENABLED:f.FileActivityLogEventType.CLIENT_ANNOTATION_MODE_DISABLED,v.logEvent(t,f.FileActivityLogClientOriginType.ANNOTATION_MODE_BUTTON_IN_COMMENTS_PANE),null!=this.props.actionCreators?this.props.actionCreators.setRegionCreationEnabled(e):void 0},_postSticker:function(t){return"function"==typeof this.props.onAddSticker&&this.props.onAddSticker(t),null!=this.refs.stickerDropdown?this.refs.stickerDropdown.hide():void 0},_clearCommentLocalStorage:function(t){return I.LocalStorage.set("tmp-file-comment",null)},_getCommentLocalStorage:function(t){var e=I.LocalStorage.get("tmp-file-comment"),o="";return e&&e.activity_key===t&&((new Date).getTime()-e.time<3e5&&(o=e.text),this._clearCommentLocalStorage()),u.default("<div/>").html(o).text()},_storeCommentLocalStorage:function(t,e){var o=u.default("<div/>").text(t).html();return I.LocalStorage.set("tmp-file-comment",{activity_key:e,text:o,time:(new Date).getTime()})},_renderCommentBox:function(){var t=null!=this.props.usersToNotify?this.props.usersToNotify:[],e=this.props.user.is_signed_in&&this.state.shouldShowPostButton,o=this.props.shouldEnableStickers&&this.state.shouldShowPostButton,i=P({ref:"mentions",placeholder_text:this.getPlaceholderText(),initialText:this.state.initialText,contactSearchLogger:this.props.contactSearchLogger,user:this.props.user,shouldPopupsDropdown:this.props.shouldPopupsDropdown,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,shouldAlwaysInEditMode:this.props.shouldAlwaysInEditMode,showPlaceholderText:this.state.inputIsEmpty,showMentionsHelper:e,enableNoAtMentions:E.ALLOW_NO_AT_MENTIONS&&this.props.user.is_signed_in,onFocus:this.onMentionsFocus,onBlur:this.onMentionsBlur,onCancel:this.onMentionsCancel,position_contacts_callback:this.props.positionDropdownCallback,resizeCallback:this.props.resizeCallback,onKeyUp:this.onKeyUp,onKeyDown:this.onKeyDown,onPaste:this.onPaste,onMention:this.onMention,onEditModeChange:this.props.onEditModeChange,contactsSelectorPopupShown:this._contactsSelectorPopupShown,onContactsSelectorSuggestionsUpdate:this._onContactsSelectorSuggestionsUpdate,onAtSignKeyPress:this._onAtSignKeyPress,onNoAtSignKeyPress:this._onNoAtSignKeyPress,contactSelectedCallback:this._contactSelectedCallback,enableImport:this.props.enableImport,extraContacts:this._usersToNotifyToContacts(t),shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),s=n.default({"comment-box":!0,"input-collapsed":!this.state.shouldShowPostButton}),r=n.default({"post-area":!0,"post-area--post-text-shown":this.state.shouldShowPostText});return a.div({className:s},this._renderCommenterPhoto(),i,a.div({className:r,ref:"postArea"},this.state.shouldShowPostText?this._renderPostTextContainer():void 0,a.div({className:"comment-input-buttons"},this.props.shouldDisplayRegionCreationButton?this._renderRegionCreationButton():void 0,o?this._renderStickerButton():void 0,e?this._renderMentionsHelper():void 0),this.state.shouldShowPostButton?this._renderButtonsContainer():void 0))},_renderRegionCreationButton:function(){var t,e;this.props.isRegionCreationEnabled?(e=M._("Done commenting"),t="ic_comment_area_blue"):(e=M._("Comment on specific areas"),t="ic_comment_area_dark");var o=n.default({"region-creation-button":!0,"comment-input-button":!0,"sprite-button":!0,"region-creation-enabled":this.props.isRegionCreationEnabled});return a.div({className:o,onClick:this._onRegionCreationClick},s.default.createElement(x.TitleBubble,{content:e,position:x.TitleBubble.POSITIONS.BOTTOM_ALIGN_RIGHT},s.default.createElement("button",{className:"'region-creation-image sprite-button","aria-label":e},s.default.createElement(A.Sprite,{group:"web",name:t,alt:e}))))},_getArrowPosition:function(){return(this.props.shouldPopupsDropdown?"top":"bottom")+"-"+(this.props.isCommentsServerView?"left":"right")},_onStickerDropdownShown:function(){this.setState({stickerPopupShown:!0})},_onStickerDropdownHidden:function(){this.setState({stickerPopupShown:!1})},_renderStickerButton:function(){var t="ic_sticker";this.state.stickerPopupShown&&(t="ic_sticker_blue");var e=a.button({className:"comment-sticker-add sprite-button"},s.default.createElement(A.Sprite,{group:"web",name:t,alt:M._("Add sticker")})),o=this.props.isCommentsServerView?-38:1,n=this.props.shouldPopupsDropdown?4:-11;return a.div({className:"sticker-button comment-input-button sprite-button",onMouseDown:this.refreshDropdownDirection},s.default.createElement(x.TitleBubble,{content:M._("Add sticker"),position:x.TitleBubble.POSITIONS.BOTTOM_ALIGN_RIGHT},s.default.createElement(w.default,{targetButton:e,ref:"stickerDropdown",arrow_position:this._getArrowPosition(),vertical_displacement:n,extra_css_class:"stickers-bubble-dropdown",horizontal_displacement:o,anchor_bottom:!this.props.shouldPopupsDropdown,bubbleDropdownShown:this._onStickerDropdownShown,bubbleDropdownHidden:this._onStickerDropdownHidden,bubbleDropdownScrollable:!0,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize},s.default.createElement(_.Stickers,{isPopupAbove:this.props.shouldPopupsDropdown,onStickerSelected:this._postSticker}))))},_renderMentionsHelper:function(){var t=null!=this.props.usersToNotify?this.props.usersToNotify:[],e="s_add_mention";this.state.selectorPopupShown&&(e="s_add_mention_blue");var o=a.button({className:"comment-mention-hint-add sprite-button","aria-label":M._("@mention someone")},s.default.createElement(A.Sprite,{group:"web",name:e,alt:M._("@mention someone")})),n=this.props.shouldPopupsDropdown?0:-16;return a.div({className:"comment-mention-hint comment-input-button"},s.default.createElement(x.TitleBubble,{position:x.TitleBubble.POSITIONS.BOTTOM_ALIGN_RIGHT,content:M._("@mention someone")},a.div({className:"comment-mention-hint-button",onMouseDown:this.refreshDropdownDirection},s.default.createElement(w.default,{targetButton:o,autofocus:!0,ref:"mentionsHintDropdown",arrow_position:this._getArrowPosition(),vertical_displacement:n,horizontal_displacement:this.props.isCommentsServerView?1:3,anchor_bottom:!this.props.shouldPopupsDropdown,extra_css_class:"mentions-helper-bubble-dropdown",bubbleDropdownHidden:this._contactsSelectorPopupHidden,bubbleDropdownShown:this._contactsSelectorPopupShown,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize},s.default.createElement(b.default,{key:"mentionsContactSelectorPopup",ref:"mentionsContactSelectorPopup",shouldShowNoNotifyHint:!1,user:this.props.user,contactSearchLogger:this.props.contactSearchLogger,emailEnteredCallback:this._emailEnteredCallback,contactSelectedCallback:this._contactPopupSelectedCallback,contactHighlightedCallback:this._contactHighlightedCallback,clearContactHighlightedCallback:this._clearContactHighlightedCallback,should_dropdown:this.props.shouldPopupsDropdown,onSkipAddMention:this._onSkipAddMention,enableImport:this.props.enableImport,extraContacts:this._usersToNotifyToContacts(t),shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars})))))},_renderCommenterPhoto:function(){var t,e,o={dimension:24,defaultAvatar:new U({dimension:24,shape:"CIRCLE",initials:this.props.user.initials||"?",name:this.props.user.getDisplayIdentity()})};return this.props.shouldHidePhotoAvatars||(o.photoUrl=this.props.user.photo_circle_url),t=null!=this.props.user?this.props.user.id:void 0,e=Array.from(k.Viewer.get_viewer().get_user_ids(!0)).includes(t)?H(o):L(o),a.div({className:"commenter-photo"},this.props.shouldShowAvatar?e:void 0)},_renderCancelButton:function(){return a.a({className:"cancel-button",onMouseUp:this._onCancelMouseUp},M._("Cancel"))},_renderButtonsContainer:function(){var t=this.state.inputIsEmpty||this.props.isOffline,e={className:"post-button",disabled:t,ref:"postButton"},o=B(e,M._("Post"));return a.div({className:"button-container"},o,this.props.shouldEnableCancelButton?this._renderCancelButton():void 0)},_onCancelTextMouseUp:function(){return this._clearText(),this.setState({shouldShowPostText:!1})},_renderPostTextContainer:function(){return a.div({className:"post-text-container"},a.button({className:"post-button button-as-link",ref:"postButton"},M._("Post")),a.span({}," • "),a.button({className:"button-as-link",onMouseUp:this._onCancelTextMouseUp},M._("Cancel")))},render:function(){var t=n.default({"comment-field":!0,"comment-field--reply":this.props.isReplyInput,"comment-field--disabled":this.props.isOffline});return a.div({className:t},this._renderCommentBox(),this.props.isCommentInputDisabled||this.props.isOffline?a.div({className:"comment-field__diabled"},""):void 0)}})}),define("modules/clean/react/activity/contacts_selector",["require","exports","tslib","external/classnames","external/create-react-class","react","external/react-dom","external/react-dom-factories","external/prop-types","jquery","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/contacts/bloodhound_contacts","modules/clean/contacts/list","modules/clean/contacts/types","modules/clean/keycode","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/sprite","modules/core/i18n","modules/core/user_i18n"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h,_,f,v,g,y,C){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importDefault(s),r=o.__importStar(r),a=o.__importStar(a),l=o.__importStar(l),c=o.__importDefault(c),u=o.__importDefault(u),p=o.__importDefault(p),m=o.__importDefault(m),h=o.__importDefault(h),f=o.__importDefault(f),C=o.__importStar(C);var b;b=i.default({displayName:"ContactsSelector",propTypes:{showNullHint:l.bool,contactSelectedCallback:l.func,contactHighlightedCallback:l.func,contactSearchLogger:l.object,noAtMentionTriggerCallback:l.func,resultsLimit:l.number,matchFullQUery:l.bool,noMatchesText:l.string,user:l.object,showContactsInNullState:l.bool,x_offset:l.number,y_offset:l.number,enableImport:l.bool,show_contacts:l.bool,should_dropdown:l.bool,last_keydown:l.number,extraContacts:l.arrayOf(l.object),shouldHidePhotoAvatars:l.bool},getInitialState:function(){return this.contactSelectedCallback=this.props.contactSelectedCallback,null!=this.props.user&&this.props.user.is_signed_in&&this.props.enableImport&&(this.profile_services=v.LinkedProfileServices.get_linked_profile_services_for_user(this.props.user.id)),{suggestions:[],matches_count:0,focused_row:null,query:"",show_no_results:!1,hover_import_contact:!1,show_import_list:!1}},getDefaultProps:function(){return{contactSelectedCallback:void 0,should_dropdown:!0,show_contacts:!1,enableImport:!0,x_offset:0,y_offset:0,last_keydown:-1,showNullHint:!0,showContactsInNullState:!1,noMatchesText:y._("No matches. Keep typing an email address."),matchFullQUery:!1,extraContacts:[],shouldHidePhotoAvatars:!1}},componentWillMount:function(){if(this.contacts=new p.default(null,null,10,!0),this.contacts.setExtraContacts(this.props.extraContacts),0===this.state.query.length&&this.props.showContactsInNullState)return this.get_suggestions("")},componentDidMount:function(){if(this.$typeahead_container=c.default(r.findDOMNode(this.refs.suggestionsContainer)),this.$typeahead_suggestions=c.default(r.findDOMNode(this.refs.suggestionsList)),this._position_contacts_list(),this._toggle_contacts_list(),!this.state.show_contacts)return this._reset_import_state()},componentWillReceiveProps:function(t){if(this.contacts.setExtraContacts(t.extraContacts),0===this.state.query.length&&t.showContactsInNullState!==this.props.showContactsInNullState)return this.get_suggestions("")},componentDidUpdate:function(t,e){return this.$typeahead_container=c.default(r.findDOMNode(this.refs.suggestionsContainer)),this.$typeahead_suggestions=c.default(r.findDOMNode(this.refs.suggestionsList)),this._position_contacts_list(),this._toggle_contacts_list(),"function"==typeof this.props.contactHighlightedCallback?this.props.contactHighlightedCallback(this._get_suggestion_row(this.state.focused_row)):void 0},_reset_import_state:function(){return this.setState({hover_import_contact:!1,show_import_list:!1})},_append_import_to_suggestions:function(t){for(var e=0,o=Array.from(f.default.importable_contact_services());e<o.length;e++){var n=o[e];t.push(this._append_provider(n))}return t},_append_provider:function(t){var e=f.default.to_name(t);return this.profile_services.service_is_connected(t)&&(e+=y._(" (Connected)")),{type:99,provider:t,name:e,photo_url:f.default.to_img(t)[0]}},_import_contacts_mouseover:function(t){return this.setState({hover_import_contact:!0})},_import_contacts_mouseleave:function(t){return this.setState({hover_import_contact:!1})},_mouse_down_import_contacts:function(t){return t.preventDefault(),this.setState({hover_import_contact:!this.state.hover_import_contact,show_import_list:!this.state.show_import_list})},_focus_suggestion_row:function(t){if(null!=t&&this.state.focused_row!==t||null===t)return this.setState({focused_row:t})},_focus_suggestion_row_mouseover:function(t){var e=c.default(t.currentTarget),o=e.index();if(o>-1)return this._focus_suggestion_row(o)},_get_suggestion_row:function(t){return this.$typeahead_suggestions.find(".suggestion-row.focused")},_get_suggestions_callback:function(t,e,o){var n;if(this.isMounted()){var i=void 0;e=(function(){for(var t=[],o=0,i=Array.from(e);o<i.length;o++)n=i[o],n.type!==h.default.NEW_STYLE_GROUP&&t.push(n);return t})(),e=(function(){for(var t=[],o=0,i=Array.from(e);o<i.length;o++)n=i[o],n.domain_contact||t.push(n);return t})(),e=m.default.sortContactsByTeamFirst(e),o||(e=t.length>=5?this._getApproximateNameMatches(t,e):this._getExactFirstOrLastNameMatches(t,e)),this.matchesCountFromBloodhoundContacts=e.length,e=e.slice(0,this.props.resultsLimit);var s=e.length,r=0===s&&this.props.last_keydown!==_.KeyCode.SPACE&&t.indexOf(" ")<0||0===s&&this.props.matchFullQUery;return o||"function"==typeof this.props.noAtMentionTriggerCallback&&this.props.noAtMentionTriggerCallback(s),this.props.enableImport&&0===s?e=this._append_import_to_suggestions(e):s>0&&this._reset_import_state(),this.props.should_dropdown?i=0:(i=e.length-1,e.reverse()),this.setState({suggestions:e,focused_row:i,show_no_results:r,matches_count:s})}},_has_suggestion_row_at_index:function(t){return null!=t&&t>=0&&t<this.get_suggestions_count()},_mouse_down_select_suggestion:function(t){return t.preventDefault(),this.select_suggestion(t.currentTarget)},_position_contacts_list:function(){var t=this.$typeahead_container.parent(),e=this.$typeahead_container.width();return e+this.props.x_offset>t.width()?this.$typeahead_container.css("left",t.width()-e):this.$typeahead_container.css("left",this.props.x_offset),this.props.should_dropdown?this.$typeahead_container.css("top",this.props.y_offset):this.$typeahead_container.css("top",this.props.y_offset-this.$typeahead_container.height()-12)},_toggle_contacts_list:function(){return this.props.show_contacts&&(this._matches_count()>0||0===this.state.query.length||this.state.show_no_results&&this.state.query.length)?this.$typeahead_container.show():this.$typeahead_container.hide()},_matches_count:function(){return this.state.matches_count},_getExactFirstOrLastNameMatches:function(t,e){return Array.from(e).filter(function(e){return Array.from(e.name_tokens).includes(t)})},_getApproximateNameMatches:function(t,e){for(var o=[],n=0,i=Array.from(e);n<i.length;n++)for(var s=i[n],r=0,a=Array.from(s.name_tokens);r<a.length;r++){var l=a[r];if(0===l.indexOf(t)){o.push(s);break}}return o},get_suggestions:function(t,e){var o=this;if(void 0===e&&(e=!0),null!=this.props.user&&this.props.user.is_signed_in)return this.contacts.get(t,function(n){return o._get_suggestions_callback(t,n,e)}),this.setState({query:t})},get_suggestions_count:function(){return this.props.show_contacts?this.$typeahead_suggestions.children().size():0},navigate_suggestions:function(t){if(t.keyCode||t.which||t.charCode,t.keyCode===_.KeyCode.ENTER||t.keyCode===_.KeyCode.TAB){if(t.preventDefault(),this._has_suggestion_row_at_index(this.state.focused_row)){var e=this._get_suggestion_row(this.state.focused_row);return this.select_suggestion(e)}}else if([_.KeyCode.UP,_.KeyCode.DOWN].includes(t.keyCode)){var o=this.get_suggestions_count();if(o>0){var n=void 0;if(t.keyCode===_.KeyCode.UP){if(n=null!=this.state.focused_row?this.state.focused_row:o,0!==this.state.focused_row)return this._focus_suggestion_row((n-1)%o)}else if(t.keyCode===_.KeyCode.DOWN&&(n=null!=this.state.focused_row?this.state.focused_row:-1,this.state.focused_row!==o-1))return this._focus_suggestion_row((n+1)%o)}}},select_suggestion:function(t){var e=c.default(t);if(99!==e.data("type")){if(null!=this.props.contactSearchLogger){var o={sort_variant:null,context:"mentions",search_expr:this.state.query,selected_pos:this.state.focused_row,num_query_results:this.matchesCountFromBloodhoundContacts,contact_type:e.data("type"),contact_id:e.data("identifier"),contact_name:e.data("name"),did_select_suggestion:!0};this.props.contactSearchLogger.add_record(o)}if(null!=this.contactSelectedCallback&&this.contactSelectedCallback(e),this.isMounted())return this.setState({focused_row:null,suggestions:[]})}else if(null!=this.props.user&&this.props.user.is_signed_in){var n=new v.ProfileServicesLinkingHandler;n.auth_service_with_user(String(e.data("provider")),this.props.user.id,function(t){return v.ProfileServicesLinkingHandler.show_import_notifications(t)},"contact-importer-modal")}},render:function(){var t,e,i=this;return t=n.default({"contacts-list-suggestions":!0,"animating-down":this.props.show_contacts&&!this.props.should_dropdown,"animating-up":this.props.show_contacts&&this.props.should_dropdown}),a.div({className:t,ref:"suggestionsContainer"},(function(){if(i.props.show_contacts&&i.props.user){if(!i.props.user.is_signed_in)return a.div({className:"suggestion-row empty-state-row"},y._("Login to @mention your contacts"));if(0===i.state.query.length&&i.props.showNullHint&&!i.props.showContactsInNullState)return a.div({className:"suggestion-row empty-state-row"},y._("Mention someone by name or email"));if(i.state.query.length||0===i.state.query.length&&i.props.showContactsInNullState){var r=a.div({ref:"suggestionsList"},Array.from(i.state.suggestions).map(function(r){return(function(r){var l,c,p,m;t={"import-row":99===r.type,"suggestion-row":!0,focused:null!=i.state.focused_row&&i.state.suggestions.indexOf(r)===i.state.focused_row},e=n.default(t),r.type===h.default.EMAIL?(p=r.email,c=r.email):r.type===h.default.FB?(p="fb_"+r.fb_id,c="Facebook Contact"):r.type===h.default.NEW_STYLE_GROUP?(p=r.group_id,c="Group"):99===r.type?(p="Import-"+r.name,l=a.img({src:r.photo_url})):r.type===h.default.DBX_ID&&(p=r.dbx_account_id,c=y._("Dropbox User"));var _=!1;if(null!=r.name&&r.name.length>0?m=r.name:null!=r.email&&(_=!0,m=r.email,c=null),99!==r.type&&(null!=r.photo_url||null!=m)){var f=void 0;f=_?"@":C.getInitials(m);var v={dimension:32,defaultAvatar:s.default.createElement(d.InitialsAvatarWithColorDerivedFromName,{dimension:32,shape:"CIRCLE",initials:f,name:m})};i.props.shouldHidePhotoAvatars||(v.photoUrl=r.photo_url),l=s.default.createElement(u.default,o.__assign({},v))}return a.div({key:p,className:e,"data-identifier":p,"data-name":m,"data-type":r.type,"data-photo-url":r.photo_url,"data-dbx-account-id":r.dbx_account_id||null,"data-provider":r.provider||null,onMouseDown:function(t){return i._mouse_down_select_suggestion(t)},onMouseEnter:function(t){return i._focus_suggestion_row_mouseover(t)}},a.div({className:"suggestion-wrapper"},l?a.div({className:"suggestion-avatar"},l):void 0,a.div({className:"suggestion-info"},null!=m?a.div({className:"suggestion-name"},m):void 0,null!=c?a.div({className:"suggestion-identifier"},c):void 0)))})(r)}));if(i.state.show_no_results)return a.div({},a.div({className:"suggestion-row empty-state-row"},a.div({className:"empty-state-row-text"},i.state.hover_import_contact||i.state.show_import_list?y._("Import Contacts"):i.props.noMatchesText),(function(){if(i.props.enableImport){var t={"import-contacts":!0,active:null!=i.state.show_import_list};return a.a({className:n.default(t),onMouseDown:function(t){return i._mouse_down_import_contacts(t)},onMouseEnter:function(t){return i._import_contacts_mouseover(t)},onMouseLeave:function(t){return i._import_contacts_mouseleave(t)}},s.default.createElement(g.Sprite,{group:"web",name:"user_add",alt:y._("Import Contacts")}))}})()),i.state.show_import_list?a.div({className:n.default({"suggestion-row-top-divider":!0,"animating-down":i.props.should_dropdown,"animating-up":!i.props.should_dropdown})},r):void 0);if(i._matches_count()>0)return r}}})())}}),e.default=b}),define("modules/clean/react/activity/contacts_selector_popup",["require","exports","tslib","react","external/react-dom","external/react-dom-factories","external/prop-types","jquery","modules/clean/contacts/types","modules/clean/keycode","modules/clean/react/activity/contacts_selector","modules/clean/validators/validators","modules/core/browser_detection","modules/core/exception","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),s=o.__importStar(s),r=o.__importStar(r),a=o.__importDefault(a),l=o.__importDefault(l),u=o.__importDefault(u),p=o.__importStar(p),m=o.__importStar(m);var _=[c.KeyCode.UP,c.KeyCode.DOWN,c.KeyCode.ESC,c.KeyCode.ENTER,c.KeyCode.TAB],f=d.validators.check(d.validators.create(["EmailValidator"])),v=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.state={query:"",show_contacts:!0,last_keydown:-1,shouldShowNoNotifyHint:!1},e.showNoNotifyHint=function(){return e.setState({shouldShowNoNotifyHint:!0}),"function"==typeof e.props.clearContactHighlightedCallback?e.props.clearContactHighlightedCallback():void 0},e.contactHighlightedCallback=function(t){return m.assert(!e.state.shouldShowNoNotifyHint,"Should not have highlight callback in no notify state"),"function"==typeof e.props.contactHighlightedCallback?e.props.contactHighlightedCallback(t):void 0},e.contactSelectedCallback=function(t){return e._resetInput(),"function"==typeof e.props.contactSelectedCallback?e.props.contactSelectedCallback(t):void 0},e._resetInput=function(){return e.setState({query:""}),a.default(i.findDOMNode(e.refs.contactSelectorPopupInput)).val(""),e.refs.contactSelectorPopup.get_suggestions("")},e._logEmailEntered=function(t){if(null!=e.props.contactSearchLogger){var o={sort_variant:null,context:"mentions",contact_type:l.default.EMAIL,contact_id:t,did_select_suggestion:!1};return e.props.contactSearchLogger.add_record(o)}},e._onInputKeyDown=function(t){var o=t.keyCode||t.which||t.charCode;if(null!=p.msie&&o===c.KeyCode.ENTER){var n=t.target.value;if(e.refs.contactSelectorPopup.get_suggestions_count()>0)return e.refs.contactSelectorPopup.navigate_suggestions(t);if(f(n))return"function"==typeof e.props.emailEnteredCallback&&e.props.emailEnteredCallback(n),e._logEmailEntered(n)}},e._onInputKeyUp=function(t){var o=t.keyCode||t.which||t.charCode,n=t.target.value;if(null!=e.refs.contactSelectorPopup){if(!Array.from(_).includes(o))return e.setState({query:n}),e.refs.contactSelectorPopup.get_suggestions(n);if(e.refs.contactSelectorPopup.get_suggestions_count()>0)return e.refs.contactSelectorPopup.navigate_suggestions(t);if(o===c.KeyCode.ENTER&&f(n))return"function"==typeof e.props.emailEnteredCallback&&e.props.emailEnteredCallback(n),e._logEmailEntered(n)}},e._onAddPeopleMouseUp=function(t){return e.setState({shouldShowNoNotifyHint:!1},function(){return a.default(i.findDOMNode(e.refs.contactSelectorPopupInput)).focus()}),"function"==typeof e.props.onAddPeopleMouseUp?e.props.onAddPeopleMouseUp(t):void 0},e._onSkipAddMention=function(t){return"function"==typeof e.props.onSkipAddMention?e.props.onSkipAddMention(t):void 0},e}return o.__extends(e,t),e.prototype.render=function(){var t=this;return s.div({className:"contacts-selector-popup"},(function(){if(t.state.shouldShowNoNotifyHint)return s.div({className:"contacts-selector-hint"},h._("Your comment won’t notify anyone."),s.div({}),s.a({onMouseUp:t._onAddPeopleMouseUp,onKeyPress:t._onAddPeopleMouseUp,tabIndex:0},h._("Add people")),s.span({className:"bottom-dot"}," · "),s.a({className:"just-for-me",onMouseUp:t._onSkipAddMention,onKeyPress:t._onSkipAddMention,tabIndex:0},h._("Just for me")));var e=s.div({className:"contacts-selector-popup-input-wrapper"},s.input({ref:"contactSelectorPopupInput",onKeyDown:t._onInputKeyDown,onKeyUp:t._onInputKeyUp,placeholder:h._("Type an email or name")})),o=t.state.query.trim().length>0||t.props.showContactsInNullState?s.hr({className:"separator"}):s.span({}),i=n.default.createElement(u.default,{ref:"contactSelectorPopup",contactSelectedCallback:t.contactSelectedCallback,contactHighlightedCallback:t.contactHighlightedCallback,contactSearchLogger:t.props.contactSearchLogger,show_contacts:t.state.show_contacts,should_dropdown:t.props.should_dropdown,y_offset:0,x_offset:0,user:t.props.user,last_keydown:t.state.last_keydown,showNullHint:!1,showContactsInNullState:t.props.showContactsInNullState,matchFullQUery:!0,resultsLimit:5,enableImport:t.props.enableImport,extraContacts:t.props.extraContacts,shouldHidePhotoAvatars:t.props.shouldHidePhotoAvatars,isDemoMode:t.props.isDemoMode});return t.props.should_dropdown?[e,o,i]:[i,o,e]})())},e.displayName="ContactsSelectorPopup",e.propTypes={showContactsInNullState:r.bool,shouldShowNoNotifyHint:r.bool,should_dropdown:r.bool,user:r.object,contactHighlightedCallback:r.func,contactSelectedCallback:r.func,contactSearchLogger:r.object,emailEnteredCallback:r.func,clearContactHighlightedCallback:r.func,onAddPeopleMouseUp:r.func,onSkipAddMention:r.func,enableImport:r.bool,extraContacts:r.arrayOf(r.object),shouldHidePhotoAvatars:r.bool,isDemoMode:r.bool},e.defaultProps={showContactsInNullState:!0,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1,isDemoMode:!1},e})(n.default.Component);e.default=v}),
define("modules/clean/react/activity/mentions_controller",["require","exports","tslib","external/classnames","external/create-react-class","external/purify","react","external/react-dom","external/react-dom-factories","external/prop-types","jquery","modules/clean/activity/activity_user","modules/clean/contacts/types","modules/clean/keycode","modules/clean/react/activity/contacts_selector","modules/clean/validators/validators","modules/core/browser_detection","modules/core/exception"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h,_,f,v){"use strict";function g(t,e){return void 0!==t&&null!==t?e(t):void 0}Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importStar(s),r=o.__importDefault(r),a=o.__importStar(a),l=o.__importStar(l),c=o.__importStar(c),u=o.__importDefault(u),p=o.__importDefault(p),h=o.__importDefault(h),f=o.__importStar(f),v=o.__importStar(v);var y=r.default.createFactory(h.default),C=new RegExp("\ufeff","g"),b=[m.KeyCode.UP,m.KeyCode.DOWN,m.KeyCode.ESC,m.KeyCode.ENTER,m.KeyCode.TAB],S=_.validators.check(_.validators.create(["EmailValidator"])),w=i.default({displayName:"MentionsController",propTypes:{shouldPopupsDropdown:c.bool,enableNoAtMentions:c.bool,initialText:c.string,user:c.object,position_contacts_callback:c.func,showMentionsHelper:c.bool,contactSearchLogger:c.object,contactsSelectorPopupShown:c.func,contactSelectedCallback:c.func,onKeyDown:c.func,onKeyUp:c.func,onAtSignKeyPress:c.func,onNoAtSignKeyPress:c.func,onBlur:c.func,onFocus:c.func,onPaste:c.func,onCancel:c.func,onMention:c.func,placeholder_text:c.string,resultsLimit:c.number,resizeCallback:c.func,shouldInitiallyFocusInput:c.bool,shouldAlwaysInEditMode:c.bool,enableImport:c.bool,extraContacts:c.arrayOf(c.object),shouldHidePhotoAvatars:c.bool,onContactsSelectorSuggestionsUpdate:c.func,showPlaceholderText:c.bool,shouldDisableHighlight:c.bool,onEditModeChange:c.func},getInitialState:function(){var t=this.props.shouldAlwaysInEditMode;return this.isInNoAtMentionMode=!1,this.currentCursorWordStartPosition=0,this.currentCursorWordEndPosition=0,this.props.initialText&&this.props.initialText.length>0&&(t=!0),{default_state:!0,x_offset:0,y_offset:0,in_edit_mode:t,mention_triggered:!1,search_end_position:-1,search_start_position:-1,show_contacts:!1,last_keydown:-1}},getDefaultProps:function(){return{shouldPopupsDropdown:!0,initialText:"",user:new d.ActivityUser,resultsLimit:5,enableNoAtMentions:!1,shouldAlwaysInEditMode:!1,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1,shouldEnableStickers:!1,shouldDisableHighlight:!1}},componentDidMount:function(){var t=this;if(this._componentSetup(),this.state.default_state&&this.props.initialText.length>0&&(null!=f.mozilla?setTimeout(function(){return t._initializeInputWithText(t.props.initialText)},0):this._initializeInputWithText(this.props.initialText)),this.props.shouldInitiallyFocusInput)return setTimeout(function(){return t.focusInput()},0)},componentDidUpdate:function(t,e){this._componentSetup();var o=this._getCaretPosition();if(e.show_contacts!==this.state.show_contacts&&((null!=o?o.left:void 0)!==this.state.x_offset||(null!=o?o.top:void 0)!==this.state.y_offset)){var n={x_offset:o.left,y_offset:o.top};return this.setState(n)}},_resetInputToPlaceholderState:function(){return this._dangerouslySetInputHtml(""),this.setState({in_edit_mode:!1,search_end_position:-1,search_start_position:-1}),"function"==typeof this.props.onEditModeChange?this.props.onEditModeChange(!1):void 0},_initializeInputWithText:function(t){var e=this;t=s.sanitize(t,{FORBID_ATTR:["src","href"]}),this._clearInputWithoutBlurring(),this.$text_input.focus();var o=this.$text_input.get(0),n=document.createRange();if(o){n.setStart(o,0);if(t=t.replace(/@\[(\s*(?:dbid:)?[^:\[\]]+):([^\[]+)\]/g,function(t,o,n){return o=o.trim(),n=n.trim(),e._mentionWrapper(o,n)}),this.unsafeInsertHtmlAtRange(t,n,!0),!this.state.in_edit_mode)return this.setState({in_edit_mode:!0}),"function"==typeof this.props.onEditModeChange?this.props.onEditModeChange(!0):void 0}},_componentSetup:function(){return this.contacts_selector=this.refs.contactSelector,this.$mentions_input=u.default(a.findDOMNode(this.refs.input)),this.$text_input=u.default(a.findDOMNode(this.refs.textInput))},_logEmailEntered:function(t){if(null!=this.props.contactSearchLogger){var e={sort_variant:null,context:"mentions",contact_type:p.default.EMAIL,contact_id:t,did_select_suggestion:!1};return this.props.contactSearchLogger.add_record(e)}},_parseInputTextAndReplace:function(){var t=this,e=0,o=new RegExp(/@[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/gi);if(this._parseInputTextWithRegex(o,function(o,n){var i=o[0],s=o.index,r=i.substring(1);if(S(r)&&null==f.msie){var a=document.createRange();a.setStart(n,s),a.setEnd(n,s+i.length);var l=t.createMentionObject(r,r);return t._addMentionIntoInput(l,a),e++,t._logEmailEntered(r)}}),e>0)return this.setCursorToEndOfInput()},_parseInputTextWithRegex:function(t,e){var o=this,n=this.$text_input.html().replace(C,"");if(null!=n&&""!==n)return(function(){for(var n=[],i=function(o){if(null!=f.msie&&u.default(o).is("p")||o.nodeType===Node.TEXT_NODE&&""!==o.nodeValue.trim()){var i=null!=f.msie?u.default(o).text():o.nodeValue;n.push((function(){for(var n,s=[];null!==(n=t.exec(i));)s.push(e(n,o));return s})())}else n.push(void 0)},s=0,r=Array.from(o.$text_input[0].childNodes);s<r.length;s++){i(r[s])}return n})()},refreshDropdownDirection:function(){return"function"==typeof this.props.position_contacts_callback?this.props.position_contacts_callback():void 0},_getEndRangeUnicodeIndex:function(){return this.$text_input.html().indexOf("‍")},_getStartRangeUnicodeIndex:function(){return this.$text_input.html().indexOf("‌")},_endRangeUnicodeExists:function(){return this._getEndRangeUnicodeIndex()>=0},_startRangeUnicodeExists:function(){return this._getStartRangeUnicodeIndex()>=0},_startAndEndRangeUnicodeExistsAndValid:function(){var t=this._getStartRangeUnicodeIndex(),e=this._getEndRangeUnicodeIndex();return t>=0&&e>0&&e>t},_clearStartToEndRangeUnicode:function(){return this._dangerouslyReplaceStartToEndRangeUnicode(""),this._clearRangeUnicode()},_dangerouslyInsertValueBeforeStartUnicode:function(t){if(this._getStartRangeUnicodeIndex()>=0){var e=this._getStartRangeUnicodeIndex(),o=this.$text_input.html(),n=o.substr(0,e),i=o.substr(e);t=s.sanitize(t);var r=""+n+t+i;return this._dangerouslySetInputHtml(r)}},_dangerouslyReplaceStartToEndRangeUnicode:function(t){if(this._startAndEndRangeUnicodeExistsAndValid()){var e=this._getStartRangeUnicodeIndex(),o=this._getEndRangeUnicodeIndex(),n=this.$text_input.html(),i=n.substr(0,e),r=n.substr(o);return t=s.sanitize(t),this._dangerouslySetInputHtml(i+"‌"+t+"‍"+r)}},_clearRangeUnicode:function(){var t=this.$text_input.html();return t=t.replace(/\u200c/g,""),t=t.replace(/\u200d/g,""),this.$text_input.html(t)},_dangerouslyInsertLiveTextWithRangeUnicode:function(t){null==f.msie&&this._cleanUpDelimiters(),(this._getStartRangeUnicodeIndex()<0||this._getEndRangeUnicodeIndex()<0)&&(this._clearRangeUnicode(),this._dangerouslySetInputHtml(this.$text_input.html()+"‌‍"));var e=this._isSpaceBeforeStartUnicode()?"":" ";return t=s.sanitize(t),this._dangerouslyReplaceStartToEndRangeUnicode(""+e+t)},_getRangeBetweenStartEndRangeUnicode:function(){var t=this.$text_input.html().replace(C,"");if(null!=t&&""!==t)for(var e=0,o=Array.from(this.$text_input[0].childNodes);e<o.length;e++){var n=o[e],i=null!=f.msie?u.default(n).text():n.nodeValue;if(null!=i&&i.length>0){var s=i.indexOf("‌"),r=i.indexOf("‍");if(s>=0&&r>0&&r>s){var a=document.createRange();return a.setStart(n,s),a.setEnd(n,r),a}}}},_isSpaceBeforeStartUnicode:function(){var t=this._getStartRangeUnicodeIndex();return t>=0&&this._isSpaceBeforeIndex(t)},_isSpaceBeforeIndex:function(t){var e=this.$text_input.html();return t>0&&" "===e.substr(t-1,1)||t>=6&&"&nbsp;"===e.substr(t-6,6)},_dangerouslySetInputHtml:function(t){return this.$text_input.html(t)},contactsSelectorPopupHidden:function(){if(this.props.showMentionsHelper&&(this._clearStartToEndRangeUnicode(),0===this.$text_input.html().trim().length&&this.state.in_edit_mode&&this._getCaretPosition().top<=0&&this._resetInputToPlaceholderState()),null!=a.findDOMNode(this.refs.textInput))return this.setCursorToEndOfInput()},contactsSelectorPopupShown:function(t){if(this.isMounted()&&this.props.showMentionsHelper){this.state.in_edit_mode||this._clearDefaultState();var e=g(null!=t?t.refs:void 0,function(t){return t.contactSelectorPopupInput});return g(a.findDOMNode(e),function(t){return t.focus()})}},clearContactHighlightedCallback:function(){return this._clearStartToEndRangeUnicode()},contactHighlightedCallback:function(t){var e=(null!=t?t.data("name"):void 0)||"";return null!=t&&t.data("identifier"),this._dangerouslyInsertLiveTextWithRangeUnicode("@"+e),"function"==typeof this.props.onContactsSelectorSuggestionsUpdate?this.props.onContactsSelectorSuggestionsUpdate():void 0},_contactSelectedCallback:function(t){return this._addMentionIntoInput(this.createMentionObjectFromSuggestion(t)),"function"==typeof this.props.contactSelectedCallback?this.props.contactSelectedCallback(this.isInNoAtMentionMode):void 0},addMentionIntoRangeUnicode:function(t){this._isSpaceBeforeStartUnicode()||this._dangerouslyInsertValueBeforeStartUnicode(" ");var e=this._getRangeBetweenStartEndRangeUnicode();if(e)return this._addMentionIntoInput(t,e),this._clearRangeUnicode()},_noAtMentionTriggerCallback:function(t){if(this.props.enableNoAtMentions){if(!this.state.show_contacts&&t>0)return this.refreshDropdownDirection(),this.setState({show_contacts:!0}),this.isInNoAtMentionMode=!0,"function"==typeof this.props.onNoAtSignKeyPress?this.props.onNoAtSignKeyPress():void 0;if(this.isInNoAtMentionMode&&0===t)return this.setState({show_contacts:!1}),this.isInNoAtMentionMode=!1}},setCursorToEndOfInput:function(){var t=this;return setTimeout(function(){t.focusInput();var e=t.$text_input[0].lastChild;if(null!=e){var o=document.createRange();return o.selectNode(e),o=o.cloneRange(),o.setStartAfter(e),o.collapse(!1),t._selection().removeAllRanges(),t._selection().addRange(o)}},10)},_getCaretPosition:function(){var t=g(a.findDOMNode(this.refs.container),function(t){return t.getClientRects()[0]}),e={left:this.state.x_offset,top:this.state.y_offset};if(this._selection().rangeCount>0){var o=this._selection().getRangeAt(0).getClientRects()[0];null!=o&&null!=t&&(e.left=o.left-t.left,this.props.shouldPopupsDropdown?e.top=o.bottom-t.top:e.top=o.top-t.top)}return e},unsafeInsertHtmlAtRange:function(t,e,o){var n,i;e.deleteContents();for(var s=u.default("<span />").html(t)[0],r=document.createDocumentFragment();n=s.firstChild;)i=r.appendChild(n);return e.insertNode(r),i&&o&&(e=e.cloneRange(),e.setStartAfter(i),e.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(e)),i},_checkEndOfLine:function(){v.assert(null!=f.mozilla,"_checkEndOfLine called from non mozilla browser");var t=Array.from(this._extractCursorInfo()),e=t[0],o=t[1];if(u.default(e).hasClass("text-input")&&u.default(this.$text_input.contents()[o]).is("br")&&o>0){var n=this.$text_input.contents()[o-1];if(n.nodeType===Node.TEXT_NODE&&"\ufeff"===n.nodeValue)return this._setCursorLocation(n,0)}},_selection:function(){return window.getSelection()},_setCursorLocation:function(t,e){if(null!=t){var o=document.createRange();if(t.nodeType===Node.TEXT_NODE)o.setStart(t,e);else{if(!u.default(t).hasClass("new-mention"))return;0===e?o.setStartBefore(t):o.setStartAfter(t)}return o.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(o)}},_updateCurrentWordBoundary:function(){var t=Array.from(this._extractCursorInfo()),e=t[1],o=t[2],n=o.slice(0,e).lastIndexOf(" ")+1,i=o.slice(0,e).lastIndexOf(" ")+1;i>n&&(n=i);var s=o.slice(e).indexOf(" ");return s=s===-1?o.length:e+s,this.currentCursorWordStartPosition=n,this.currentCursorWordEndPosition=s},_cleanMentionHighlighting:function(t){void 0===t&&(t=null);var e=this.$text_input.children();return null!=t&&(e=[t]),Array.from(e).map(function(t){return u.default(t).removeClass("selected")})},_cleanUpNbsp:function(){var t=this.$text_input.html();return t=t.replace(/\u00a0/g," "),t=t.replace(/\s{2,}/g," "),this.$text_input.html(t)},_cleanUpDelimiters:function(){v.assert(null==f.msie,"_cleanUpDelimiters() called from MSIE");for(var t=Array.from(this._extractCursorInfo()),e=t[0],o=t[1],n=0,i=Array.from(this.$text_input.contents());n<i.length;n++){var r=i[n];if(r.nodeType===Node.TEXT_NODE)r.nodeValue=r.nodeValue.replace(C,""),r===e?o=Math.min(o,r.nodeValue.length):""===r.nodeValue&&r.parentNode.removeChild(r);else if(u.default(r).hasClass("new-mention")){var a=document.createTextNode(s.sanitize("\ufeff"));r.parentNode.insertBefore(a,r);var l=document.createTextNode(s.sanitize("\ufeff"));r.parentNode.insertBefore(l,r.nextSibling)}}if(null==f.mozilla)for(;null!=e&&e.previousSibling&&""===e.nodeValue;){var c=e.previousSibling;e.parentNode.removeChild(e),c.nodeType===Node.TEXT_NODE&&(o=c.nodeValue.length),e=c}this._setCursorLocation(e,o)},_checkAndMergeAdjacentNodes:function(){v.assert(null!=f.msie,"_checkAndMergeAdjacentNodes called from non IE browser");var t=Array.from(this._extractCursorInfo()),e=t[0],o=t[1];if((u.default(e).hasClass("text-input")||u.default(e).is("p"))&&[m.KeyCode.BACKSPACE,m.KeyCode.DELETE].includes(event.keyCode)){var n=u.default(e).contents()[o];if((null!=n?n.nodeType:void 0)===Node.TEXT_NODE){var i=n.nodeValue,s=0,r=n.previousSibling,a=n.nextSibling;return null!=r&&r.nodeType===Node.TEXT_NODE&&(s=r.nodeValue.length,i=r.nodeValue+i,r.parentNode.removeChild(r)),null!=a&&a.nodeType===Node.TEXT_NODE&&(i+=a.nodeValue,a.parentNode.removeChild(a)),n.nodeValue=i,this._setCursorLocation(n,s)}}},_isCursorAfterSpaceOrBeginningOfLine:function(t,e){if(e-1>=0){var o=t.slice(e-1,e);if([" ",""," "].includes(o))return!0}else if(0===e)return!0;return!1},_extractCursorInfo:function(){var t=this._selection().focusNode,e=this._selection().focusOffset,o="";return null!=t&&t.nodeType===Node.TEXT_NODE&&(o=t.nodeValue.length?t.nodeValue:""),[t,e,o]},_clearDefaultState:function(){if(this.state.default_state&&this._clearInputWithoutBlurring(),!this.state.in_edit_mode)return this.setState({in_edit_mode:!0}),"function"==typeof this.props.onEditModeChange?this.props.onEditModeChange(!0):void 0},_clearInputWithoutBlurring:function(){return null!=f.msie?this.$text_input[0].innerText="":this.$text_input[0].textContent=""},clearTextField:function(){return this._clearInputWithoutBlurring(),this.setState({in_edit_mode:this.props.shouldAlwaysInEditMode}),"function"==typeof this.props.onEditModeChange&&this.props.onEditModeChange(this.props.shouldAlwaysInEditMode),this.$text_input.blur()},_onInputKeydownMozilla:function(t){v.assert(null!=f.mozilla,"_onInputKeydownMozilla called from non mozilla browser"),this._cleanUpDelimiters(),this._checkEndOfLine();var e=Array.from(this._extractCursorInfo()),o=e[0],n=e[1],i=e[2];if(null!=o&&o.nodeType===Node.TEXT_NODE){var s=o.previousSibling,r=o.nextSibling;if([m.KeyCode.DELETE,m.KeyCode.RIGHT].includes(t.keyCode)){if("\ufeff"===i&&null!=r&&this._toggleMentionSelectState(r,t))return this._setCursorLocation(o,1);if(i.length!==n||null==r||r.nodeType!==Node.TEXT_NODE||"\ufeff"!==r.nodeValue)return this._cleanMentionHighlighting();if(null!=r.nextSibling&&this._toggleMentionSelectState(r.nextSibling,t))return this._setCursorLocation(r,1)}else if([m.KeyCode.BACKSPACE,m.KeyCode.LEFT].includes(t.keyCode)&&0===n&&null!=s){if("\ufeff"===i&&this._toggleMentionSelectState(s,t))return this._setCursorLocation(o,0);if(s.nodeType===Node.TEXT_NODE&&"\ufeff"===s.nodeValue&&null!=s.previousSibling&&this._toggleMentionSelectState(s.previousSibling,t))return this._setCursorLocation(s,0)}}},_onInputKeydownMsie:function(t){v.assert(null!=f.msie,"_onInputKeydownMsie called from non MSIE browser");var e=Array.from(this._extractCursorInfo()),o=e[0],n=e[1],i=e[2];if(null!=o){if(u.default(o).hasClass("text-input")||u.default(o).is("p")){var s=u.default(o).contents();return[m.KeyCode.BACKSPACE,m.KeyCode.LEFT].includes(t.keyCode)&&n>0&&u.default(s[n-1]).hasClass("new-mention")?this._toggleMentionSelectState(s[n-1],t):[m.KeyCode.DELETE,m.KeyCode.RIGHT].includes(t.keyCode)&&u.default(s[n]).hasClass("new-mention")?this._toggleMentionSelectState(s[n],t):this._cleanMentionHighlighting()}var r=o.previousSibling,a=o.nextSibling;if([m.KeyCode.BACKSPACE,m.KeyCode.LEFT].includes(t.keyCode)){if(0===n&&null!=r&&u.default(r).hasClass("new-mention"))return this._toggleMentionSelectState(r,t)}else{if(![m.KeyCode.DELETE,m.KeyCode.RIGHT].includes(t.keyCode))return this._cleanMentionHighlighting();if(n===i.length&&null!=a&&u.default(a).hasClass("new-mention"))return this._toggleMentionSelectState(a,t)}}},_onInputKeydownWebkit:function(t){v.assert(null!=f.webkit,"_onInputKeydownWebkit called from non webkit browser"),this._cleanUpDelimiters();var e=Array.from(this._extractCursorInfo()),o=e[0],n=e[1],i=e[2];if(null!=o&&o.nodeType===Node.TEXT_NODE){var s=o.previousSibling,r=o.nextSibling;if([m.KeyCode.BACKSPACE,m.KeyCode.LEFT].includes(t.keyCode)){if(null!=s&&"\ufeff"===i)switch(t.keyCode){case m.KeyCode.BACKSPACE:this._setCursorLocation(o,n-1);break;case m.KeyCode.LEFT:if(this._isMention(s)&&!this._hasMentionSelectState(s)){var a=document.createRange();a.selectNode(s),this._selection().removeAllRanges(),this._selection().addRange(a),t.stopPropagation(),t.preventDefault()}else this._cleanMentionHighlighting(),this._setCursorLocation(s.previousSibling,1)}}else if([m.KeyCode.DELETE,m.KeyCode.RIGHT].includes(t.keyCode)){if(n===i.length&&null!=r&&r.nodeType===Node.TEXT_NODE&&"\ufeff"===r.nodeValue){var l=r.nextSibling;if(null!=l)switch(t.keyCode){case m.KeyCode.BACKSPACE:this._setCursorLocation(r,1);break;case m.KeyCode.RIGHT:if(this._isMention(l)&&!this._hasMentionSelectState(l)){var a=document.createRange();a.selectNode(l),this._selection().removeAllRanges(),this._selection().addRange(a),t.stopPropagation(),t.preventDefault()}else this._cleanMentionHighlighting(),this._setCursorLocation(l,1)}}else if("\ufeff"===i&&0===n&&null!=r)switch(this._toggleMentionSelectState(r,t),t.keyCode){case m.KeyCode.DELETE:this._setCursorLocation(o,1);break;case m.KeyCode.RIGHT:this._setCursorLocation(r,1)}}else this._cleanMentionHighlighting()}},_onInputKeydown:function(t){var e=this._normalizeKeycode(t);if(this.setState({default_state:!1,last_keydown:e}),e!==m.KeyCode.PROCESSING){(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)&&[m.KeyCode.BACKSPACE,m.KeyCode.DELETE,m.KeyCode.LEFT,m.KeyCode.RIGHT].includes(e)?null!=f.webkit?this._onInputKeydownWebkit(t):null!=f.mozilla?this._onInputKeydownMozilla(t):null!=f.msie&&this._onInputKeydownMsie(t):this._cleanMentionHighlighting(),"function"==typeof this.props.onKeyDown&&this.props.onKeyDown(t);var o=Array.from(this._extractCursorInfo()),n=o[0],i=o[1],s=o[2];if(this.state.show_contacts){if(Array.from(b).includes(e)){if(t.preventDefault(),e===m.KeyCode.ESC||0===this.contacts_selector.get_suggestions_count()&&e===m.KeyCode.ENTER)return this.setState({show_contacts:!1})}else if(e===m.KeyCode.BACKSPACE&&(null!=n?n.nodeType:void 0)===Node.TEXT_NODE&&i>0){var r=s.substr(i-1,1);if("@"===r&&this._isCursorAfterSpaceOrBeginningOfLine(s,i-1))return this.setState({show_contacts:!1})}}else if(e===m.KeyCode.ESC)return"function"==typeof this.props.onCancel?this.props.onCancel():void 0}},_onInputKeypress:function(t){var e=Array.from(this._extractCursorInfo()),o=e[0],n=e[1],i=e[2];if(this._normalizeKeycode(t)===m.KeyCode.AT_SIGN&&!this.state.mention_triggered){var s=void 0;"function"==typeof this.props.position_contacts_callback&&this.props.position_contacts_callback();var r=!1;if(o.nodeType===Node.TEXT_NODE?this._isCursorAfterSpaceOrBeginningOfLine(i,n)&&(r=!0,s=n):(u.default(o).hasClass("text-input")||null!=f.msie&&u.default(o).is("p"))&&(r=!0,s=0),r){var a={search_start_position:s,search_end_position:s,mention_triggered:!0};return this.setState(a),"function"==typeof this.props.onAtSignKeyPress?this.props.onAtSignKeyPress():void 0}}},_onInputKeyup:function(t){var e,o=this;if(this.state.last_keydown===m.KeyCode.PROCESSING)return void v.assert(null!=f.webkit,"PROCESSING keycode detected in non-webkit browser");null!=f.msie&&this._checkAndMergeAdjacentNodes();var n=Array.from(this._extractCursorInfo()),i=n[0],s=n[1],r=n[2];this.props.enableNoAtMentions&&this._updateCurrentWordBoundary();var a={};if(this.state.mention_triggered&&(a.mention_triggered=!1,a.show_contacts=!0,s-this.state.search_start_position>1)){var l=r.slice(this.state.search_start_position+1,s).indexOf("@");a.show_contacts=l===-1}if(!this.state.show_contacts&&!a.show_contacts||this.isInNoAtMentionMode)this.props.enableNoAtMentions&&(Array.from(b).includes(t.keyCode)&&this.state.show_contacts&&this.contacts_selector.get_suggestions_count()>0?this.contacts_selector.navigate_suggestions(t):t.keyCode!==m.KeyCode.ESC&&this.contacts_selector.get_suggestions(r.slice(this.currentCursorWordStartPosition,this.currentCursorWordEndPosition).trim(),!1));else if(Array.from(b).includes(t.keyCode)&&this.contacts_selector.get_suggestions_count()>0)this.contacts_selector.navigate_suggestions(t);else if(s<=this.state.search_start_position||i.nodeType!==Node.TEXT_NODE)a.show_contacts=!1;else if(t.keyCode===m.KeyCode.SPACE){var c=this._parseMentionQuery(r,this.state.search_end_position).trim();if(0!==c.length){if(S(c)){var u=this.createMentionObject(c);return this._addMentionIntoInput(u),void this._logEmailEntered(c)}this.contacts_selector.get_suggestions(c,!0)}else this.setState({show_contacts:!1})}else this.contacts_selector.get_suggestions(this._parseMentionQuery(r,s).trim(),!0);return t.keyCode!==m.KeyCode.ENTER&&t.keyCode!==m.KeyCode.TAB&&(t.keyCode!==m.KeyCode.SPACE||this.state.show_contacts||a.show_contacts)||this._parseInputTextAndReplace(),null==f.msie&&(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)&&this._cleanUpDelimiters(),"function"==typeof this.props.onKeyUp&&this.props.onKeyUp(t),e=this._normalizeKeycode(t),Array.from(b).includes(e)&&this.state.show_contacts?void 0:this.setState(a,function(){return"function"==typeof o.props.resizeCallback?o.props.resizeCallback():void 0})},_normalizeKeycode:function(t){return t.keyCode||t.which||t.charCode},_onInputBlur:function(t){this._parseInputTextAndReplace(),"function"==typeof this.props.onBlur&&this.props.onBlur();var e={show_contacts:!1,default_state:!1};return!this.state.in_edit_mode||this.getEncodedMessage().length||this.props.shouldAlwaysInEditMode||(e.in_edit_mode=!1,e.search_end_position=-1,e.search_start_position=-1,"function"==typeof this.props.onEditModeChange&&this.props.onEditModeChange(!1)),this.setState(e)},_onInputFocus:function(t){var e=this;if(t.target===this.$text_input.get(0)){"function"==typeof this.props.onFocus&&this.props.onFocus();var o={show_contacts:!1};return this.state.in_edit_mode||(o.in_edit_mode=!0,o.search_end_position=-1,o.search_start_position=-1,"function"==typeof this.props.onEditModeChange&&this.props.onEditModeChange(!0)),setTimeout(function(){if(e.isMounted())return e.setState(o)},0)}},_onInputMouseDown:function(t){return this.setState({default_state:!1}),this._cleanMentionHighlighting()},_onInputPaste:function(t){return this.setState({default_state:!1}),"function"==typeof this.props.onPaste?this.props.onPaste(t):void 0},createMentionObjectFromSuggestion:function(t){var e=t.data("name"),o=t.data("identifier"),n=t.data("dbx-account-id");return this.createMentionObject(o,e,n)},createMentionObject:function(t,e,o){return void 0===e&&(e=null),void 0===o&&(o=null),e||(e=t),o&&(t=o),{name:e,identifier:t,dbx_account_id:o}},_isMention:function(t){return u.default(t).hasClass("new-mention")},_hasMentionSelectState:function(t){return u.default(t).hasClass("selected")},_toggleMentionSelectState:function(t,e){if(u.default(t).hasClass("new-mention")){if(u.default(t).hasClass("selected"))return this._cleanMentionHighlighting(t),!0;e.stopPropagation(),e.preventDefault(),u.default(t).addClass("selected")}return!1},_onMentionMouseDown:function(t){if(t.preventDefault(),t.stopPropagation(),0===t.button){this._cleanMentionHighlighting(),this._toggleMentionSelectState(t.target,t);var e=document.createRange();return e.selectNode(t.target),this._selection().removeAllRanges(),this._selection().addRange(e)}if(null!=f.mozilla&&2===t.button)return this._setCursorLocation(t.target,1)},_mentionWrapper:function(t,e,o){return null!=f.webkit?"<span class='new-mention' data-id=\""+t+'" data-name="'+e+'" data-dbx-account-id="'+o+'">'+e+"</span>":'<input type="button" class=\'new-mention\' data-id="'+t+'" data-name="'+e+'" data-dbx-account-id="'+o+'" value="'+e+'"></input>'},_parseMentionQuery:function(t,e){e>this.state.search_end_position?this.setState({search_end_position:e}):e=this.state.search_end_position;var o="";return e<=t.length?o=t.slice(this.state.search_start_position,e):this.state.search_start_position<=t.length&&(this.setState({search_end_position:t.length}),o=t.slice(this.state.search_start_position)),o.replace("@","")},_addMentionIntoInput:function(t,e){var o=this;a.findDOMNode(this.refs.textInput);var n=this._mentionWrapper(t.identifier,t.name,t.dbx_account_id),i=u.default(s.sanitize(n))[0];if(null!=f.webkit?i.setAttribute("contenteditable","false"):null!=f.mozilla&&i.setAttribute("style","margin-left:-3px; margin-right:-3px"),u.default(i).mousedown(function(t){return o._onMentionMouseDown(t)}),null==e){var r=Array.from(this._extractCursorInfo())[0];e=document.createRange();var l=this.state.search_start_position,c=this.state.search_end_position;this.state.show_contacts||(this.setState({search_start_position:r.length}),this.setState({search_end_position:r.length}),l=r.length,c=r.length),this.isInNoAtMentionMode&&(l=this.currentCursorWordStartPosition,c=this.currentCursorWordEndPosition),e.setStart(r,l),e.setEnd(r,c)}i=this.unsafeInsertHtmlAtRange(i,e,!0);var d=i.nextSibling;if(null!=d&&d.nodeType===Node.TEXT_NODE)d.nodeValue=" "+d.nodeValue,this._setCursorLocation(d,1);else{var p=document.createTextNode(s.sanitize(" "));u.default(p).insertAfter(i),this._setCursorLocation(p,1)}return"function"==typeof this.props.onMention&&this.props.onMention(t),this.setState({show_contacts:!1})},focusInput:function(){return this.setState({in_edit_mode:!0}),a.findDOMNode(this.refs.textInput).focus(),"function"==typeof this.props.onEditModeChange?this.props.onEditModeChange(!0):void 0},disableMentions:function(){if(this.state.show_contacts)return this.setState({show_contacts:!1})},mentionsEnabled:function(){return this.state.show_contacts},_encodedMention:function(t){return"@[%(identifier)s:%(name)s]".format({identifier:t.identifier,name:t.name})},extractMentions:function(){for(var t=this.$text_input.find(".new-mention"),e=[],o=0,n=Array.from(t);o<n.length;o++){var i=n[o],s=u.default(i).data("id"),r=u.default(i).data("name"),a=u.default(i).data("dbx-account-id");e.push(this.createMentionObject(s,r,a))}return e},_encodeHtml:function(t){var e="",o=!1;if(t=t.replace(C,""),null!=t&&""!==t)for(var n=0,i=Array.from(u.default.parseHTML(t));n<i.length;n++){var s=i[n],r=void 0;if(s.nodeType===Node.TEXT_NODE&&""!==s.nodeValue)o=!0,e+=s.nodeValue;else if(s instanceof HTMLParagraphElement)o=!0,e=e+this._encodeHtml(u.default(s).html())+"\n";else if(u.default(s).hasClass("new-mention")){o=!0;var a=u.default(s).data(),l=this.createMentionObject(a.id,a.name);e+=this._encodedMention(l)}else u.default(s).is("br")?e+="\n":u.default(s).is("div")?(r=u.default(s).text(),o=o||r.length>0,e=e+"\n"+r):(r=u.default(s).text(),o=o||r.length>0,e+=r)}return e!==this.props.placeholder_text&&o?e=e.replace(/\s+$/,""):""},getRawMessage:function(){return this.$text_input.html()},getEncodedMessage:function(){var t=this.$text_input.html();return this._encodeHtml(t)},render:function(){var t={"text-input":!0,"edit-mode":this.state.in_edit_mode},e=n.default(t),o=!0;null!=f.webkit&&(o="plaintext-only");var i={ref:"textInput","aria-label":this.props.placeholder_text,"aria-multiline":!0,className:e,contentEditable:o,defaultValue:this.props.initialText,onKeyPress:this._onInputKeypress,onKeyDown:this._onInputKeydown,onKeyUp:this._onInputKeyup,onFocus:this._onInputFocus,onBlur:this._onInputBlur,onPaste:this._onInputPaste,onMouseDown:this._onInputMouseDown,role:"textbox"},s=l.div({className:"mention-text-input-wrapper"},l.div({className:"placeholder-text","aria-hidden":!0},this.props.showPlaceholderText?this.props.placeholder_text:void 0),l.div(i)),r=y({ref:"contactSelector",contactSelectedCallback:this._contactSelectedCallback,noAtMentionTriggerCallback:this._noAtMentionTriggerCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.shouldPopupsDropdown,y_offset:this.state.y_offset,x_offset:this.state.x_offset,user:this.props.user,last_keydown:this.state.last_keydown,resultsLimit:this.props.resultsLimit,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),a=n.default({"mentions-container":!0}),c=n.default({"mentions-input":!0,"animating-highlight":this.props.shouldInitiallyFocusInput&&!this.props.shouldAlwaysInEditMode&&!this.props.shouldDisableHighlight});return l.div({className:a,ref:"container"},l.div({className:c,ref:"input"},s),r)}});e.default=w}),define("modules/clean/react/activity/resolve_button",["require","exports","tslib","external/classnames","react","external/react-dom-factories","external/prop-types","modules/clean/components/title_bubble","modules/clean/react/sprite_div","modules/core/i18n","modules/core/notify"],function(t,e,o,n,i,s,r,a,l,c,u){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importStar(s),r=o.__importStar(r),a=o.__importDefault(a),l=o.__importDefault(l);var d=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._updateResolved=function(t){if(t.stopPropagation(),e.props.isOffline){var o=void 0;return o=e.props.resolved?c._("Cannot unresolve comments while offline"):c._("Cannot resolve comments while offline"),u.Notify.error(o)}return e.props.onUpdateResolve(!e.props.resolved)},e}return o.__extends(e,t),e.prototype.render=function(){var t=this.props.resolved?c._("Unresolve"):c._("Resolve"),e=n.default({"resolve-conversation-checkmark":!0,resolved:this.props.resolved});return i.default.createElement(a.default,{className:e,text:t,direction:"south"},s.button({className:"resolve-button","aria-pressed":this.props.resolved,onClick:this._updateResolved},s.div({className:"resolved-icon"},this.props.resolved?i.default.createElement(l.default,{group:"web",name:"s_greychecked",alt:c._("Unresolve"),text:c._("Resolved"),spritePosition:"right"}):i.default.createElement(l.default,{group:"web",name:"s_greycheck",alt:c._("Resolve"),text:c._("Resolve"),spritePosition:"right"}))))},e.displayName="ResolveButton",e.propTypes={resolved:r.bool.isRequired,onUpdateResolve:r.func.isRequired,isOffline:r.bool},e.defaultProps={isOffline:!1},e})(i.default.Component);e.default=d}),define("modules/clean/react/activity/time_counter",["require","exports","tslib","react","external/react-dom-factories","modules/clean/datetime"],function(t,e,o,n,i,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),s=o.__importStar(s);var r=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.updateLoop=function(){},e.getUpdateInterval=function(){return 5e3},e}return o.__extends(e,t),e.prototype.render=function(){var t=s.ago(new Date(this.props.when_mses));return i.div({className:"activity-time-ago"},t)},e.prototype.componentDidMount=function(){
return this.updateLoop()},e.displayName="TimeCounter",e})(n.default.Component);e.default=r}),define("modules/clean/react/activity/users_to_notify",["require","exports","tslib","react","external/react-dom-factories","external/prop-types","modules/clean/react/tooltip","modules/clean/react_format","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),s=o.__importStar(s),r=o.__importStar(r);var c=n.default.createFactory(r.Tooltip),u=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o.__extends(e,t),e.prototype.render=function(){var t,e,o=this;t=null==this.props.usersToNotify?[]:this.props.user.is_signed_in?(function(){for(var t=[],n=0,i=Array.from(o.props.usersToNotify);n<i.length;n++)e=i[n],e.id!==o.props.user.id&&t.push(e);return t})():(function(){for(var t=[],n=0,i=Array.from(o.props.usersToNotify);n<i.length;n++)e=i[n],e.id!==o.props.user.id&&t.push(e);return t})();var n=t.length;if(n>0){var s=void 0,u=i.div({className:"notification-names-container"},(function(){for(var o=[],n=0,s=Array.from(t);n<s.length;n++)e=s[n],o.push((function(t){return i.div({key:t.id},t.getDisplayIdentity())})(e));return o})()),d=i.span({className:"blue"});s=1===n?a.reactFormat(l._("<blueSpan>%(name)s</blueSpan> will be notified."),{name:t[0].getDisplayIdentity(),blueSpan:d}):2===n?a.reactFormat(l._("<blueSpan>%(name)s and %(name2)s</blueSpan> will be notified."),{name:t[0].getDisplayIdentity(),name2:t[1].getDisplayIdentity(),blueSpan:d}):a.reactFormat(l._("<blueSpan>%(name)s and %(num)s others</blueSpan> will be notified."),{name:t[0].getDisplayIdentity(),num:n-1,blueSpan:d});var p=i.div({className:"comment-box-text"},s);return n>2?c({position:r.TooltipPosition.BOTTOM,tooltip_contents:u,tooltip_classname:"notification-names-tooltip"},p):p}var m=l._("@Mention to notify someone.");return i.div({className:"comment-box-text"},m)},e.displayName="UsersToNotify",e.propTypes={usersToNotify:s.array.isRequired,user:s.object.isRequired},e})(n.default.Component);e.default=u}),define("modules/clean/react/file_comments/comment_card",["require","exports","tslib","react","external/react-dom-factories","external/prop-types","modules/clean/activity/activity_user","modules/clean/react/activity/users_to_notify","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),s=o.__importStar(s),a=o.__importDefault(a);var c=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.renderNotifyHint=function(){return e.props.isOffline?i.div({className:"comment-box-text"},l._("Posting will be re-enabled when you are online")):i.div({ref:"usersToNotify",className:"tooltip-container"},n.default.createElement(a.default,{usersToNotify:e.props.usersToNotify,user:e.props.user}))},e}return o.__extends(e,t),e.prototype.render=function(){return i.div({className:"comment-card-w-hint"},i.div({className:"comment-card"},this.props.children),this.props.shouldShowNotifyHint?this.renderNotifyHint():void 0)},e.displayName="CommentCard",e.propTypes={user:s.object,usersToNotify:s.arrayOf(s.instanceOf(r.ActivityUser)),shouldShowNotifyHint:s.bool,isOffline:s.bool},e})(n.default.Component);e.default=c}),define("modules/clean/react/file_comments/comment_list_header",["require","exports","tslib","external/create-react-class","external/react-dom-factories","external/prop-types","external/react-addons-pure-render-mixin","jquery","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),s=o.__importStar(s),r=o.__importStar(r),a=o.__importDefault(a);var c=n.default({displayName:"CommentListHeader",mixins:[r],propTypes:{activity:s.object,user:s.object,commentListOptions:s.node},_contactsSelectorPopupShown:function(){return setTimeout(function(){return a.default(".contacts-selector-popup input").trigger("focus")},300)},render:function(){return i.div({className:"comment-list-header-container"},i.div({className:"comment-list-header"},i.div({className:"comment-list-header-inner"},i.span({className:"title"},l._("Comments")),i.span({className:"options"}),this.props.commentListOptions)))}});e.default=c}),define("modules/clean/react/file_comments/comment_list_options",["require","exports","tslib","external/classnames","external/create-react-class","react","external/react-dom-factories","external/prop-types","external/react-addons-pure-render-mixin","modules/clean/comments/events","modules/clean/react/bubble_dropdown","modules/clean/react/file_comments/logger","modules/clean/react/sprite_div","modules/constants/comments_panel","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importDefault(s),r=o.__importStar(r),a=o.__importStar(a),l=o.__importStar(l),u=o.__importDefault(u),d=o.__importDefault(d),p=o.__importDefault(p);var _=s.default.createFactory(u.default),f=s.default.createFactory(p.default),v=i.default({displayName:"CommentListOptions",mixins:[l],propTypes:{activity:a.object,show_resolved:a.bool.isRequired,num_resolved:a.number.isRequired,is_subscribed:a.bool.isRequired,feedback_off:a.bool.isRequired,activity_context:a.number.isRequired,shouldShowDisableButton:a.bool.isRequired,user:a.object,isOffline:a.bool,actionCreators:a.object.isRequired},getDefaultProps:function(){return{isOffline:!1,num_resolved:0}},_hide_comments:function(t){return this.refs.dropdown.hide(),null!=this.props.activity&&d.default.log_event(m.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_COMMENTS_HIDDEN,this.props.activity.activity_key,null,null,this.props.user.id,this.props.activity_context),this.props.actionCreators.hideComments(),c.CommentsEvents.emit("hide-comments-pane")},_toggle_show_resolved:function(){if(0!==this.props.num_resolved&&!this.props.feedback_off)return this.refs.dropdown.hide(),this.props.show_resolved?this.props.actionCreators.hideResolvedComments():this.props.actionCreators.showResolvedComments()},_isSubscribeDisabled:function(){return this.props.feedback_off||this.props.isOffline},_toggle_subscribe:function(){if(!this._isSubscribeDisabled())return this.refs.dropdown.hide(),this.props.actionCreators.setCommentSubscribed({subscribed:!this.props.is_subscribed})},_isFeedbackSettingDisabled:function(){return this.props.isOffline},_turn_off_feedback:function(){if(!this._isFeedbackSettingDisabled())return this.refs.dropdown.hide(),this.props.actionCreators.setCommentsEnabled({enabled:!1})},render:function(){var t,e,o,i=[];t=this.props.show_resolved?h._("Hide resolved comments"):h._("Show resolved comments");var s=n.default({"comments-header-menu-option":!0,"toggle-resolved":!0,disabled:0===this.props.num_resolved||this.props.feedback_off}),a=r.a({key:"resolved",className:s,onMouseUp:this._toggle_show_resolved},f({group:"web",name:"s_resolve",text:t}));i.push(a),this.props.is_subscribed?(o=h._("Unsubscribe from notifications"),e="s_notifications_off"):(o=h._("Subscribe to notifications"),e="s_notifications_on");var l=n.default({"comments-header-menu-option":!0,"toggle-subscribe":!0,disabled:this._isSubscribeDisabled()}),c=r.a({key:"subscribe",className:l,onMouseUp:this._toggle_subscribe},f({group:"web",name:e,text:o}));if(i.push(c),this.props.shouldShowDisableButton){var u=n.default({"comments-header-menu-option":!0,"toggle-feedback-setting":!0,disabled:this._isFeedbackSettingDisabled()}),d=r.a({key:"toggle-feedback-setting",className:u,onMouseUp:this._turn_off_feedback},f({group:"web",name:"s_disable",text:h._("Disable comments")}));i.push(d)}return r.span({className:"options"},_({ref:"dropdown",targetButton:r.button({className:"button-as-link"},h._("Options")),arrow_position:"top-right",vertical_displacement:8,extra_css_class:"comments-header-bubble-dropdown"},i))}});e.default=v}),define("modules/clean/react/file_comments/comment_list_ui",["require","exports","tslib","external/classnames","external/create-react-class","react","external/react-dom","external/react-dom-factories","external/prop-types","external/react-addons-pure-render-mixin","external/lodash","jquery","modules/clean/comments/collection_utils","modules/clean/comments/components/ui_constants","modules/clean/comments/events","modules/clean/comments/store","modules/clean/components/loading_indicator","modules/clean/react/button","modules/clean/react/file_comments/comment_list_header","modules/clean/react/file_comments/comment_list_options","modules/clean/react/file_comments/comment_tutorial","modules/clean/react/file_comments/conversation_or_input_card","modules/clean/react/file_comments/file_revision_card","modules/clean/react_format","modules/constants/comments_panel","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h,_,f,v,g,y,C,b,S,w,T,N){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importDefault(s),r=o.__importStar(r),a=o.__importStar(a),l=o.__importStar(l),c=o.__importStar(c),u=o.__importStar(u),d=o.__importDefault(d),p=o.__importStar(p),_=o.__importDefault(_),v=o.__importStar(v),g=o.__importDefault(g),y=o.__importDefault(y),C=o.__importDefault(C),S=o.__importDefault(S),T=o.__importStar(T);var A=s.default.createFactory(v.button),x=s.default.createFactory(g.default),I=s.default.createFactory(y.default),k=s.default.createFactory(C.default),E=i.default({displayName:"CommentListUI",mixins:[c],propTypes:{context:l.number,activity:l.object,showLoadingSpinner:l.bool,contactSearchLogger:l.object,user:l.object,shouldInitiallyFocusInput:l.bool,showBottomBar:l.bool,showResolvedComments:l.bool,isCommentsMinimized:l.bool,isUserSubscribed:l.bool,shouldAutoLinkify:l.bool,enableImport:l.bool,shouldUseSimpleModals:l.bool,shouldHidePhotoAvatars:l.bool,isOffline:l.bool,shouldAnnotationButtonUseThumbnailUrls:l.bool,initialCommentsCount:l.number,shouldDisplayRegionCreationButton:l.bool,isRegionCreationEnabled:l.bool,showTutorial:l.bool,currentTutorialStep:l.string,isCommentsServerView:l.bool,revisions:l.array,actionCreators:l.object.isRequired,isDemoMode:l.bool},getInitialState:function(){return{shouldPopupsDropdown:!0,showBottomBar:!1,showNewCommentPill:!1,numFileLevelCommentsShown:0,uncollapsed:!1,commentListHeight:0,isDemoMode:!1}},getDefaultProps:function(){return{shouldAutoLinkify:!0,enableImport:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,isOffline:!1,shouldAnnotationButtonUseThumbnailUrls:!1}},componentWillUnmount:function(){return d.default(window).unbind("resize.bottom_bar")},componentDidMount:function(){return d.default(window).bind("resize.bottom_bar",this.checkScroll),this.checkScroll()},componentWillReceiveProps:function(t){var e=this.props.activity,o=t.activity;if(e!==o&&null!=e&&null!=o&&u.some(o.comment_activities.slice(e.comment_activities.length),function(e){return e.comment.commenter.id!==t.user.id}))return this.setState({showNewCommentPill:!0})},componentDidUpdate:function(t,e){if(this._isActivityFetchDone())return this.checkScroll(),this.updateListHeight()},onNewCommentPillClick:function(){return this.setState({showNewCommentPill:!1})},onAddReply:function(t,e){return this.props.actionCreators.addReply({targetActivityKey:e.activity_key,body:{text:t}})},onAddFileComment:function(t){return this.props.actionCreators.addFileComment({text:t})},onAddSticker:function(t){return this.props.actionCreators.addFileComment({stickerId:t})},onCommentListClick:function(){h.CommentsEvents.emit("collapse-all-conversations")},onCommentExpanded:function(t,e){return this.scrollCommentIntoView(t,e),this.props.actionCreators.setExpandedComment(!0)},onScroll:function(){return this.checkScroll()},checkScroll:function(){var t=d.default(r.findDOMNode(this.refs.commentList));this.setState({scrollTop:t.scrollTop()})},updateListHeight:function(){if(null!=this.refs.commentList){var t=d.default(r.findDOMNode(this.refs.commentList)).outerHeight();if(this.state.commentListHeight!==t)return this.setState({commentListHeight:t})}},turnOnFeedback:function(){return this.props.actionCreators.setCommentsEnabled({enabled:!0})},_isActivityFetchDone:function(){return null!=this.props.activity},forceBlur:function(){return d.default(document.activeElement).blur()},scrollCommentIntoView:function(t,e){var o=r.findDOMNode(this.refs.commentList),n=t+e-o.offsetTop-d.default(o).outerHeight();if(n>d.default(o).scrollTop())return d.default(o).animate({scrollTop:n},{duration:300})},animateScrollIntoView:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=t[0],n=o.node,i=o.padTop,s=null!=i?i:0,a=d.default(r.findDOMNode(this.refs.commentList)),l=d.default(n);return a.animate({scrollTop:a.scrollTop()+l.offset().top-a.offset().top-s},{duration:500})},positionDropdownCallback:function(){},renderLoadingSpinner:function(){return a.div({className:"comments-loading",key:"LoadingSpinner"},s.default.createElement(f.LoadingIndicator,{style:f.LoadingIndicator.LoadingIndicatorStyle.BLUE_SPINNER}),null!=this.props.initialCommentsCount&&this.props.initialCommentsCount>0?a.div({className:"comments-loading__count",ref:"commentsLoadingCount"},N.ungettext("Loading %(count)s comment","Loading %(count)s comments",this.props.initialCommentsCount).format({count:this.props.initialCommentsCount})):void 0)},renderBlankState:function(){return this.props.isCommentsMinimized?null:this.props.showTutorial?this.renderTutorialBlankState():this.renderDefaultBlankState()},renderDefaultBlankState:function(){return a.div({className:"blank-state rebrand-m1 u-pad-horizontal-m u-pad-bottom-m",ref:"blankState",key:"DefaultBlankState"},a.div({className:"blank-state-text u-pad-vertical-xs"},w.reactFormat(N._("Post a comment to start a discussion. <blue>@Mention</blue> someone to notify them."),{blue:a.span({key:"@MentionSpan",className:"blue"})})))},renderTutorialBlankState:function(){return a.div({key:"TutorialBlankState",ref:"tutorialBlankSlate",className:"blank-state rebrand-m1 u-pad-horizontal-m u-pad-bottom-m"},a.div({className:"blank-state-text blank-state-large-text blank-state-light-text u-pad-vertical-xs"},N._("Comment on specific areas")),a.div({className:"blank-state-text blank-state-medium-text blank-state-light-text u-pad-vertical-xs"},N._("See something that needs work? Leave a comment on the file.")),a.div({},A({className:"blank-state__button",importance:"primary",onClick:this.onTutorialBlankSlateClick},N._("Show me how"))))},onTutorialBlankSlateClick:function(){this.props.actionCreators.setCurrentTutorialStep(m.TUTORIAL_CREATE_ANNOTATION)},renderDisabledCommentState:function(){return a.div({className:"blank-state",key:"DisabledCommentsState"},a.div({className:"blank-state-text"},N._("Comments are off for this file.")),a.div({className:"blank-state-button"},A({className:"c-btn c-btn--secondary",importance:"secondary",disabled:!this.props.activity.can_edit_feedback,onMouseUp:this.turnOnFeedback},N._("Enable comments"))))},renderRevisionHistory:function(t){return a.div({className:"comment-card-w-hint comment-card-revision"},s.default.createElement(S.default,{fileRevisions:t}))},renderCommentCard:function(t,e){var o={activity:this.props.activity,onCancelComment:this.forceBlur,contactSearchLogger:this.props.contactSearchLogger,user:this.props.user,isOffline:this.props.isOffline,shouldShowPostText:!0};return null!=t?s.default.createElement(b.ConversationCard,{key:"threaded_"+t.activity_key,shouldInitiallyShowNotifyHint:!1,initialUsersToNotify:t.users_to_notify,commentProps:u.assignIn(o,this.getConversationSpecificProps(t,e)),actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode}):!_.default.isCommentingEnabled()||this.props.isCommentsMinimized?null:s.default.createElement(b.InputCard,{key:"FileLevelInputCard",ref:"commentInputCard",shouldInitiallyShowNotifyHint:!1,initialUsersToNotify:null!=this.props.activity?this.props.activity.users_to_notify:void 0,commentProps:u.assignIn(o,this.getInputSpecificProps()),actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode})},getInputSpecificProps:function(){return{shouldPopupsDropdown:this.state.shouldPopupsDropdown,showNewComment:this.state.showNewCommentPill,commentMetadataAllowed:T.ALLOW_STICKERS,shouldEnableStickers:T.ALLOW_STICKERS,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,enableImport:this.props.enableImport,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldAlwaysInEditMode:!1,shouldDisplayRegionCreationButton:this.props.shouldDisplayRegionCreationButton,isRegionCreationEnabled:this.props.isRegionCreationEnabled,isCommentInputDisabled:!this.props.activity,isCommentsServerView:this.props.isCommentsServerView,enableNoNotifyHint:!0,onAddComment:this.onAddFileComment,onAddSticker:this.onAddSticker,positionDropdownCallback:this.positionDropdownCallback,onShowNewComment:this.onNewCommentPillClick}},getConversationSpecificProps:function(t,e){return{commentActivity:t,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,annotationNumber:e,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldAutoLinkify:this.props.shouldAutoLinkify,isCommentsServerView:this.props.isCommentsServerView,onAddComment:this.onAddReply,onCommentExpanded:this.onCommentExpanded,scrollIntoView:this.animateScrollIntoView}},renderCommentGroup:function(t,e){return a.div({className:"comment-list__group"},a.div({className:"time"},t),e)},renderAnnotationGroup:function(t,e){return a.div({className:"comment-list__group"},t?a.div({className:"time"},"Page "+t):void 0,e)},renderCommentList:function(t){return this._isActivityFetchDone()?this._isActivityFetchDone()&&this.props.activity.feedback_off?this.renderDisabledCommentState():t.length>0?t:this._isActivityFetchDone()?this.renderBlankState():void 0:this.props.showLoadingSpinner?this.renderLoadingSpinner():this.renderBlankState()},renderCommentListOptions:function(t){var e=this._isActivityFetchDone()&&this.props.activity.feedback_off,o=this._isActivityFetchDone()&&this.props.activity.can_edit_feedback;return I({num_resolved:t,show_resolved:this.props.showResolvedComments,is_subscribed:this.props.isUserSubscribed,shouldShowDisableButton:!e&&o,feedback_off:e,activity_context:this.props.context,activity:this.props.activity,user:this.props.user,isOffline:this.props.isOffline,actionCreators:this.props.actionCreators})},renderTutorial:function(){return k({currentTutorialStep:this.props.currentTutorialStep,actionCreators:this.props.actionCreators})},hasComments:function(){return null!=this.props.initialCommentsCount&&this.props.initialCommentsCount>0||this._isActivityFetchDone()&&this.props.activity.comment_activities.length>0},_collapseComments:function(t,e,o,n){var i=this,s=u.findLastIndex(e,function(t){return t.shouldHighlightAsUnread()}),r=o,l=100*o,c=100*n,d=160+c;for(l+=d;r>2&&l>this.state.commentListHeight&&s<r-1;)r--,l=100*r,l+=d;if(r<o){var p=t.length-r;t=t.slice(0,r);var m=a.a({className:"comments-collapse-toggle",onClick:function(){return i.setState({uncollapsed:!0})}},N._("Show %(count)s more").format({count:p}));t.push(m)}return t},render:function(){var t=this,e=[],o=[],i=0,s=0,r=0;if(this._isActivityFetchDone()){for(var l=void 0,c=p.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!0,includeDocLevel:!1,includeResolved:!0}),u={},d=0;d<c.length;d++){u[c[d].activity_key]=d+1}var h=p.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!1,includeDocLevel:!0,includeResolved:this.props.showResolvedComments,sortBy:p.sortByReplyTime});i=p.getNumResolved(this.props.activity.comment_activities),s=h.length,e=h.map(this.renderCommentCard);var _=p.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!0,includeDocLevel:!1,includeResolved:this.props.showResolvedComments,sortBy:p.sortByTime});r=_.length,!this.state.uncollapsed&&s>0&&r>0&&(e=this._collapseComments(e,h,s,r));for(var f=Array.from(p.groupAnnotationActivitiesByPage(_)),v=f[0],g=f[1],y=0,C=Array.from(v);y<C.length;y++){var b=C[y];l=g[b].map(function(e){return t.renderCommentCard(e,u[e.activity_key])}),o.push(this.renderAnnotationGroup(b,l))}}var S=n.default({"comment-list":!0,"comment-list--minimized":this.props.isCommentsMinimized,scrolled:this.state.showBottomBar}),w=n.default({"comments-holder":!0,"comments-activity-loaded":this._isActivityFetchDone(),"comments-holder--border":this.state.scrollTop>0}),N=this.renderCommentCard(),A=[];if(s>0){var I=a.div({key:"FileLevelComments",className:"file-level-comments-list"},e);A.push(I)}if(s>0&&r>0&&A.push(a.hr({key:"HorizontalDivider",className:"c-rule u-mar-vertical-xs",style:{width:"100%"}})),r>0){var k=a.div({key:"AnnotationCommentsList",className:"annotation-comments-list"},o);A.push(k)}var E=[N,this.renderCommentList(A)],D=n.default({"comment-tutorial":!0,"comment-tutorial--is-dev":T.ARE_DEV_TOOLS_SHOWN});return a.div({className:w,ref:"commentsHolder"},this.props.isCommentsServerView?x({ref:"commentListHeader",activity:this.props.activity,user:this.props.user,commentListOptions:this.renderCommentListOptions(i)}):void 0,a.div({className:S,ref:"commentList",onScroll:this.onScroll,onClick:this.onCommentListClick},E),!this.props.showTutorial||this.props.isCommentsMinimized||!this.hasComments()&&this.props.currentTutorialStep===m.TUTORIAL_INITIATOR?void 0:a.div({className:D},this.renderTutorial()))}});e.default=E}),define("modules/clean/react/file_comments/comment_tutorial",["require","exports","tslib","external/classnames","react","external/react-dom-factories","external/prop-types","modules/clean/comments/components/ui_constants","modules/clean/comments/constants","modules/clean/comments/logging","modules/clean/css","modules/clean/react/button","modules/clean/react/image","modules/clean/react/sprite","modules/clean/react_format","modules/clean/static_urls","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h,_,f){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importStar(s),r=o.__importStar(r),c=o.__importStar(c),u=o.__importStar(u),d=o.__importStar(d);var v=i.default.createElement,g=i.default.createFactory(d.button),y=i.default.createFactory(m.Sprite),C=i.default.createFactory(p.Image),b=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._logTutorial=function(t){return c.logEvent(t,l.FileActivityLogClientOriginType.COMMENTS_TUTORIAL)},e._onShowMeHow=function(){return e.props.actionCreators.setCurrentTutorialStep(a.TUTORIAL_CREATE_ANNOTATION)},e._onClose=function(){return e._logTutorial(l.FileActivityLogEventType.TUTORIAL_CLOSE),e.props.actionCreators.markCommentsTutorialAsDone(),e.props.actionCreators.setShowTutorial(!1)},e._onDone=function(){return e._logTutorial(l.FileActivityLogEventType.TUTORIAL_DONE),e.props.actionCreators.setShowTutorial(!1)},e._onNext=function(){if(e._logTutorial(l.FileActivityLogEventType.TUTORIAL_NEXT),e.props.currentTutorialStep===a.TUTORIAL_MENTION)return e.props.actionCreators.setShowTutorial(!1);var t=(function(){switch(e.props.currentTutorialStep){case a.TUTORIAL_CREATE_ANNOTATION:return a.TUTORIAL_REPLY;case a.TUTORIAL_CREATE_ANNOTATION_SUCCESS:return a.TUTORIAL_REPLY;case a.TUTORIAL_REPLY:return a.TUTORIAL_MENTION;case a.TUTORIAL_REPLY_SUCCESS:return a.TUTORIAL_MENTION}})();return e.props.actionCreators.setCurrentTutorialStep(t)},e._renderCurrentStep=function(){switch(e.props.currentTutorialStep){case a.TUTORIAL_CREATE_ANNOTATION:return e._logTutorial(l.FileActivityLogEventType.TUTORIAL_CREATE_ANNOTATION),e._renderCreateAnnotationStep();case a.TUTORIAL_CREATE_ANNOTATION_SUCCESS:return e._logTutorial(l.FileActivityLogEventType.TUTORIAL_CREATE_ANNOTATION_SUCCESS),e._renderCreateAnnotationSuccessStep();case a.TUTORIAL_REPLY:return e._logTutorial(l.FileActivityLogEventType.TUTORIAL_REPLY),e._renderReplyStep();case a.TUTORIAL_REPLY_SUCCESS:return e._logTutorial(l.FileActivityLogEventType.TUTORIAL_REPLY_SUCCESS),e._renderReplySuccessStep();case a.TUTORIAL_MENTION:return e._logTutorial(l.FileActivityLogEventType.TUTORIAL_MENTION),e.props.actionCreators.markCommentsTutorialAsDone(),e._renderMentionStep();case a.TUTORIAL_MENTION_SUCCESS:return e._logTutorial(l.FileActivityLogEventType.TUTORIAL_MENTION_SUCCESS),e._renderMentionSuccessStep();default:return e._renderInitiatorStep()}},e._renderInitiatorStep=function(){return s.div({className:"comment-tutorial__step"},s.div({className:"comment-tutorial__text"},s.p({className:"comment-tutorial__text comment-tutorial__text--bold"},f._("Comment on specific areas")),s.p({},f._("See something that needs work? Leave a comment on the file."))),g({className:"comment-tutorial__button",importance:"secondary",onClick:e._onShowMeHow},f._("Show me how")))},e._renderCreateAnnotationStep=function(){return s.div({className:"comment-tutorial__step"},s.div({className:"comment-tutorial__text"},h.reactFormat(f._("First, click the comment <CommentSprite/> button up above, then click anywhere on the file."),{CommentSprite:v(m.Sprite,{group:"web",name:"ic_comment_area_dark",className:"comment-tutorial__sprite"})})),C({width:250,height:150,src:_.static_url("/static/images/commenting/onboarding_animation_step1-vflStlhr4.gif"),srcHiRes:_.static_url("/static/images/commenting/onboarding_animation_step1@2x-vfls5nQtW.gif")}))},e._renderCreateAnnotationSuccessStep=function(){return s.div({className:"comment-tutorial__step"},e._renderSuccessIcon(),s.div({className:"comment-tutorial__text"},s.p({className:"comment-tutorial__text comment-tutorial__text--bold"},f._("Sweet!")),s.p({},f._("Comments are an easy way to leave notes for others."))))},e._renderReplyStep=function(){return s.div({className:"comment-tutorial__step"},s.div({className:"comment-tutorial__text"},f._("Click any comment to review or reply to it.")),C({width:250,height:150,src:_.static_url("/static/images/commenting/onboarding_animation_step2-vfl96uLLF.gif"),srcHiRes:_.static_url("/static/images/commenting/onboarding_animation_step2@2x-vfl8g0EZh.gif")}))},e._renderReplySuccessStep=function(){return s.div({className:"comment-tutorial__step"},e._renderSuccessIcon(),s.div({className:"comment-tutorial__text"},s.p({className:"comment-tutorial__text comment-tutorial__text--bold"},f._("Just like that!")),s.p({},h.reactFormat(f._("You can even reply with emojis <Emoji/>"),{Emoji:v(m.Sprite,{group:"emoji",name:"1F604",className:"comment-tutorial__sprite"})}))))},e._renderMentionStep=function(){return s.div({className:"comment-tutorial__step"},s.div({className:"comment-tutorial__text"},f._("To notify someone, create a comment and type “@” followed by their email address.")),C({width:250,height:150,src:_.static_url("/static/images/commenting/onboarding_animation_step3-vfl2mhKA1.gif"),srcHiRes:_.static_url("/static/images/commenting/onboarding_animation_step3@2x-vflJYSw1X.gif")}))},e._renderMentionSuccessStep=function(){return s.div({className:"comment-tutorial__step"},e._renderSuccessIcon(),s.div({className:"comment-tutorial__text"},s.p({className:"comment-tutorial__text comment-tutorial__text--bold"},f._("You’re a natural!")),s.p({},f._("@mentions lets you notify others without having to send out a separate email."))))},e._renderSuccessIcon=function(){return C({width:38,height:40,src:_.static_url("/static/images/commenting/tutorial_success-vflO6ncSG.png"),srcHiRes:_.static_url("/static/images/commenting/tutorial_success@2x-vflchqv1n.png")})},e._getCurrentStepText=function(){switch(e.props.currentTutorialStep){case a.TUTORIAL_CREATE_ANNOTATION:return f._("Step 1/3");case a.TUTORIAL_CREATE_ANNOTATION_SUCCESS:return f._("Step 1/3");case a.TUTORIAL_REPLY:return f._("Step 2/3");case a.TUTORIAL_REPLY_SUCCESS:return f._("Step 2/3");case a.TUTORIAL_MENTION:return f._("Step 3/3");case a.TUTORIAL_MENTION_SUCCESS:return f._("Step 3/3")}},e._renderHeader=function(){return s.div({className:"comment-tutorial__toolbar clearfix"},s.div({className:"comment-tutorial__counter"},e._getCurrentStepText()),s.a({className:"comment-tutorial__close",onClick:e._onClose},y({alt:f._("Close"),group:"web",name:"tutorial_close"})))},e._renderFooter=function(){if(null!=e.props.currentTutorialStep&&e.props.currentTutorialStep!==a.TUTORIAL_INITIATOR)return s.div({className:"comment-tutorial__footer clearfix"},e.props.currentTutorialStep===a.TUTORIAL_MENTION_SUCCESS?s.a({ref:"done",className:"comment-tutorial__done",onClick:e._onDone},f._("Done")):s.a({ref:"next",className:"comment-tutorial__next",onClick:e._onNext},f._("Next")))},e}return o.__extends(e,t),e.prototype.componentDidMount=function(){return u.require_css("/static/css/sprites/emoji_sprites-vflJeUmZ7.css")},e.prototype.render=function(){var t=(e={"comment-tutorial__steps":!0},e["comment-tutorial__steps-"+this.props.currentTutorialStep]=!0,e);return s.div({className:"comment-tutorial__container"},this._renderHeader(),s.div({className:n.default(t),ref:this.props.currentTutorialStep},this._renderCurrentStep()),this._renderFooter());var e},e.displayName="CommentTutorial",e.propTypes={currentTutorialStep:r.string,actionCreators:r.object.isRequired},e.defaultProps={currentTutorialStep:a.TUTORIAL_INITIATOR},e})(i.default.Component);e.default=b}),define("modules/clean/react/file_comments/conversation_or_input_card",["require","exports","tslib","external/create-react-class","react","external/prop-types","external/react-addons-pure-render-mixin","external/lodash","modules/clean/activity/activity_user","modules/clean/react/activity/comment_input","modules/clean/react/file_comments/comment_card","modules/clean/react/file_comments/threaded_comment_activity_ui"],function(t,e,o,n,i,s,r,a,l,c,u,d){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importStar(s),r=o.__importStar(r),a=o.__importStar(a),c=o.__importDefault(c),u=o.__importDefault(u),d=o.__importDefault(d);var p=function(t,e){var o=a.keyBy(t,"display_name"),n=a.keyBy(e,"display_name"),i=a.assignIn({},o,n);return a.values(i)},m={getInitialState:function(){return{mentionedUsers:[],shouldShowNotifyHint:this.props.shouldInitiallyShowNotifyHint}},getDefaultProps:function(){return{initialUsersToNotify:[]}},onMentionedUsersChanged:function(t){return this.setState({mentionedUsers:t})},getUsersToNotify:function(){return p(this.props.initialUsersToNotify,this.state.mentionedUsers)},clearMentionedUsers:function(){if(this.isMounted())return this.setState({mentionedUsers:[]})},setShouldShowNotifyHint:function(t){return this.setState({shouldShowNotifyHint:t})}},h=n.default({displayName:"ConversationCard",mixins:[r,m],propTypes:{shouldInitiallyShowNotifyHint:s.bool,initialUsersToNotify:s.arrayOf(s.instanceOf(l.ActivityUser)),commentProps:s.shape(c.default.propTypes),actionCreators:s.object},onAddComment:function(t,e){return this.clearMentionedUsers(),"function"==typeof this.props.commentProps.onAddComment?this.props.commentProps.onAddComment(t,e):void 0},renderCommentThread:function(){return i.default.createElement(d.default,o.__assign({},a.assignIn({},this.props.commentProps,{onMentionedUsersChanged:this.onMentionedUsersChanged,setShouldShowNotifyHint:this.setShouldShowNotifyHint,usersToNotify:this.getUsersToNotify(),onAddComment:this.onAddComment,actionCreators:this.props.actionCreators})))},render:function(){return i.default.createElement(u.default,{shouldInitiallyShowNotifyHint:this.props.shouldInitiallyShowNotifyHint,user:this.props.commentProps.user,isOffline:this.props.commentProps.isOffline,shouldShowNotifyHint:this.state.shouldShowNotifyHint,usersToNotify:this.getUsersToNotify(),shouldPopupsDropdown:!1},this.renderCommentThread())}});e.ConversationCard=h;var _=n.default({displayName:"InputCard",mixins:[r,m],propTypes:{shouldInitiallyShowNotifyHint:s.bool,initialUsersToNotify:s.arrayOf(s.instanceOf(l.ActivityUser)),
commentProps:s.shape(c.default.propTypes),actionCreators:s.object},onAddComment:function(t){return this.clearMentionedUsers(),"function"==typeof this.props.commentProps.onAddComment?this.props.commentProps.onAddComment(t):void 0},onEditModeChange:function(t){return this.setState({shouldShowNotifyHint:t})},renderCommentInput:function(){return i.default.createElement(c.default,o.__assign({},a.assignIn({},this.props.commentProps,{ref:"commentInput",onMentionedUsersChanged:this.onMentionedUsersChanged,setShouldShowNotifyHint:this.setShouldShowNotifyHint,usersToNotify:this.getUsersToNotify(),onAddComment:this.onAddComment,actionCreators:this.props.actionCreators,isCommentInputDisabled:this.props.commentProps.isCommentInputDisabled,onEditModeChange:this.onEditModeChange})))},render:function(){return i.default.createElement(u.default,{shouldInitiallyShowNotifyHint:this.props.shouldInitiallyShowNotifyHint,initialUsersToNotify:this.props.initialUsersToNotify,user:this.props.commentProps.user,isOffline:this.props.commentProps.isOffline,shouldShowNotifyHint:this.state.shouldShowNotifyHint,usersToNotify:this.getUsersToNotify()},this.renderCommentInput())}});e.InputCard=_}),define("modules/clean/react/file_comments/file_comments_pane",["require","exports","tslib","external/classnames","external/create-react-class","react","external/react-dom-factories","external/prop-types","external/react-addons-pure-render-mixin","jquery","modules/clean/analytics","modules/clean/comments/events","modules/clean/comments/utils","modules/clean/file_activity/api","modules/clean/file_activity/models/file_activity","modules/clean/react/file_comments/comment_list_ui","modules/clean/react/file_comments/onboarding","modules/clean/react/file_comments/toggle_bar","modules/clean/react/modal","modules/constants/comments_panel","modules/core/i18n","modules/core/notify"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h,_,f,v,g,y,C,b){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importDefault(s),r=o.__importStar(r),a=o.__importStar(a),l=o.__importStar(l),c=o.__importDefault(c),p=o.__importStar(p),m=o.__importStar(m),_=o.__importDefault(_),f=o.__importDefault(f),y=o.__importStar(y);var S=s.default.createFactory(_.default),w=s.default.createFactory(f.default),T=s.default.createFactory(v.FileCommentsToggleBar),N=i.default({displayName:"FileCommentsPane",mixins:[l],propTypes:{showButtonColor:a.string.isRequired,activity:a.instanceOf(h.FileActivity),context:a.number,contextData:a.string,showResolvedComments:a.bool,isPreviewReady:a.bool,showLoadingSpinner:a.bool,isCommentsHidden:a.bool,feedbackId:a.string.isRequired,userId:a.number,showDisabledCommentBar:a.bool,previewSelector:a.string,shouldInitiallyFocusInput:a.bool,shouldAutoLinkify:a.bool,enableImport:a.bool,shouldUseSimpleModals:a.bool,shouldHidePhotoAvatars:a.bool,oref:a.string,shouldCheckOffline:a.bool,shouldShowOnboarding:a.bool,onOnboardingModalOpen:a.func,shouldAnnotationButtonUseThumbnailUrls:a.bool,initialCommentsCount:a.number,isUserSubscribed:a.bool,isRegionCreationEnabled:a.bool,showTutorial:a.bool,currentTutorialStep:a.string,isCommentsServerView:a.bool,revisions:a.array,actionCreators:a.object.isRequired,isCommentingEnabled:a.bool,showToggleButton:a.bool},getInitialState:function(){return{icon:"s_comments_locked",isOffline:!1,height:0}},getDefaultProps:function(){return{shouldAutoLinkify:!0,enableImport:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,file:null,shouldCheckOffline:!1,shouldShowOnboarding:!1,shouldAnnotationButtonUseThumbnailUrls:y.ALLOW_ANNOTATION_THUMBNAILS}},componentWillMount:function(){return this.isAnnotationGhostEnabled=y.ALLOW_ANNOTATION_GHOST},componentDidMount:function(){if(this._refreshWidth(),this.contactSearchLogger=new u.ContactSearchLogger,this.props.shouldCheckOffline)return this._checkAndSetIsOffline(),this.offlineInterval=setInterval(this._checkAndSetIsOffline,1e3)},maybeShowOnboardingModal:function(){if(this.props.shouldShowOnboarding){var t=w({onOpen:this.props.onOnboardingModalOpen});return g.Modal.showInstance(t)}},fitToHeight:function(t){if(this.state.height!==t)return this.setState({height:t})},_isPreviewAndCommentsReady:function(){return this.state.enabled&&null!=this._getActivity()&&this.previewIsReady&&!this.state.isFetchingActivity},_fileHasReplies:function(){if(null!=this._getActivity())for(var t=0,e=Array.from(this._getActivity().comment_activities);t<e.length;t++){var o=e[t];if(o.comment_activities.length>0)return!0}return!1},_checkAndSetIsOffline:function(){return this.setState({isOffline:!navigator.onLine})},_getActivity:function(){return this.props.activity},_showResolvedComments:function(){return this.props.showResolvedComments},showFeedbackModal:function(t){var e=this;null!=t&&t.preventDefault();return g.SimpleModal.show({title_text:C._("Help us improve comments"),body_html:'<div class="text-input comment-feedback-input"> <div class="text-input-wrapper"> <textarea id="comments-feedback-input" placeholder="Let us know how we can improve commenting in Dropbox." ></textarea> </div> </div>',cancel_text:C._("Cancel"),confirm_text:C._("Submit Feedback"),confirm_callback:function(){var t=c.default("#comments-feedback-input").val(),o=function(){return b.Notify.success(C._("Thank you! Your feedback will help improve Dropbox."))},n=function(){return function(){return b.Notify.error(C._("There was an error submitting your feedback."))}};return m.submitProductFeedback({actorId:e.props.userId,feedbackText:t,context:e.props.context,contextData:e.props.contextData,oref:e.props.oref}).then(o,n)}})},getActivityUser:function(){return p.getActivityUser(this.props.userId)},setLockedIcon:function(){return this.setState({icon:"s_comments_locked"})},setUnlockedIcon:function(){return this.setState({icon:"s_comments_unlocked"})},show:function(){return this.props.actionCreators.showComments(),d.CommentsEvents.emit("show-comments-pane")},_refreshWidth:function(){if(c.default(".video-js").length)return c.default(".video-js").css("width","100%")},_isMinimized:function(){return this.props.showToggleButton&&this.props.isCommentsHidden},_renderCommentsListUI:function(){var t=this.getActivityUser(),e=t.is_signed_in&&y.ALLOW_WEB_FEEDBACK&&!this.props.isCommentsServerView,o=this.props.isPreviewReady;return r.div({className:"comments-and-feedback"},this.state.isOffline?r.div({className:"comments-offline-banner"},r.div({className:"comments-offline-banner-inner"},C._("No Internet Connection"))):void 0,S({ref:"commentListUI",showLoadingSpinner:this.props.showLoadingSpinner,context:this.props.context,activity:this._getActivity(),user:t,contactSearchLogger:this.contactSearchLogger,initialCommentsCount:this.props.initialCommentsCount,revisions:this.props.revisions,isCommentsMinimized:this._isMinimized(),isUserSubscribed:this.props.isUserSubscribed,shouldAutoLinkify:this.props.shouldAutoLinkify,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,showResolvedComments:this._showResolvedComments(),enableImport:this.props.enableImport,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isOffline:this.state.isOffline,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldDisplayRegionCreationButton:o,isRegionCreationEnabled:this.props.isRegionCreationEnabled,showTutorial:this.props.showTutorial&&this.props.isPreviewReady,currentTutorialStep:this.props.currentTutorialStep,isCommentsServerView:this.props.isCommentsServerView,actionCreators:this.props.actionCreators}),e&&!this._isMinimized()?r.div({className:"comments-feedback-link"},r.div({className:"comments-feedback-link-inner"},r.a({onMouseUp:this.showFeedbackModal},C._("Help us improve comments")))):void 0)},render:function(){var t,e=n.default({"file-feedback":!0,"file-feedback--minimized":this._isMinimized(),"preview-ready":this.props.isPreviewReady,hidden:!this.state.enabled});t=0!==this.state.height?{height:this.state.height}:{};var o={id:this.props.feedbackId,ref:"fileCommentsPane",className:e,tabIndex:"-1",style:t};if(this.props.showToggleButton){var i=T({isHidden:this.props.isCommentsHidden,actionCreators:this.props.actionCreators});return r.div(o,i,this._renderCommentsListUI())}return this.props.isCommentsHidden?r.div({id:this.props.feedbackId,className:"hidden"}):r.div(o,this._renderCommentsListUI())}});e.FileCommentsPaneClass=N}),define("modules/clean/react/file_comments/file_revision_card",["require","exports","tslib","react","external/react-dom-factories","external/prop-types","modules/clean/datetime","modules/clean/react/sprite","modules/clean/react_format","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l,c){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),s=o.__importStar(s);var u=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.state={collapsed:!1},e._onClick=function(){return e.setState({collapsed:!e.state.collapsed})},e._renderHeader=function(){for(var t=e.props.fileRevisions[0],o=[],s=0,r=Array.from(e.props.fileRevisions);s<r.length;s++){var u=r[s];o.indexOf(u.author)<0&&o.push(u.author)}return i.div({},i.div({className:"comment-revision-history__icon"},n.default.createElement(a.Sprite,{group:"web",name:"previous_versions",alt:"Previous versions"})),i.div({className:"comment-revision-history__header"},t.is_primary_revision?t.action_description:l.reactFormat(c.ungettext("<a>%(count)s revision</a> updated by %(authors)s","<a>%(count)s revisions</a> updated by %(authors)s",e.props.fileRevisions.length),{a:i.a(),count:e.props.fileRevisions.length,authors:o.length>2?o.join(", "):o.join(" and ")})))},e._renderRevisions=function(){return i.ul({className:"comment-revision-history__list"},Array.from(e.props.fileRevisions).map(function(t){return i.li({},l.reactFormat("<spanSize>"+t.file.size+"</spanSize> <b>"+t.author+"</b> <spanDetails> "+r.ago(t.when_mses)+" ("+t.device_name+")</spanDetails>",{spanSize:i.span({className:"comment-revision-history__size"}),b:i.b(),spanDetails:i.span({className:"comment-revision-history__details"})}))}))},e}return o.__extends(e,t),e.prototype.render=function(){return i.div({className:"comment-revision-history",onClick:this._onClick},this._renderHeader(),this.state.collapsed?this._renderRevisions():void 0)},e.displayName="FileRevisionCard",e.propTypes={fileRevisions:s.array.isRequired},e})(n.default.Component);e.default=u}),define("modules/clean/react/file_comments/live_sticker",["require","exports","tslib","react","external/react-dom","external/classnames","modules/clean/react/pure_render","modules/clean/sticker_util","modules/clean/event_handler","modules/clean/comments/lib/animation"],function(t,e,o,n,i,s,r,a,l,c){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),s=o.__importDefault(s);var u=(function(t){function e(e){var o=t.call(this,e)||this;return o.onPreviewLoad=function(){o.setState({previewReady:!0,initial:!o.props.skipInitial&&o.state.spritesReady})},o.onStaticLoad=function(){o.setState({staticReady:!0})},o.onSpritesLoad=function(){o.setState({spritesReady:!0,initial:!o.props.skipInitial&&o.state.previewReady})},o.state={previewReady:!1,staticReady:!1,spritesReady:!1,mouseOver:!1,initial:!1,intro:!1,loop:!1,outro:!1},o}return o.__extends(e,t),e.prototype.componentDidMount=function(){var t=i.findDOMNode(this.refs.sticker);this.events.on(t,c.ANIMATION_ITERATION_EVENT,this.onAnimationIteration,this),this.events.on(t,c.ANIMATION_END_EVENT,this.onAnimationEnd,this),this.events.on(t,"mouseenter touchstart",this.onMouseEnter,this),this.events.on(t,"mouseleave touchend",this.onMouseLeave,this)},e.prototype.onAnimationIteration=function(){this.setState({initial:this.state.initial&&!this.state.mouseOver,intro:this.state.loop&&!this.state.mouseOver,loop:this.state.mouseOver,outro:!1})},e.prototype.onAnimationEnd=function(){this.setState({initial:!1,intro:this.state.outro&&!this.state.mouseOver,loop:this.state.mouseOver,outro:!1})},e.prototype.onMouseEnter=function(){this.state.mouseOver||this.setState({mouseOver:!0,outro:!(this.state.loop||this.state.intro||this.state.initial)})},e.prototype.onMouseLeave=function(){this.state.mouseOver&&this.setState({mouseOver:!1})},e.prototype.render=function(){var t=this.props,e=t.stickerId,o=t.size,i=t.keepLooping,r=t.stickerUtil,a=this.state,l=a.previewReady,c=a.spritesReady,u=a.initial,d=a.intro,p=a.loop,m=a.outro,h="live-sticker-"+e,_=null,f=s.default("live-sticker","live-sticker-"+e,{"live-sticker-ready":l&&c,"live-sticker-initial":u,"live-sticker-intro":d,"live-sticker-loop":i||p,"live-sticker-outro":m,"live-sticker-size-small":"small"===o});return l&&c||(_=n.default.createElement("img",{className:"live-sticker-preview",onLoad:this.onPreviewLoad,src:r.getStickerImageUrl(e,"preview"),alt:h})),n.default.createElement("span",{ref:"sticker",className:f,"data-sticker-id":e},n.default.createElement("img",{className:"live-sticker-sprites",onLoad:this.onSpritesLoad,src:r.getStickerImageUrl(e,"sprites"),alt:""}),n.default.createElement("span",{className:"live-sticker-sprites-overlay"}),n.default.createElement("img",{className:"live-sticker-static",onLoad:this.onStaticLoad,src:r.getStickerImageUrl(e,"png"),srcSet:r.getStickerImageUrl(e,"png@2x")+" 2x",alt:h}),_)},e=o.__decorate([r.pureRender,l.eventHandler],e)})(n.default.Component);e.LiveSticker=a.withAsyncStickerUtil(u)}),define("modules/clean/react/file_comments/standalone_feedback_ui",["require","exports","tslib","external/create-react-class","react","external/prop-types","modules/clean/activity/constants","modules/clean/comments/action_creators","modules/clean/comments/flux","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/file_activity/clients/file_activity_data_source","modules/clean/history","modules/clean/react/file_comments/file_comments_pane","modules/clean/web_timing_logger","modules/constants/comments_panel"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h,_){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importStar(s),a=o.__importDefault(a),l=o.__importStar(l),c=o.__importDefault(c),u=o.__importStar(u),d=o.__importDefault(d),p=o.__importDefault(p),h=o.__importStar(h),_=o.__importStar(_);var f=i.default.createFactory(m.FileCommentsPaneClass),v=n.default({displayName:"StandaloneFeedbackUI",mixins:[l.sync(c.default)],propTypes:{"fq-path":s.string.isRequired},componentWillMount:function(){d.default.initInstance(),p.default.update_query_param("oref","sscv");var t=u.getActivityUser().id,e=this.props["fq-path"];a.default.startViewingComments({actorId:t,context:r.ActivityContext.BROWSE_FILE_VIEWER,contextData:e,oref:"sscv",file:null,previewSelector:null})},componentDidMount:function(){return this.refs.fileCommentsPane.fitToHeight(window.innerHeight)},componentDidUpdate:function(t,e){if(null==e.activity&&null!=this.state.activity)return this.onActivityLoaded()},onActivityLoaded:function(t){if(!this.marked_tti)return this.marked_tti=!0,h.mark_time_to_interactive()},render:function(){return f({ref:"fileCommentsPane",feedbackId:"file-comments",activity:this.state.activity,showLoadingSpinner:this.state.showLoadingSpinner,context:this.state.viewing.context,contextData:this.state.viewing.contextData,revisions:this.state.revisions,userId:this.state.actorId,file:null,oref:this.state.oref,showResolvedComments:this.state.showResolvedComments,enableImport:!1,shouldAutoLinkify:!0,shouldCheckOffline:!1,shouldHidePhotoAvatars:!1,shouldUseSimpleModals:!0,shouldAnnotationButtonUseThumbnailUrls:_.ALLOW_ANNOTATION_THUMBNAILS_SERVER_VIEW,showButtonColor:"white",visible:!0,isUserSubscribed:c.default.isUserSubscribed(this.state.actorId),isCommentsServerView:!0,actionCreators:a.default})}});e.StandaloneFeedbackUI=v}),define("modules/clean/react/file_comments/threaded_comment_activity_ui",["require","exports","tslib","external/classnames","external/create-react-class","react","external/react-dom","external/react-dom-factories","external/prop-types","external/react-addons-pure-render-mixin","external/lodash","jquery","modules/clean/comments/events","modules/clean/comments/lib/animation","modules/clean/comments/models/comment_activity","modules/clean/event_handler","modules/clean/file_activity/models/file_activity","modules/clean/react/activity/comment_activity_ui","modules/clean/react/activity/comment_input","modules/clean/react/activity/resolve_button","modules/constants/comments_panel","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l,c,u,d,p,m,h,_,f,v,g,y,C,b){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importDefault(s),r=o.__importStar(r),a=o.__importStar(a),l=o.__importStar(l),c=o.__importStar(c),u=o.__importStar(u),d=o.__importDefault(d),v=o.__importDefault(v),g=o.__importDefault(g),y=o.__importDefault(y),C=o.__importStar(C);var S=s.default.createFactory(v.default),w=s.default.createFactory(g.default),T=s.default.createFactory(y.default),N=i.default({displayName:"ThreadedCommentActivityUI",mixins:[c,_.EventHandlerMixin,p.CommentsEventsMixin],propTypes:{context:l.number,commentActivity:l.instanceOf(h.CommentActivity).isRequired,user:l.object.isRequired,shouldAnnotationButtonUseThumbnailUrls:l.bool,shouldAutoLinkify:l.bool,shouldUseSimpleModals:l.bool,shouldHidePhotoAvatars:l.bool,activity:l.instanceOf(f.FileActivity).isRequired,replyText:l.string,showResolvedComments:l.bool,contactSearchLogger:l.object,onReplyInputFocus:l.func,onReplyInputBlur:l.func,enableImport:l.bool,showNewComment:l.bool,checkScroll:l.func,onShowNewComment:l.func,onCommentExpanded:l.func,onCancelComment:l.func,annotationNumber:l.number,isInAnnotationBubble:l.bool,scrollIntoView:l.func,setShouldShowNotifyHint:l.func,onMentionedUsersChanged:l.func,onAddComment:l.func,onInputChange:l.func,isCommentsServerView:l.bool,actionCreators:l.object.isRequired},getInitialState:function(){return{isExpanded:!1,isExpandedByReply:!1,highlighting:!1}},getDefaultProps:function(){return{shouldAnnotationButtonUseThumbnailUrls:!1}},componentDidMount:function(){if(!this.props.isInAnnotationBubble)return this.events.on(r.findDOMNode(this),m.ANIMATION_END_EVENT,this.onAnimationEnd,this),this.onCommentsEvent("reveal-comment-in-pane",this.onRevealComment),this.onCommentsEvent("collapse-all-conversations",this.onCollapseConversation)},componentDidUpdate:function(t,e){if(this.state.isExpanded&&!e.isExpanded&&null!=this.props.onCommentExpanded){var o=r.findDOMNode(this).offsetTop,n=r.findDOMNode(this).clientHeight+47;this.state.isExpandedByReply&&!e.isExpandedByReply&&this.props.onCommentExpanded(o,n),this.props.actionCreators.setExpandedComment(!0)}if(this.state.isExpanded!==e.isExpanded)return"function"==typeof this.props.setShouldShowNotifyHint?this.props.setShouldShowNotifyHint(this.state.isExpanded):void 0},onRevealComment:function(t){var e=t.activityKey,o=t.expandConversation,n=this.props.commentActivity;return n.activity_key===e?this.revealConversation(o):u.find(n.comment_activities,{activity_key:e})?this.revealReply():void 0},revealConversation:function(t){var e={highlighting:!0};return t&&(e.isExpanded=!0),this.setState(e),"function"==typeof this.props.scrollIntoView?this.props.scrollIntoView({node:r.findDOMNode(this),padTop:10}):void 0},revealReply:function(){return this.setState({isExpanded:!0})},onAnimationEnd:function(){return this.setState({highlighting:!1})},onCollapseConversation:function(){return this.setState({isExpanded:!1})},onAddComment:function(t){return"function"==typeof this.props.onAddComment?this.props.onAddComment(t,this.props.commentActivity):void 0},onAddSticker:function(t){return this.props.actionCreators.addReply({targetActivityKey:this.props.commentActivity.activity_key,body:{stickerId:t}})},resizeCallback:function(t){if(void 0===t&&(t=!1),this.forceUpdate(),t&&null!=this.props.onCommentExpanded){var e=r.findDOMNode(this).offsetTop,o=r.findDOMNode(this).clientHeight+47;return this.props.onCommentExpanded(e,o)}},onClick:function(t){if(t.stopPropagation(),this.setState({isExpandedByReply:d.default(t.target).is("a.reply-button")}),this.state.isExpanded){if(this._shouldClickCollapseThread(t))return this.setState({isExpanded:!1})}else if(this._shouldClickExpandThread(t))return this.setState({isExpanded:!0}),this.props.actionCreators.markConversationSeen(this.props.commentActivity.activity_key)},_shouldClickExpandThread:function(t){return 0===d.default(t.target).parents(".threaded-comment-header").length},_shouldClickCollapseThread:function(t){var e=d.default(t.target);return 0!==e.closest(".threaded-comment-header").length&&0===e.closest(".annotation-thumbnail-page").length&&0===e.closest(".annotation-thumbnail-label-text").length},hasReplies:function(){return this.repliesCount()>0},repliesCount:function(){return this.props.commentActivity.comment_activities.length},onUpdateResolve:function(t){return this.props.actionCreators.setCommentResolved({commentActivityKey:this.props.commentActivity.activity_key,resolved:t})},renderHeader:function(){if(this.state.isExpanded){var t=this.props.commentActivity.comment;return a.div({className:"threaded-comment-list__header"},a.div({className:"clearfix"},T({resolved:t.resolved,onUpdateResolve:this.onUpdateResolve,isOffline:this.props.isOffline})))}},renderCommentActivityUI:function(t,e,o,n){return void 0===o&&(o=!1),void 0===n&&(n=!1),S({key:"comment_"+e.activity_key,ref:"child-"+e.activity_key,parentActivity:t,fileActivity:this.props.activity,comment_activity:e,user:this.props.user,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,annotationNumber:this.props.annotationNumber,shouldShowReplyButton:n,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldAutoLinkify:this.props.shouldAutoLinkify,isReply:o,isExpanded:this.state.isExpanded,truncateLength:100,isInAnnotationBubble:this.props.isInAnnotationBubble,actionCreators:this.props.actionCreators,scrollIntoView:this.props.scrollIntoView})},render:function(){var t=this,e=[];if(this.hasReplies())for(var o=0;o<this.props.commentActivity.comment_activities.length;o++){var i=this.props.commentActivity.comment_activities[o];if(!i.comment.resolved||this.props.showResolvedComments){var s=o===this.repliesCount()-1;e.push(this.renderCommentActivityUI(this.props.commentActivity,i,!0,s))}}return a.div({className:n.default({"threaded-comment-list":!0,"threaded-comment-list--expanded":this.state.isExpanded,"threaded-comment-list--unread":this.props.commentActivity.shouldHighlightAsUnread(),"threaded-comment-list--highlighting":this.state.highlighting}),"data-comment-activity-key":this.props.commentActivity.activity_key,onClick:this.onClick,onMouseLeave:this._onMouseLeave},this.renderHeader(),a.div({},this.renderCommentActivityUI(this.props.activity,this.props.commentActivity,!1,!(this.hasReplies()||this.props.commentActivity.is_pending)),this.hasReplies()?this.repliesCount()>1&&!this.state.isExpanded?[a.div({className:"comment-activity__expand"},a.a({className:"replies-count-button"},b.ungettext("%(num)s more reply","%(num)s more replies",this.repliesCount()-1).format({num:this.repliesCount()-1}))),e[e.length-1]]:e:void 0),(function(){if(t.state.isExpanded&&!t.props.commentActivity.is_pending){var e=t.state.isExpandedByReply;return w({ref:"commentInput",activity:t.props.activity,user:t.props.user,usersToNotify:t.props.commentActivity.users_to_notify,onAddComment:t.onAddComment,onCancelComment:t.props.onCancelComment,contactSearchLogger:t.props.contactSearchLogger,onAddSticker:t.onAddSticker,resizeCallback:t.resizeCallback,popupsShouldDropdown:t.state.popupsShouldDropdown,onFocus:t.props.onReplyInputFocus,onBlur:t.props.onReplyInputBlur,onShowNewComment:t.props.onShowNewComment,showNewComment:t.props.showNewComment,onChange:t.props.onInputChange,shouldShowPostText:t.props.shouldShowPostText,initialText:t.props.replyText,commentMetadataAllowed:C.ALLOW_STICKERS,shouldEnableStickers:C.ALLOW_STICKERS,shouldInitiallyFocusInput:e,enableImport:t.props.enableImport,shouldHidePhotoAvatars:t.props.shouldHidePhotoAvatars,isReplyInput:!0,shouldShowAvatar:!0,shouldAlwaysInEditMode:!0,onMentionedUsersChanged:t.props.onMentionedUsersChanged,isCommentsServerView:t.props.isCommentsServerView,actionCreators:t.props.actionCreators})}})())}});e.default=N}),define("modules/clean/react/file_comments/threaded_comment_header",["require","exports","tslib","external/classnames","external/create-react-class","react","external/react-dom-factories","external/prop-types","external/react-addons-pure-render-mixin","modules/clean/annotations/annotation","modules/clean/react/activity/annotation_button","modules/clean/react/activity/resolve_button","modules/core/i18n"],function(t,e,o,n,i,s,r,a,l,c,u,d,p){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),s=o.__importDefault(s),r=o.__importStar(r),a=o.__importStar(a),l=o.__importStar(l),d=o.__importDefault(d);var m=s.default.createFactory(d.default),h=s.default.createFactory(u.AnnotationThumbnailClass),_=i.default({displayName:"ThreadedCommentHeader",mixins:[l],propTypes:{annotation:a.object,revision:a.object,isOldRevision:a.bool,onClick:a.func,isHeader:a.bool,onUpdateResolve:a.func,isOffline:a.bool,shouldShowResolveButton:a.bool,resolved:a.bool,annotationNumber:a.number,shouldAnnotationButtonUseThumbnailUrls:a.bool,showAnnotationThumbnail:a.bool},_getPrimaryText:function(t){return this.props.shouldAnnotationButtonUseThumbnailUrls?t.type===c.AnnotationTypes.HIGHLIGHT?this.props.showAnnotationThumbnail?p._("Close text annotation"):p._("View text annotation"):this.props.showAnnotationThumbnail?p._("Close thumbnail"):p._("View thumbnail"):p._("View on file")},_renderAnnotationNumber:function(){var t={"annotation-number":!0,"annotation-number--resolved":this.props.resolved,"annotation-number--old-revision":this.props.isOldRevision};return r.div({className:n.default(t)},this.props.annotationNumber)},_renderAnnotationThumbnail:function(){return h({annotation:this.props.annotation,thumbnailUrl:this.props.annotation.thumbnail_url})},render:function(){var t={"annotation-thumbnail-label":!0,"is-on-old-revision":this.props.isOldRevision};return r.div({},r.div({className:"threaded-comment-header comment-annotation",onClick:this.props.onClick},r.div({className:"comment-annotation-button"},this._renderAnnotationNumber(),r.div({className:n.default(t)},r.a({className:"annotation-thumbnail-label-text"},this._getPrimaryText(this.props.annotation)),this.props.isOldRevision?r.div({className:"older-revision"},p._("Older version")):void 0),this.props.shouldShowResolveButton?m({resolved:this.props.resolved,onUpdateResolve:this.props.onUpdateResolve,isOffline:this.props.isOffline}):void 0)),this.props.showAnnotationThumbnail?this.props.annotation.type===c.AnnotationTypes.HIGHLIGHT?r.div({className:"comment-annotation-highlight"},this.props.annotation.text_highlight.text):r.div({className:"comment-annotation-thumbnail"},this._renderAnnotationThumbnail()):void 0)}});e.default=_}),define("modules/clean/react/file_comments/toggle_bar",["require","exports","tslib","external/classnames","react","modules/clean/react/file_sidebar/file_sidebar_maestro_toggle_button","modules/clean/react/file_viewer/logging","modules/clean/react/file_viewer/constants","modules/core/i18n","modules/clean/comments/store"],function(t,e,o,n,i,s,r,a,l,c){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importDefault(i),c=o.__importDefault(c);var u=(function(t){function e(e){var o=t.call(this,e)||this;return o.onStoreUpdate=function(){o.setState(o.getStateFromStore())},o.showComments=function(){o.props.actionCreators.showComments(),r.logUserAction(a.UserAction.ToggleCommentsOn,a.UserActionContext.Sidebar)},o.hideComments=function(){o.props.actionCreators.hideComments(),r.logUserAction(a.UserAction.ToggleCommentsOff,a.UserActionContext.Sidebar)},o.getCommentsText=function(){return o.state.unreadCommentCount>0?l._("Comments (%(unread_comment_count)s)").format({unread_comment_count:o.state.unreadCommentCount}):l._("Comments")},o._renderCommentsText=function(){return o.props.isHidden?null:i.default.createElement("div",{className:"file-sidebar__unread-count"},o.getCommentsText())},o.state=o.getStateFromStore(),o.removeStoreListener=c.default.listen(o.onStoreUpdate),o}return o.__extends(e,t),e.prototype.componentWillUnmount=function(){this.removeStoreListener&&this.removeStoreListener()},e.prototype.getStateFromStore=function(){return{unreadCommentCount:c.default.unreadCommentCount()}},e.prototype.render=function(){var t,e;this.props.isHidden?(t=l._("Show Sidebar"),e=this.showComments):(t=l._("Hide Sidebar"),e=this.hideComments);var o=n.default({"toggle-comments__button":!0,"toggle-comments__button-on":!this.props.isHidden,"toggle-comments__button-off":this.props.isHidden});return i.default.createElement("div",{className:"file-sidebar__toggle-bar clearfix"},this._renderCommentsText(),i.default.createElement(s.FileSidebarMaestroToggleButton,{className:o,isOpen:!this.props.isHidden,alt:t,onClick:e}))},e})(i.default.Component);e.FileCommentsToggleBar=u}),define("modules/clean/react/file_sidebar/file_sidebar_maestro_toggle_button",["require","exports","tslib","react","modules/clean/react/sprite","modules/clean/react/title_bubble","modules/core/i18n"],function(t,e,o,n,i,s,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n);var a=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o.__extends(e,t),e.prototype.render=function(){var t=this.props.isOpen?r._("Hide"):r._("Show"),e=this.props.isOpen?"s_sidebar_hide":"s_sidebar_show",o="sprite-button "+this.props.className;return n.default.createElement(s.TitleBubble,{content:t,position:s.TitleBubble.POSITIONS.LEFT,distanceFromTarget:10},n.default.createElement("button",{onClick:this.props.onClick,disabled:this.props.isDisabled,className:o},n.default.createElement(i.Sprite,{group:"web",name:e,alt:this.props.alt})))},e.defaultProps={className:""},e})(n.default.Component);e.FileSidebarMaestroToggleButton=a}),define("modules/clean/react/pure_render",["require","exports","tslib","external/react-addons-pure-render-mixin"],function(t,e,o,n){"use strict";function i(t){t.prototype.shouldComponentUpdate=n.shouldComponentUpdate}Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importStar(n),e.pureRender=i}),define("modules/clean/sticker_util",["require","exports","tslib","react","external/lodash","modules/clean/ajax","modules/clean/react/async/loadable"],function(t,e,o,n,i,s,r){"use strict";function a(t,i){var s=this;return r.Loadable({loader:function(){return o.__awaiter(s,void 0,void 0,function(){var i;return o.__generator(this,function(s){switch(s.label){case 0:return[4,e.fetchStickersAndCreateStickerUtil()];case 1:return i=s.sent(),[2,function(e){return n.default.createElement(t,o.__assign({},e,{stickerUtil:i}))}]}})})},loading:i})}var l=this;Object.defineProperty(e,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),s=o.__importStar(s);var c=(function(){function t(t){this.stickersJson=t}return t.prototype.getStickers=function(){if(!this.cachedStickerDataSets){var t=i.groupBy(this.stickersJson.stickers,"set_id");this.cachedStickerDataSets=this.stickersJson.sets.map(function(e){var o=e.id;return{id:o,stickers:i.get(t,o,[])}})}return this.cachedStickerDataSets},Object.defineProperty(t.prototype,"stickerDataById",{get:function(){return this.cachedStickerDataById||(this.cachedStickerDataById=i.keyBy(this.stickersJson.stickers,"id")),this.cachedStickerDataById},enumerable:!0,configurable:!0}),t.prototype.isLiveSticker=function(t){return this.stickerDataById[t]&&this.stickerDataById[t].live_sticker},
t.prototype.getStickerImageUrl=function(t,e){return void 0===e&&(e="png"),this.stickersJson.sticker_img_url+"/"+t+"?type="+e},t.prototype.getStickerSetImageUrl=function(t){return this.stickersJson.sticker_set_img_url+"/"+t},t})();e.fetchStickersAndCreateStickerUtil=i.once(function(){return o.__awaiter(l,void 0,void 0,function(){var t;return o.__generator(this,function(e){switch(e.label){case 0:return t=c.bind,[4,new Promise(function(t,e){return s.SilentBackgroundRequest({url:"/file_activity/get_stickers",type:"POST",dataType:"json",success:t,error:function(t,o,n){return e(Error(n))}})})];case 1:return[2,new(t.apply(c,[void 0,e.sent()]))]}})})}),e.withAsyncStickerUtil=a;var u=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o.__extends(e,t),e.prototype.render=function(){var t=this.props,e=t.stickerId,o=t.stickerUtil,i=t.className;return n.default.createElement("img",{className:i,src:o.getStickerImageUrl(e)})},e})(n.default.PureComponent);e.StickerImage=a(u)});
//# sourceMappingURL=pkg-legacy-ac.min.js-vflnR-qGm.map