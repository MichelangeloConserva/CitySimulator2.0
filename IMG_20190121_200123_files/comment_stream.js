define(["require","exports","tslib","react","classnames","spectrum_comments/thread","spectrum_comments/comment_stream/comment_stream_post_bar","spectrum_comments/comment","spectrum_comments/comment_editor/comment_utils","spectrum_comments/comment_editor/comment_editor","prop-types","spectrum_comments/comment_stream/unread_pill_wrapper","spectrum_comments/utils/calc_visibility_data","spectrum_comments/utils/visibility_aware_scroll_list"],function(e,t,n,o,r,a,i,s,d,c,m,u,l,p){"use strict";function h(e,t){return e.map(function(e){return{item:e,ref:t[e.id]}}).filter(function(e){var t=e.item,n=e.ref;return!t.read&&n})}Object.defineProperty(t,"__esModule",{value:!0});var f=function(){};i.CommentStreamPostBar.contextTypes={localization:m.object};var C=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.threadIdToRef={},t.editorHasChanges={},t.state={content:d.createEmptyContent(),editedComment:void 0,visibilityData:l.createEmptyVisibilityData(),trackedItems:[]},t.onThreadActivated=function(e){t.props.actionsAdapter.onThreadActivated(e)},t.onVisibilityDataChange=function(e){t.setState({visibilityData:e})},t.updateTrackedItems=function(){t.setState({trackedItems:h(t.props.threads,t.threadIdToRef)})},t.onStartEdit=function(e){t.setState({editedComment:e})},t.onEndEdit=function(){t.setState({editedComment:void 0})},t.setDraftRef=function(e){t.draftRef=e},t.setThreadRef=function(e,n){t.threadIdToRef[e]=n&&n.ref},t.handleClick=function(e){e.currentTarget===e.target&&(t.props.actionsAdapter.onAllThreadsDeactivated(),t.editorHasChanges.PRIMARY||t.props.actionsAdapter.onCommentDraftCancel())},t.onThreadReplyCancel=function(){t.props.actionsAdapter.onAllThreadsDeactivated()},t.onPrimaryEditorCancel=function(){document.activeElement&&t.blurElement(document.activeElement),t.props.actionsAdapter.onCommentDraftCancel(),t.setState({content:d.createEmptyContent(),editedComment:void 0})},t.onPrimaryEditorFocus=function(){t.props.actionsAdapter.onAllThreadsDeactivated(),t.props.actionsAdapter.onEditorFocused()},t.onEditorContentChange=function(e){return function(n){t.editorHasChanges[e]=!n.isEmpty}},t.onPrimaryEditorContentChange=t.onEditorContentChange("PRIMARY"),t.hasUnsavedChanges=function(){var e=t.props.threads;return t.editorHasChanges.PRIMARY||e.some(function(e){return t.editorHasChanges[e.id]||!!e.pending})||void 0!==t.state.editedComment},t.promptBeforeCloseHandler=function(e){if(t.hasUnsavedChanges())return e.returnValue="",e.preventDefault(),""},t.createThreadActions=function(e){var n=t.props.actionsAdapter,o=n.onCommentDeleted,r=n.onCommentEdited,a=n.onClickTimeCode,i=n.onEditorFocused,s=n.onMentionsQueryUpdated,d=n.onThreadMarkedAsRead,c=n.onThreadMarkedAsUnread,m=n.onThreadRepliedTo,u=n.onThreadResolved,l=n.onThreadUnresolved,p=n.onThreadMouseEnter,h=void 0===p?f:p,C=n.onThreadMouseLeave,v=void 0===C?f:C;return{onClickTimeCode:a,onReply:function(t){return m(e,t)},onMarkAsRead:function(){return d(e)},onMarkAsUnread:function(){return c(e)},onResolve:function(){return u(e)},onUnresolve:function(){return l(e)},onMouseEnter:function(){return h(e)},onMouseLeave:function(){return v(e)},onEditorFocused:function(){return i(e)},onCommentDeleted:function(t){return o(t,e)},onCommentEdited:function(t,n){return r(t,n,e)},onMentionsQueryUpdated:s,onEditorContentChange:t.onEditorContentChange(e)}},t}return n.__extends(t,e),t.prototype.getChildContext=function(){return{localization:this.props.localization}},t.prototype.componentDidMount=function(){window.addEventListener("beforeunload",this.promptBeforeCloseHandler),this.updateTrackedItems()},t.prototype.componentDidUpdate=function(e){this.props.threads!==e.threads&&this.updateTrackedItems()},t.prototype.componentWillUnmount=function(){window.removeEventListener("beforeunload",this.promptBeforeCloseHandler)},t.prototype.focusPrimaryEditor=function(){this.draftRef&&this.draftRef.focusEditor()},t.prototype.blurElement=function(e){var t;"function"==typeof Event?t=new FocusEvent("blur"):(t=document.createEvent("Event"),t.initEvent("blur",!0,!0)),e.dispatchEvent(t)},t.prototype.render=function(){var e=this,t=this.props,d=t.actionsAdapter,m=d.onMentionsQueryUpdated,l=d.onThreadCreated,h=t.className,f=void 0===h?"":h,C=t.commentComponent,v=void 0===C?function(e){return o.createElement(s.Comment,n.__assign({},e))}:C,E=t.editorComponent,y=void 0===E?function(e){return o.createElement(c.CommentEditor,n.__assign({},e))}:E,T=t.enabled,_=t.user,A=t.mentionsMatches,g=t.activeThreadID,b=t.hoverThreadID,R=t.isMobile,D=t.threads,M=t.localization,P=r(f,{"sc-comment-stream":!0,"sc-comment-stream-enabled":T,"sc-comment-stream-all-changes-saved":!this.hasUnsavedChanges()}),k=null;return _&&!R&&(k=y({author:_,className:"sc-comment-stream-editor",content:this.state.content,placeholder:M.streamEditorPlaceholder,postSignalComponent:i.CommentStreamPostBar,onCancel:this.onPrimaryEditorCancel,setDraftRef:this.setDraftRef,onPost:l,mentionsMatches:A,onMentionsQueryUpdated:m,onFocus:this.onPrimaryEditorFocus,onContentChange:this.onPrimaryEditorContentChange})),o.createElement("div",{className:P,onClick:this.handleClick},k,o.createElement(u.UnreadPillWrapper,{showUnreadPill:this.props.showUnreadPill,visibilityData:this.state.visibilityData,countMsgFn:M.unreadComments,onItemActivated:this.onThreadActivated},o.createElement(p.VisibilityAwareScrollList,{className:"sc-comment-stream-threads",trackedItems:this.state.trackedItems,onVisibilityDataChange:this.onVisibilityDataChange},D.map(function(t){return o.createElement(a.Thread,{ref:function(n){return e.setThreadRef(t.id,n)},key:t.id,actions:e.createThreadActions(t.id),active:t.id===g,hover:t.id===b,commentComponent:v,editedComment:e.state.editedComment,onActivated:function(){return e.onThreadActivated(t)},onCancel:e.onThreadReplyCancel,onStartEdit:e.onStartEdit,onEndEdit:e.onEndEdit,isMobile:R,thread:t,user:_,mentionsMatches:A})}))))},t.childContextTypes={localization:m.object},t})(o.PureComponent);t.CommentStream=C});
//# sourceMappingURL=comment_stream.min.js-vflqOBnNh.map