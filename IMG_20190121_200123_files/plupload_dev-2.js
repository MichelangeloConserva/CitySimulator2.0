define(["external/moxie"],function(e){return(function(e,t,r){function s(e){function t(e,t,r){var i={chunks:"slice_blob",resize:"send_binary_string",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",max_file_size:"access_binary",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};i[e]?s[i[e]]=t:r||(s[e]=t)}var r=e.required_features,s={};return"string"==typeof r?o.each(r.split(/\s*,\s*/),function(e){t(e,!0)}):"object"==typeof r?o.each(r,function(e,r){t(r,e)}):r===!0&&(e.multipart||(s.send_binary_string=!0),e.chunk_size>0&&(s.slice_blob=!0),o.each(e,function(e,r){t(r,!!e,!0)})),s}var i=e.setTimeout,n={},o={VERSION:"2.0.0beta",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,OVER_QUOTA_ERROR:-708,BLOCKS_MISSING_ERROR:-703,COMMIT_HTTP_ERROR:-704,UPLOAD_BLOCK_ERROR:-705,CHUNKS_NOT_ENABLED_ERROR:-706,SERVER_HASH_RESPONSE_ERROR:-707,BLOCK_RUNTIME_ID_MISSING:-709,CLIENT_HASH_EMPTY_ERROR:-710,SERVER_HASH_EMPTY_ERROR:-711,HASHES_NOT_EQUAL_ERROR:-712,BLOCK_INDEX_ERROR:-713,BLOCK_EMPTY_ERROR:-714,BLOB_EMPTY_ERROR:-715,CLIENT_HASH_DIGEST_ERROR:-716,FILE_READER_NULL_RESULT_ERROR:-717,COMMIT_READINESS_ERROR:-718,SERVER_RESPONSE_ERROR:-719,SERVER_TOKEN_EMPTY_ERROR:-720,BLOB_MISSING_ERROR:-721,SERVER_TOKENS_MISSING_ERROR:-722,mimeTypes:t.mimes,ua:t.ua,typeOf:t.typeOf,extend:t.extend,guid:t.guid,each:t.each,getPos:t.getPos,getSize:t.getSize,xmlEncode:function(e){var t={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"};return e?(""+e).replace(/[<>&\"\']/g,function(e){return t[e]?"&"+t[e]+";":e}):e},toArray:t.toArray,inArray:t.inArray,addI18n:t.addI18n,translate:t.translate,isEmptyObj:t.isEmptyObj,hasClass:t.hasClass,addClass:t.addClass,removeClass:t.removeClass,getStyle:t.getStyle,addEvent:t.addEvent,removeEvent:t.removeEvent,removeAllEvents:t.removeAllEvents,cleanName:function(e){var t,r;for(r=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"],t=0;t<r.length;t+=2)e=e.replace(r[t],r[t+1]);return e=e.replace(/\s+/g,"_"),e=e.replace(/[^a-z0-9_\-\.]+/gi,"")},buildUrl:function(e,t){var r="";return o.each(t,function(e,t){r+=(r?"&":"")+encodeURIComponent(t)+"="+encodeURIComponent(e)}),r&&(e+=(e.indexOf("?")>0?"&":"?")+r),e},formatSize:function(e){return void 0===e||/\D/.test(e)?o.translate("N/A"):e>1099511627776?Math.round(e/1099511627776,1)+" "+o.translate("tb"):e>1073741824?Math.round(e/1073741824,1)+" "+o.translate("gb"):e>1048576?Math.round(e/1048576,1)+" "+o.translate("mb"):e>1024?Math.round(e/1024,1)+" "+o.translate("kb"):e+" "+o.translate("b")},parseSize:t.parseSizeStr,predictRuntime:function(e,t){var r,s;return t&&(e.runtimes=t),r=new o.Uploader(e),s=r.runtime,r.destroy(),s},addFileFilter:function(e,t){n[e]=t}};o.addFileFilter("mime_types",(function(){function e(e){var t=[];return o.each(e,function(e){o.each(e.extensions.split(/,/),function(e){/^\s*\*\s*$/.test(e)?t.push("\\.*"):t.push("\\."+e.replace(new RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$&")+"]","g"),"\\$&"))})}),new RegExp("("+t.join("|")+")$","i")}var t,r;return function(s,i,n){r&&s==t||(r=e(s),t=[].slice.call(s)),r.test(i.name)?n(!0):(this.trigger("Error",{code:o.FILE_EXTENSION_ERROR,message:o.translate("File extension error."),file:i}),n(!1))}})()),o.addFileFilter("max_file_size",function(e,t,r){void 0!==t.size&&e&&t.size>e?(this.trigger("Error",{code:o.FILE_SIZE_ERROR,message:o.translate("File size error."),file:t}),r(!1)):r(!0)}),o.addFileFilter("prevent_duplicates",function(e,t,r){if(e)for(var s=this.files.length;s--;)if(t.name===this.files[s].name&&t.size===this.files[s].size)return this.trigger("Error",{code:o.FILE_DUPLICATE_ERROR,message:o.translate("Duplicate file error."),file:t}),void r(!1);r(!0)}),o.Uploader=function(r){function a(){var e,t,s=0;if(r.parallel_uploads||r.waterfall_parallel_uploads)for(t=0;t<h.length;t++)if(h[t].status==o.UPLOADING)return;if(this.state==o.STARTED){for(t=0;t<h.length;t++)e||h[t].status!=o.QUEUED?s++:(e=h[t],this.trigger("BeforeUpload",e)&&(e.status=o.UPLOADING,this.trigger("UploadFile",e)));s==h.length&&(this.state!==o.STOPPED&&(this.state=o.STOPPED,this.trigger("StateChanged")),this.trigger("UploadComplete",h))}}function l(e){e.percent=e.size>0?Math.ceil(e.loaded/e.size*100):100,u()}function u(){var e,t;for(p.reset(),e=0;e<h.length;e++)t=h[e],void 0!==t.size?(p.size+=t.origSize,p.loaded+=t.loaded*t.origSize/t.size):p.size=void 0,t.status==o.DONE?p.uploaded++:t.status==o.FAILED?p.failed++:p.queued++;void 0===p.size?p.percent=h.length>0?Math.ceil(p.uploaded/h.length*100):0:(p.bytesPerSec=Math.ceil(p.loaded/((+new Date-_||1)/1e3)),p.percent=p.size>0?Math.ceil(p.loaded/p.size*100):0)}function d(){var e=this,s=0,i={accept:r.filters.mime_types,runtime_order:r.runtimes,required_caps:S,swf_url:r.flash_swf_url,xap_url:r.silverlight_xap_url};o.each(r.runtimes.split(/\s*,\s*/),function(e){r[e]&&(i[e]=r[e])}),t.inSeries([function(n){r.browse_button?(R=new t.FileInput(o.extend({},i,{name:r.file_data_name,multiple:r.multi_selection,container:r.container,browse_button:r.browse_button})),R.onready=function(){var r=t.Runtime.getInfo(this.ruid);t.extend(e.features,{chunks:r.can("slice_blob"),multipart:r.can("send_multipart"),multi_selection:r.can("select_multiple")}),s++,n()},R.onchange=function(){e.trigger("BeforeFilesAdded",this.files)&&e.addFile(this.files)},R.bind("mouseenter mouseleave mousedown mouseup",function(e){if(!I){var s=t.get(r.browse_button);s&&(r.browse_button_hover&&("mouseenter"===e.type?t.addClass(s,r.browse_button_hover):"mouseleave"===e.type&&t.removeClass(s,r.browse_button_hover)),r.browse_button_active&&("mousedown"===e.type?t.addClass(s,r.browse_button_active):"mouseup"===e.type&&t.removeClass(s,r.browse_button_active)),s=null)}}),R.bind("mousedown",function(){e.trigger("Browse")}),R.bind("error runtimeerror",function(){R=null,n()}),R.init()):n()},function(n){r.drop_element?(E=new t.FileDrop(o.extend({},i,{drop_zone:r.drop_element})),E.onready=function(){var r=t.Runtime.getInfo(this.ruid);e.features.dragdrop=r.can("drag_and_drop"),s++,n()},E.ondrop=function(){e.trigger("DragAndDrop"),e.addFile(this.files)},E.bind("error runtimeerror",function(){E=null,n()}),E.init()):n()}],function(){"function"==typeof r.init?r.init(e):o.each(r.init,function(t,r){e.bind(r,t)}),s?e.trigger("PostInit"):e.trigger("Error",{code:o.INIT_ERROR,message:o.translate("Init error.")})})}function c(e,r){if(e.ruid){var s=t.Runtime.getInfo(e.ruid);if(s)return s.can(r)}return!1}function g(e,r,s){var i=new t.Image;try{i.onload=function(){i.downsize(r.width,r.height,r.crop,r.preserve_headers)},i.onresize=function(){s(this.getAsBlob(e.type,r.quality)),this.destroy()},i.onerror=function(){s(e)},i.load(e)}catch(t){s(e)}}var f,_,p,R,E,m,h=[],v={},O=!1,b={},S={},I=!1;p=new o.QueueProgress,r=o.extend({runtimes:t.Runtime.order,max_retries:0,multipart:!0,multi_selection:!0,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",send_chunk_number:!0},r),r.resize&&(r.resize=o.extend({preserve_headers:!0,crop:!1},r.resize)),"array"===o.typeOf(r.filters)&&(r.filters={mime_types:r.filters}),r.filters=o.extend({mime_types:[],prevent_duplicates:!!r.prevent_duplicates,max_file_size:r.max_file_size},r.filters),r.filters.max_file_size=o.parseSize(r.filters.max_file_size)||0,r.chunk_size=o.parseSize(r.chunk_size)||0,r.required_features=S=s(o.extend({},r)),o.extend(this,{id:o.guid(),state:o.STOPPED,features:{},runtime:t.Runtime.thatCan(S,r.runtimes),files:h,settings:r,total:p,init:function(){function s(e){Object.keys(e).forEach(function(t){e[t].abort()})}function n(){s(v),v={}}var p=this;if(r.browse_button=t.get(r.browse_button),r.drop_element=t.get(r.drop_element),"function"==typeof r.preinit?r.preinit(p):o.each(r.preinit,function(e,t){p.bind(t,e)}),!r.browse_button||!r.url)return void this.trigger("Error",{code:o.INIT_ERROR,message:o.translate("Init error.")});p.bind("FilesAdded",function(e,t){[].push.apply(h,t),i(function(){p.trigger("QueueChanged"),p.refresh()},1)}),p.bind("CancelUpload",function(){r.parallel_uploads||r.waterfall_parallel_uploads?(f&&f.abort(),O=!0,n()):m&&m.abort()}),r.unique_names&&p.bind("BeforeUpload",function(e,t){var r=t.name.match(/\.([^.]+)$/),s="part";r&&(s=r[1]),t.target_name=t.id+"."+s}),p.bind("UploadFile",function(a,l){function u(){507!==m.status&&I-- >0?i(d,1):(l.loaded=y,a.trigger("Error",{code:o.HTTP_ERROR,message:o.translate("HTTP Error."),file:l,response:m.responseText,status:m.status,responseHeaders:m.getAllResponseHeaders()}))}function d(){var e,s,n,c;l.status!=o.DONE&&l.status!=o.FAILED&&a.state!=o.STOPPED&&(n={name:l.target_name||l.name},b&&h.chunks&&R.size>b?(c=Math.min(b,R.size-y),e=R.slice(y,y+c)):(c=R.size,e=R),b&&h.chunks?r.send_chunk_number?(n.chunk=Math.ceil(y/b),n.chunks=Math.ceil(R.size/b)):(n.offset=y,n.total=R.size):(n.chunk=0,n.chunks=1),m=new t.XMLHttpRequest,m.withCredentials=!0,m.upload&&(m.upload.onprogress=function(e){l.loaded=Math.min(l.size,y+e.loaded),a.trigger("UploadProgress",l,!0)}),m.onload=function(){if(m.status>=400)return void u();c<R.size?(e.destroy(),y+=c,l.loaded=Math.min(y,R.size),a.trigger("ChunkUploaded",l,{offset:l.loaded,total:R.size,response:m.responseText,status:m.status,responseHeaders:m.getAllResponseHeaders()}),"Android Browser"===t.Env.browser&&a.trigger("UploadProgress",l,!0)):l.loaded=l.size,e=s=null,!y||y>=R.size?(l.size!=l.origSize&&(R.destroy(),R=null),a.trigger("UploadProgress",l,!0),l.status=o.DONE,a.trigger("FileUploaded",l,{response:m.responseText,status:m.status,responseHeaders:m.getAllResponseHeaders()})):(I=r.max_retries,i(d,1))},m.onerror=function(){u()},m.onloadend=function(){this.destroy(),m=null},a.settings.multipart&&h.multipart?(n.name=l.target_name||l.name,m.open("post",E,!0),o.each(a.settings.headers,function(e,t){m.setRequestHeader(t,e)}),s=new t.FormData,o.each(o.extend(n,a.settings.multipart_params),function(e,t){s.append(t,e)}),s.append(a.settings.file_data_name,e),m.send(s,{runtime_order:a.settings.runtimes,required_caps:S,swf_url:a.settings.flash_swf_url,xap_url:a.settings.silverlight_xap_url})):(E=o.buildUrl(a.settings.url,o.extend(n,a.settings.multipart_params)),m.open("post",E,!0),m.setRequestHeader("Content-Type","application/octet-stream"),o.each(a.settings.headers,function(e,t){m.setRequestHeader(t,e)}),m.send(e,{runtime_order:a.settings.runtimes,required_caps:S,swf_url:a.settings.flash_swf_url,xap_url:a.settings.silverlight_xap_url})))}function _(){function r(e){var t;if(y<=b)t=R;else{var r=e*b,s=Math.min(b,y-r);t=R.slice(r,r+s)}return t&&0!==t.size?t:(n(),void a.trigger("Error",{code:o.BLOCK_EMPTY_ERROR,message:o.translate("Block is empty."),file:l,blockIndex:e}))}function u(){return C===z&&P.length===z&&!P.includes(void 0)}function d(e){for(;e.endsWith("=");)e=e.slice(0,-1);return e}function c(e){return e.replace(/\//g,"_").replace(/\+/g,"-")}function g(e){function t(s){var i=r(s);if(!i.ruid)return n(),void a.trigger("Error",{code:o.BLOCK_RUNTIME_ID_MISSING_ERROR,message:o.translate("Block ruid missing."),file:l});i.connectRuntime(i.ruid);var u=new FileReader;f=u,u.onloadend=function(r){if(!r.target.result&&!O)return n(),void a.trigger("Error",{code:o.FILE_READER_NULL_RESULT_ERROR,message:o.translate("File reader null result."),file:l,blockIndex:s});var u=crypto.subtle.digest("SHA-256",r.target.result);i.disconnectRuntime(),u.then(function(r){var i=btoa(String.fromCharCode.apply(null,new Uint8Array(r))),u=c(i);if(u=d(u),!u&&!O)return n(),void a.trigger("Error",{code:o.CLIENT_HASH_EMPTY_ERROR,message:o.translate("Client hash empty or undefined error."),file:l});N[s]=u,s++,l.loaded+=1e4,a.trigger("UploadProgress",l,!1),s>=z?(l.loaded=0,e()):t(s)}).catch(function(e){if(!O)return n(),void a.trigger("Error",{code:o.CLIENT_HASH_DIGEST_ERROR,message:o.translate(e),file:l,blockIndex:s})})};var g=i.getSource();u.readAsArrayBuffer(g)}t(0)}function _(){for(var e=0;e<6&&e<z;e++)T=e,m(e)}function p(e,t){if(!(507!==t.status&&D[e]<a.settings.max_retries))return l.loaded=0,n(),void a.trigger("Error",{code:o.UPLOAD_BLOCK_ERROR,message:o.translate("Upload block HTTP error."),file:l,response:t.responseText,status:t.status,responseHeaders:t.getAllResponseHeaders()});i(function(){m(e)},2e3),D[e]++}function m(e){var s=r(e),i=new t.XMLHttpRequest;i.withCredentials=!0;var d={};d._subject_uid=a.settings.multipart_params._subject_uid,d.owner_id=a.settings.multipart_params._subject_uid,d.t=a.settings.multipart_params.t,d.reported_block_size=s.size,d.num_blocks=z,d.ns_id_for_routing=a.settings.multipart_params.ns_id_for_routing;var c=0;i.upload?i.upload.onprogress=function(e){e.loaded&&(l.loaded+=e.loaded-c,c=e.loaded,a.trigger("UploadProgress",l,!0))}:i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&200===i.status&&(l.loaded+=s.size,a.trigger("UploadProgress",l,!0))},i.onload=function(){if(i.status>=400)return void p(e,i);var t,r,s;try{t=JSON.parse(i.response),r=t.block_hash,s=t.token}catch(t){return n(),void a.trigger("Error",{code:o.SERVER_RESPONSE_ERROR,message:o.translate("Server response error."),file:l,blockIndex:e})}if(!r)return n(),void a.trigger("Error",{code:o.SERVER_HASH_EMPTY_ERROR,message:o.translate("Server hash empty or undefined error."),file:l,blockIndex:e});if(!s)return n(),void a.trigger("Error",{code:o.SERVER_TOKEN_EMPTY_ERROR,message:o.translate("Server token empty or undefined error."),file:l,blockIndex:e});if(A){if(r!==N[e])return n(),void a.trigger("Error",{code:o.HASHES_NOT_EQUAL_ERROR,message:o.translate("Client and server hashes not equal error."),file:l,blockIndex:e});P[e]=s,C++,delete v[e]}else P[e]=s,C++,delete v[e];if(T<L)T++,m(T);else{if(T>L)return n(),void a.trigger("Error",{code:o.BLOCK_INDEX_ERROR,message:o.translate("Block index error."),file:l,blockIndex:e});if(u())I(JSON.stringify(P));else if(T===L&&!Object.keys(v).length&&!u())return n(),void a.trigger("Error",{code:o.COMMIT_READINESS_ERROR,message:o.translate("Done iterating over blocks, but no requests in progress or outstanding and not ready to commit."),file:l})}},i.onerror=function(){p(e,i)},i.onloadend=function(){delete v[e],this.destroy(),i=null},E=o.buildUrl(a.settings.waterfall_upload_block_url,d),i.open("post",E,!0),i.setRequestHeader("Content-Type","application/octet-stream"),o.each(a.settings.headers,function(e,t){i.setRequestHeader(t,e)}),v[e]=i,i.send(s),D[e]++}function S(e,t){if(!(507!==e.status&&H<a.settings.max_retries))return l.loaded=0,s(v),v={},void a.trigger("Error",{code:o.COMMIT_HTTP_ERROR,message:o.translate("Commit HTTP error."),file:l,response:e.responseText,status:e.status,responseHeaders:e.getAllResponseHeaders()});i(function(){I(t)},8e3),H++}function I(e){var r=new t.XMLHttpRequest;r.withCredentials=!0;var s={};if(s._subject_uid=a.settings.multipart_params._subject_uid,s.t=a.settings.multipart_params.t,s.name=l.target_name||l.name,s.dest=a.settings.multipart_params.dest,s.reported_total_size=a.settings.multipart_params.reported_total_size,s.overwrite=a.settings.multipart_params.overwrite,r.onload=function(){if(r.status>=400)return void S(r,e);r.readyState===XMLHttpRequest.DONE&&200===r.status&&(l.size!=l.origSize&&(R.destroy(),R=null),a.trigger("UploadProgress",l,!0),l.status=o.DONE,a.trigger("FileUploaded",l,{response:r.responseText,status:r.status,responseHeaders:r.getAllResponseHeaders()}),v={})},r.onerror=function(){S(r)},r.onloadend=function(){v={},this.destroy(),r=null},E=o.buildUrl(a.settings.waterfall_commit_upload_url,s),r.open("post",E,!0),r.setRequestHeader("Content-Type","application/octet-stream"),o.each(a.settings.headers,function(e,t){r.setRequestHeader(t,e)}),v.commitRequest=r,1!==Object.keys(v).length||!v.hasOwnProperty("commitRequest"))return n(),void a.trigger("Error",{code:o.COMMIT_READINESS_ERROR,message:o.translate("In commitFile call, but more than 1 request in progress or requestsInProgress map lacks the commit request."),file:l});r.send(e),H++}if(!R)return void a.trigger("Error",{code:o.BLOB_MISSING_ERROR,message:o.translate("Blob is missing."),file:l});var y=R.size;if(!R.size)return void a.trigger("Error",{code:o.BLOB_EMPTY_ERROR,message:o.translate("Blob size is 0 bytes."),file:l});if(l.status!=o.DONE&&l.status!=o.FAILED&&a.state!=o.STOPPED){if(!h.chunks)return void a.trigger("Error",{code:o.CHUNKS_NOT_ENABLED_ERROR,message:o.translate("Chunks not enabled error."),file:l});for(var T,A=!!(e.crypto&&e.crypto.subtle&&e.crypto.subtle.digest),z=Math.ceil(y/b),C=0,D=[],H=0,N=[],P=[],L=z-1,w=0;w<z;w++)P.push(void 0),N.push(void 0),D.push(0);A?g(function(){_()}):_()}}function p(){function r(e){var t;if(A<=b)t=R;else{var r=e*b,s=Math.min(b,A-r);t=R.slice(r,r+s)}return t&&0!==t.size?t:(n(),void a.trigger("Error",{code:o.BLOCK_EMPTY_ERROR,message:o.translate("Block is empty."),file:l,blockIndex:e}))}function u(){return z===C&&H.length===C&&!H.includes(void 0)}function d(e,t){if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function c(e){for(;e.endsWith("=");)e=e.slice(0,-1);return e}function g(e){return e.replace(/\//g,"_").replace(/\+/g,"-")}function _(e){function t(s){var i=r(s);if(!i.ruid)return n(),void a.trigger("Error",{code:o.BLOCK_RUNTIME_ID_MISSING_ERROR,message:o.translate("Block ruid missing."),file:l});i.connectRuntime(i.ruid);var u=new FileReader;f=u,u.onloadend=function(r){if(!r.target.result&&!O)return n(),void a.trigger("Error",{code:o.FILE_READER_NULL_RESULT_ERROR,message:o.translate("File reader null result."),file:l,blockIndex:s});var u=crypto.subtle.digest("SHA-256",r.target.result);i.disconnectRuntime(),u.then(function(r){var i=btoa(String.fromCharCode.apply(null,new Uint8Array(r))),u=g(i);if(u=c(u),!u&&!O)return n(),void a.trigger("Error",{code:o.CLIENT_HASH_EMPTY_ERROR,message:o.translate("Client hash empty or undefined error."),file:l});N[s]=u,s++,l.loaded+=1e4,a.trigger("UploadProgress",l,!1),s>=C?(l.loaded=0,e()):t(s)}).catch(function(e){if(!O)return n(),void a.trigger("Error",{code:o.CLIENT_HASH_DIGEST_ERROR,message:o.translate(e),file:l,blockIndex:s})})};var d=i.getSource();u.readAsArrayBuffer(d)}t(0)}function p(){for(var e=0;e<6&&e<C;e++)T=e,S(e)}function m(e,t){if(!(507!==t.status&&D[e]<a.settings.max_retries))return l.loaded=0,n(),void a.trigger("Error",{code:o.UPLOAD_BLOCK_ERROR,message:o.translate("Upload block HTTP error."),file:l,response:t.responseText,status:t.status,responseHeaders:t.getAllResponseHeaders()});i(function(){S(e)},2e3),D[e]++}function S(e){var s=r(e),i=new t.XMLHttpRequest;i.withCredentials=!0;var c={};c._subject_uid=a.settings.multipart_params._subject_uid,c.t=a.settings.multipart_params.t,c.num_blocks=C,c.reported_block_size=s.size,c.ns_id_for_routing=a.settings.multipart_params.ns_id_for_routing;var g=0;i.upload?i.upload.onprogress=function(e){e.loaded&&(l.loaded+=e.loaded-g,g=e.loaded,a.trigger("UploadProgress",l,!0))}:i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&200===i.status&&(l.loaded+=s.size,a.trigger("UploadProgress",l,!0))},i.onload=function(){if(i.status>=400)return void m(e,i);var t;try{t=JSON.parse(i.response).block_hash}catch(t){return n(),void a.trigger("Error",{code:o.SERVER_HASH_RESPONSE_ERROR,message:o.translate("Block hash response error."),file:l,blockIndex:e})}if(!t)return n(),void a.trigger("Error",{code:o.SERVER_HASH_EMPTY_ERROR,message:o.translate("Server hash empty or undefined error."),file:l,blockIndex:e});if(y){if(t!==N[e])return n(),void a.trigger("Error",{code:o.HASHES_NOT_EQUAL_ERROR,message:o.translate("Client and server hashes not equal error."),file:l,blockIndex:e});H[e]=t,z++,delete v[e]}else H[e]=t,z++,delete v[e];if(T<C-1)T++,S(T);else{if(T>C)return n(),void a.trigger("Error",{code:o.BLOCK_INDEX_ERROR,message:o.translate("Block index error."),file:l,blockIndex:e});if(u()){if(y&&!d(H,N))return n(),void a.trigger("Error",{code:o.HASHES_NOT_EQUAL_ERROR,message:o.translate("Client and server hashes not equal error."),file:l,blockIndex:e});I(H)}else if(T===C-1&&!Object.keys(v).length&&!u())return n(),void a.trigger("Error",{code:o.COMMIT_READINESS_ERROR,message:o.translate("Done iterating over blocks, but no requests in progress or outstanding and not ready to commit."),file:l})}},i.onerror=function(){m(e,i)},i.onloadend=function(){delete v[e],this.destroy(),i=null},E=o.buildUrl(a.settings.upload_block_url,c),i.open("post",E,!0),i.setRequestHeader("Content-Type","application/octet-stream"),o.each(a.settings.headers,function(e,t){i.setRequestHeader(t,e)}),v[e]=i,i.send(s),D[e]++}function I(e){function r(e){if(!(507!==e.status&&d<a.settings.max_retries))return l.loaded=0,s(v),v={},void a.trigger("Error",{code:o.COMMIT_HTTP_ERROR,message:o.translate("Commit HTTP error."),file:l,response:e.responseText,status:e.status,responseHeaders:e.getAllResponseHeaders()});i(function(){u()},8e3),d++}function u(){var s=new t.XMLHttpRequest;if(s.withCredentials=!0,s.onload=function(){if(s.status>=400)return void r(s);s.readyState===XMLHttpRequest.DONE&&200===s.status&&(l.size!=l.origSize&&(R.destroy(),R=null),a.trigger("UploadProgress",l,!0),l.status=o.DONE,a.trigger("FileUploaded",l,{response:s.responseText,status:s.status,responseHeaders:s.getAllResponseHeaders()}),v={})},s.onerror=function(){r(s)},s.onloadend=function(){v={},this.destroy(),s=null},E=o.buildUrl(a.settings.commit_file_url,c),s.open("post",E,!0),s.setRequestHeader("Content-Type","application/octet-stream"),o.each(a.settings.headers,function(e,t){s.setRequestHeader(t,e)}),v.commitRequest=s,1!==Object.keys(v).length||!v.hasOwnProperty("commitRequest"))return n(),void a.trigger("Error",{code:o.COMMIT_READINESS_ERROR,message:o.translate("In commitFile call, but more than 1 request in progress or requestsInProgress map lacks the commit request."),file:l});s.send(e),d++}var d=0,c={};if(c._subject_uid=a.settings.multipart_params._subject_uid,c.t=a.settings.multipart_params.t,c.dest=a.settings.multipart_params.dest,c.name=l.target_name||l.name,c.overwrite=a.settings.multipart_params.overwrite,c.reported_total_size=a.settings.multipart_params.reported_total_size,e.length!==C)return void a.trigger("Error",{code:o.BLOCKS_MISSING_ERROR,message:o.translate("Blocks missing error."),file:l});u()}var y=!!(e.crypto&&e.crypto.subtle&&e.crypto.subtle.digest);if(!R.size)return void a.trigger("Error",{code:o.BLOB_EMPTY_ERROR,message:o.translate("Blob size is 0 bytes."),file:l});var T,A=R.size,z=0,C=Math.ceil(A/b),D=[],H=[],N=[];if(l.status!=o.DONE&&l.status!=o.FAILED&&a.state!=o.STOPPED){if(!h.chunks)return void a.trigger("Error",{code:o.CHUNKS_NOT_ENABLED_ERROR,message:o.translate("Chunks not enabled error."),file:l});for(var P=0;P<C;P++)H.push(void 0),N.push(void 0),D.push(0);y?_(function(){p()}):p()}}var R,E=a.settings.url,h=a.features,b=r.chunk_size,I=r.max_retries,y=0;l.loaded&&(y=l.loaded=b*Math.floor(l.loaded/b)),R=l.getSource(),!t.isEmptyObj(a.settings.resize)&&c(R,"send_binary_string")&&~t.inArray(R.type,["image/jpeg","image/png"])?g.call(this,R,a.settings.resize,function(e){R=e,l.size=e.size,r.waterfall_parallel_uploads?_():r.parallel_uploads?p():d()}):r.waterfall_parallel_uploads?_():r.parallel_uploads?p():d()}),p.bind("UploadProgress",function(e,t,r){l(t)}),p.bind("StateChanged",function(e){if(e.state==o.STARTED)_=+new Date;else if(e.state==o.STOPPED)for(var t=e.files.length-1;t>=0;t--)e.files[t].status==o.UPLOADING&&(e.files[t].status=o.QUEUED,u())}),p.bind("QueueChanged",u),p.bind("Error",function(e,t){t.file&&(t.file.status=o.FAILED,l(t.file),e.state==o.STARTED&&i(function(){a.call(p)},1))}),p.bind("FileUploaded",function(){u(),i(function(){a.call(p)},1)}),p.trigger("Init",{runtime:this.runtime}),d.call(this)},refresh:function(){R&&R.trigger("Refresh"),this.trigger("Refresh")},start:function(){this.state!=o.STARTED&&(this.state=o.STARTED,this.trigger("StateChanged"),a.call(this))},stop:function(){this.state!=o.STOPPED&&(this.state=o.STOPPED,this.trigger("StateChanged"),this.trigger("CancelUpload"))},disableBrowse:function(){I=void 0===arguments[0]||arguments[0],R&&R.disable(I),this.trigger("DisableBrowse",I)},getFile:function(e){var t;for(t=h.length-1;t>=0;t--)if(h[t].id===e)return h[t]},addFile:function(e,r){function s(){var e=E||R;return!!e&&e.getRuntime().uid}function a(e,r){var s=[];t.each(d.settings.filters,function(t,r){n[r]&&s.push(function(s){n[r].call(d,t,e,function(e){s(!e)})})}),t.inSeries(s,r)}function l(e){var s=t.typeOf(e);if(e instanceof t.File){if(!e.ruid&&!e.isDetached()){if(!u)return!1;e.ruid=u,e.connectRuntime(u)}const n=new o.File(e);n.batchId=e.batchId,l(n)}else if(e instanceof t.Blob)l(e.getSource()),e.destroy();else if(e instanceof o.File)r&&(e.dest=r),c.push(function(t){a(e,function(r){r||g.push(e),i(t,1)})});else if(t.inArray(s,["file","blob"])!==-1){const d=new t.File(null,e);d.batchId=e.batchId,l(d)}else"node"===s&&"filelist"===t.typeOf(e.files)?t.each(e.files,l):"array"===s&&t.each(e,l)}var u,d=this,c=[],g=[];u=s(),l(e),c.length&&t.inSeries(c,function(){g.length&&d.trigger("FilesAdded",g)})},removeFile:function(e){for(var t="string"==typeof e?e:e.id,r=h.length-1;r>=0;r--)if(h[r].id===t)return this.splice(r,1)[0]},splice:function(e,t){var r=h.splice(void 0===e?0:e,void 0===t?h.length:t);return this.trigger("FilesRemoved",r),this.trigger("QueueChanged"),o.each(r,function(e){e.destroy()}),r},trigger:function(e){var t,r,s=b[e.toLowerCase()];if(s)for(r=Array.prototype.slice.call(arguments),r[0]=this,t=0;t<s.length;t++)if(s[t].func.apply(s[t].scope,r)===!1)return!1;return!0},hasEventListener:function(e){return!!b[e.toLowerCase()]},bind:function(e,t,r){var s;e=e.toLowerCase(),s=b[e]||[],s.push({func:t,scope:r||this}),b[e]=s},unbind:function(e){e=e.toLowerCase();var t,r=b[e],s=arguments[1];if(r){if(void 0!==s){for(t=r.length-1;t>=0;t--)if(r[t].func===s){r.splice(t,1);break}}else r=[];r.length||delete b[e]}},unbindAll:function(){var e=this;o.each(b,function(t,r){e.unbind(r)})},destroy:function(){this.stop(),o.each(h,function(e){e.destroy()}),h=[],R&&(R.destroy(),R=null),E&&(E.destroy(),E=null),S={},_=p=I=m=null,this.trigger("Destroy"),this.unbindAll(),b={}}})},o.File=(function(){function e(e){o.extend(this,{id:o.guid(),name:e.name||e.fileName,dest:"",type:e.type||"",size:e.size||e.fileSize,origSize:e.size||e.fileSize,loaded:0,percent:0,status:o.QUEUED,lastModifiedDate:e.lastModifiedDate||(new Date).toLocaleString(),getNative:function(){var e=this.getSource().getSource();return t.inArray(t.typeOf(e),["blob","file"])!==-1?e:null},getSource:function(){return r[this.id]?r[this.id]:null},destroy:function(){var e=this.getSource();e&&(e.destroy(),delete r[this.id])}}),r[this.id]=e}var r={};return e})(),o.QueueProgress=function(){var e=this;e.size=0,e.loaded=0,e.uploaded=0,e.failed=0,e.queued=0,e.percent=0,e.bytesPerSec=0,e.reset=function(){e.size=e.loaded=e.uploaded=e.failed=e.queued=e.percent=e.bytesPerSec=0}},e.plupload=o})(window,e),window.plupload}.bind(Object.create(null)));
//# sourceMappingURL=plupload_dev-2.0.0.min.js-vflHyw2jC.map