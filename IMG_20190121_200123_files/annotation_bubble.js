define(["require","exports","tslib","external/classnames","external/create-react-class","react","external/react-dom-factories","external/prop-types","external/react-addons-pure-render-mixin","modules/clean/comments/annotation_utils","modules/clean/comments/components/ui_constants","modules/clean/react/file_comments/conversation_or_input_card","modules/clean/react/sprite","modules/constants/comments_panel","modules/core/i18n"],function(t,n,e,o,i,s,r,a,u,l,p,m,c,d,b){"use strict";function h(t,n){return void 0!==t&&null!==t?n(t):void 0}Object.defineProperty(n,"__esModule",{value:!0}),o=e.__importDefault(o),i=e.__importDefault(i),s=e.__importDefault(s),r=e.__importStar(r),a=e.__importStar(a),u=e.__importStar(u),l=e.__importStar(l),d=e.__importStar(d);var f=i.default({displayName:"AnnotationBubble",mixins:[u],propTypes:{user:a.object,activity:a.object,x:a.number,y:a.number,showBubble:a.bool,in_blank_state:a.bool,annotation:a.object,position:a.string,maxHeight:a.number,shouldShowExpandBubble:a.bool,isMouseOnAnnotation:a.bool,commentText:a.string,actionCreators:a.object.isRequired},getInitialState:function(){return{showExpandBubble:this.props.shouldShowExpandBubble}},getDefaultProps:function(){return{position:"top",maxHeight:p.DEFAULT_ANNOTATION_COMMENT_INPUT_MAX_HEIGHT}},componentWillReceiveProps:function(t){if(this.props.shouldShowExpandBubble)if(t.commentText||this.props.showBubble!==!1||t.showBubble!==!0||this.setState({showExpandBubble:!0}),this.props.isMouseOnAnnotation){if(!t.isMouseOnAnnotation)return this._onAnnotationExpandBubbleMouseLeave()}else if(t.isMouseOnAnnotation)return this._onAnnotationExpandBubbleMouseEnter()},componentWillUnmount:function(){return clearTimeout(this.hideBubbleTimeout)},onInputFocus:function(t){return{}},onInputBlur:function(t){return{}},onMention:function(){return this.props.actionCreators.setMentionedContact(!0)},onAddComment:function(t){return this.props.actionCreators.addInlineAnnotation({text:t})},onAddSticker:function(t){return this.props.actionCreators.addInlineAnnotation({stickerId:t})},onCancelComment:function(){return this.props.actionCreators.cancelAnnotationComment()},_getCommentInputRef:function(){return null!=this.refs.commentInputCard?this.refs.commentInputCard.refs.commentInput:void 0},_focusOnCommentInput:function(){return h(this._getCommentInputRef(),function(t){return t.focusInput()})},_getRawCommentInput:function(){return h(this._getCommentInputRef(),function(t){return t.getRawCommentInput()})||""},_saveDraft:function(){var t=this._getRawCommentInput();return t.length>0&&t!==h(this._getCommentInputRef(),function(t){return t.getPlaceholderText()})?this.props.actionCreators.updateAnnotationText(t):this.props.actionCreators.updateAnnotationText(null)},_onAnnotationExpandBubbleClick:function(){return this.setState({showExpandBubble:!1})},_onAnnotationExpandBubbleMouseEnter:function(){return clearTimeout(this.hideBubbleTimeout)},_onAnnotationExpandBubbleMouseLeave:function(){return this._setHideCommentTimeOut()},_setHideCommentTimeOut:function(){return clearTimeout(this.hideBubbleTimeout),this.hideBubbleTimeout=setTimeout(this._maybeHideComment,3e3)},_maybeHideComment:function(){if(this.state.showExpandBubble&&!this.props.isMouseOnAnnotation)return this.onCancelComment()},_renderCommentInput:function(){var t={maxHeight:this.props.maxHeight},n={ref:"commentInput",activity:this.props.activity,metadata:this.props.annotation,usersToNotify:this.props.activity.users_to_notify,targetActivity:this.props.activity,user:this.props.user,initialText:this.props.commentText,enableNoNotifyHint:!1,commentMetadataAllowed:!0,shouldPopupsDropdown:!1,shouldAlwaysInEditMode:!0,shouldEnableCancelButton:!1,shouldInitiallyFocusInput:!0,shouldEnableStickers:d.ALLOW_STICKERS,shouldShowPostText:!0,onAddComment:this.onAddComment,onAddSticker:this.onAddSticker,onCancelComment:this.onCancelComment,onFocus:this.onInputFocus,onBlur:this.onInputBlur,onMention:this.onMention,onChange:this._saveDraft};return r.div({className:"annotation-bubble__field",style:t},s.default.createElement(m.InputCard,{ref:"commentInputCard",shouldInitiallyShowNotifyHint:this.props.shouldShowExpandBubble,initialUsersToNotify:null!=this.props.activity?this.props.activity.users_to_notify:void 0,commentProps:n,actionCreators:this.props.actionCreators}))},_renderExpandBubble:function(){return r.div({className:"expand-bubble-icon",onClick:this._onAnnotationExpandBubbleClick,onMouseEnter:this._onAnnotationExpandBubbleMouseEnter,onMouseLeave:this._onAnnotationExpandBubbleMouseLeave},s.default.createElement(c.Sprite,{group:"web",name:"ic_comment_text",alt:b._("Comment on text")}))},render:function(){var t,n=this.props.x||0,e=this.props.y||0,i=this.props.position;if(t=this.props.position.indexOf("bottom")>=0?"bottom":"top",this.state.showExpandBubble){var s=Array.from(l.getExpandBubblePosition(this.props.position,this.props.x,this.props.y)),a=s[0],u=s[1];n=u.x,e=u.y,i=a}var p=(m={left:n},m[t]=e,m);return r.div({className:"annotation-bubble-container"},r.div({className:o.default((c={"annotation-bubble":!0,"annotation-bubble--hidden":!this.props.showBubble,"bubble-dropdown":!0,"expand-bubble":this.state.showExpandBubble},c[i]=!0,c)),style:p},this.state.showExpandBubble?this._renderExpandBubble():this._renderCommentInput(),r.div({className:"bubble-arrow-border"}),r.div({className:"bubble-arrow"})));var m,c}});n.default=f});
//# sourceMappingURL=annotation_bubble.min.js-vflCYDXp6.map