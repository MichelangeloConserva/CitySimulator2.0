define(["require","exports","tslib","react","modules/clean/react/css","modules/core/i18n","spectrum/button","spectrum/popover","modules/clean/react/file_viewer/open_button/utils","spectrum/label","modules/clean/static_urls","modules/clean/react/file_viewer/open_button/types","modules/clean/react/app_actions/telemetry_client","modules/clean/react/app_actions/category","modules/clean/react/files_view/constants","modules/clean/react/app_actions/redirect","modules/clean/react/sprite","spectrum/icon_action","spectrum/icon_document","spectrum/tertiary_link","modules/clean/react/file_viewer/unity/with_unity","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/logging","modules/clean/react/app_actions/education/edu_tooltip_component","modules/clean/react/app_actions/apis"],function(e,t,n,o,a,i,r,p,s,c,l,u,d,m,g,y,f,h,_,v,N,E,O,w,C){"use strict";function A(e){return void 0!==e.legacyOptionName}Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o);var I=[{entries:[{legacyOptionName:"unity"}]},{displayName:i._("Edit"),entries:[{legacyOptionName:"openWith"},{categoryId:m.Category.PDF_EDITING},{categoryId:m.Category.IMAGE_EDITING}]},{displayName:i._("Copy to"),entries:[{legacyOptionName:"copyTo"}]},{displayName:m.Category.getDisplayName(m.Category.VIDEO_COMMENT),entries:[{categoryId:m.Category.VIDEO_COMMENT}]},{displayName:m.Category.getDisplayName(m.Category.VIEW_OR_EDIT),entries:[{categoryId:m.Category.VIEW_OR_EDIT}]},{displayName:m.Category.getDisplayName(m.Category.ESIGNATURE),entries:[{legacyOptionName:"esignature"},{categoryId:m.Category.ESIGNATURE}]},{displayName:m.Category.getDisplayName(m.Category.SEND_FAX),entries:[{categoryId:m.Category.SEND_FAX}]},{displayName:i._("Collaborate"),entries:[{legacyOptionName:"slack"}]},{displayName:i._("Download"),entries:[{legacyOptionName:"download"}]},{displayName:i._("TESTING"),entries:[{categoryId:m.Category.DEFAULT}]}],D=(function(e){function t(t){var a=e.call(this,t)||this;return a.setActionMenuRef=function(e){a.actionMenuContent=e},a.handleButtonClick=function(e){e.preventDefault(),e.stopPropagation(),a.setPopoverContentPosition()},a.handleHover=function(){a.currentSession&&a.currentSession.event("trigger_hover")},a.handlePreventMouseDown=function(e){e.preventDefault(),C.logTooltipHistory(a.props.user.id),a.setState({showTooltip:!1})},a.setEduTooltip=function(e){return n.__awaiter(a,void 0,void 0,function(){var t;return n.__generator(this,function(n){switch(n.label){case 0:return[4,C.getTooltipHistory(e)];case 1:return t=n.sent(),this.setState({showTooltip:!t}),[2]}})})},a.handleSelectAction=function(e,t){t.preventDefault(),e.handler(),a.logToPreviews(e,!1),t.stopPropagation()},a.logToPreviews=function(e,t){if(a.props.telemetryContext&&"previews"===a.props.telemetryContext.surface&&e.userAction){var n=t?E.UserActionContext.TitleBarMain:E.UserActionContext.TitleBarSplitButton,o=e.actionName?{app_action_name:e.actionName}:{};a.props.file.read_only&&(o.readOnly=!0),O.logUserAction(e.userAction,n,o)}},a.renderCategory=function(e){return o.default.createElement(p.PopoverItemGroup,{className:"app-action-category-group",key:e.key},e.displayName?o.default.createElement(p.PopoverItemGroupTitle,{className:"app-action-category-title"},e.displayName):null,e.actions.map(function(e){return a.renderActionRow(e)}),o.default.createElement(p.PopoverItemGroupSeparator,{className:"app-action-menu-separator"}))},a.wrapperForAction=function(e){return{handler:function(){y.redirectToAction(a.props.user.id,e.id,e.description,a.props.file.file_id),a.currentSession&&a.currentSession.event("select_action",{action_id:e.id,encoded_app_id:e.app_id})},userAction:E.UserAction.OpenWithAppAction,actionName:e.description}},a.renderActionRow=function(e){if(!a.isApiAppAction(e))return e;var t;return t=e.icon.is_static?l.static_url(e.icon.url):e.icon.url,o.default.createElement(p.PopoverContentItem,{className:"app-action-row",key:e.id,value:a.wrapperForAction(e)},o.default.createElement("div",{className:"app-action-row-content"},o.default.createElement("img",{className:"app-action-popover-icon",src:t,alt:""}),o.default.createElement(c.Label,{htmlFor:e.description},e.description)))},a.renderTrigger=function(){return"sidebar-link"===a.props.triggerType?o.default.createElement(v.TertiaryLink,{className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-link",icon:"open-with"},a.props.buttonText):o.default.createElement(r.Button,{className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",variant:"secondary"},a.props.buttonText)},a.renderMenu=function(e){return o.default.createElement("div",{className:"app-action-open-with-menu",ref:a.setActionMenuRef},o.default.createElement(p.Popover,{className:"app-action-open-with-menu__popover",onClick:a.handleButtonClick,onDoubleClick:a.handleButtonClick,onSelection:a.handleSelectAction,onMenuToggle:a.onPopoverToggle,closeOnSelection:!0},o.default.createElement(p.PopoverTrigger,null,o.default.createElement("div",{onMouseDown:a.handlePreventMouseDown,onMouseEnter:a.handleHover},a.renderTrigger())),o.default.createElement(p.PopoverContent,{position:a.state.popoverContentPosition,attachment:"right"},a.renderActions(e))),a.state.showTooltip?o.default.createElement(w.AppActionsTooltip,{userId:a.props.user.id,targetNode:a.actionMenuContent}):null)},a.onPopoverToggle=function(e){var t=e.isOpen;a.props.onDropdownOpen&&a.props.onDropdownClose&&(t?a.props.onDropdownOpen():a.props.onDropdownClose()),a.currentSession&&a.currentSession.event(t?"open_popover":"close_popover")},a.onDownloadClick=function(e){return function(t){t.preventDefault(),t.stopPropagation(),e.handler(),a.logToPreviews(e,!0)}},a.state={popoverContentPosition:"below",showTooltip:void 0},a.telemetryClient=d.createTelemetryClient({component:"menu"}),a}return n.__extends(t,e),t.prototype.componentDidMount=function(){this.props.showEduTooltip&&void 0===this.state.showTooltip&&this.setEduTooltip(this.props.user.id)},t.prototype.includeDownloadInMenu=function(){return this.props.showAsButtonIfDownloadOnly},t.prototype.getLegacyOptionsWithLogging=function(e){var t=this;return e.map(function(e){return n.__assign({},e,{handler:function(){e.handler(),t.currentSession&&t.currentSession.event("select_legacy_action",{type:e.type})}})})},t.prototype.setPopoverContentPosition=function(){var e=this,t=this.actionMenuContent.getElementsByClassName("app-action-open-with-menu__trigger")[0],n=2*g.OverflowMenuConstants.MENU_MARGIN_PX,o=0,a=0,i=0,r=0,p=0;s.getOpenOptions({file:this.props.file,hasOpenInPaperSupport:!!this.props.hasOpenInPaperSupport,isOpenWithDisabled:!!this.props.isOpenWithDisabled,unityInfo:this.props.unityInfo||[],extraOptions:this.props.extraOptions,user:this.props.user,isSlackEnabled:this.props.showGeminiActions}).forEach(function(t){t.type===u.OpenButtonAction.OPEN_IN_PAPER?o=n+32:t.type===u.OpenButtonAction.OPEN_WITH?a=n+32:t.type===u.OpenButtonAction.UNITY_FILE||t.type===u.OpenButtonAction.UNITY_FOLDER?i=n:t.type===u.OpenButtonAction.DOWNLOAD&&e.includeDownloadInMenu()&&(r=n),(e.includeDownloadInMenu()||t.type!==u.OpenButtonAction.DOWNLOAD)&&(p+=40)}),p+=o+a+i+r,this.props.extensionsConfig.actionCategories.forEach(function(e){p+=40*e.actions.length+n+32});var c=t.getBoundingClientRect();c.top>p+132&&c.bottom+p>window.innerHeight?this.setState({popoverContentPosition:"above"}):this.setState({popoverContentPosition:"below"})},t.prototype.renderLegacyOpenOptions=function(e){var t=this,n=this.getLegacyOptionsWithLogging(e),a=[],r=[],s=[],c=[],d=[],m=[];return n.forEach(function(e){var n=e.type,g=n===u.OpenButtonAction.OPEN_IN_PAPER,y=n===u.OpenButtonAction.OPEN_WITH,v=n===u.OpenButtonAction.UNITY_FILE||n===u.OpenButtonAction.UNITY_FOLDER,N=n===u.OpenButtonAction.DOWNLOAD,E=n===u.OpenButtonAction.PREPARE_FOR_SIGNATURE,O=n===u.OpenButtonAction.SHARE_TO_SLACK;if(g&&e.spriteName)a.push(o.default.createElement(p.PopoverContentItem,{className:"app-action-row",key:e.text,value:e},o.default.createElement("div",{className:"app-action-row-content"},o.default.createElement("img",{alt:"",src:l.static_url("/static/images/paper/paper-icon-vfluG3iA1.png"),className:"app-action-popover-icon"}),o.default.createElement("span",{className:"app-action-legacy-option-text"},i._("Paper")))));else if((v||y)&&e.spriteName){var w=v?s:r;w.push(o.default.createElement(p.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},o.default.createElement("div",{className:"app-action-row-content"},o.default.createElement(f.Sprite,{group:"web",name:e.spriteName,alt:e.text,className:"app-action-popover-icon-sprite"}),o.default.createElement("span",{className:"app-action-legacy-option-text"},e.text))))}else N&&t.includeDownloadInMenu()?c.push(o.default.createElement(p.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},o.default.createElement("div",{className:"app-action-row-content"},o.default.createElement(h.IconAction,{className:"app-action-popover-icon-svg",name:"download"}),o.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))):O?m.push(o.default.createElement(p.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},o.default.createElement("div",{className:"app-action-row-content"},o.default.createElement("img",{alt:i._("Share to Slack"),src:l.static_url("/static/images/thirdparty/slack_icon-vflKvKltK.svg"),className:"app-action-popover-icon"}),o.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))):E&&d.push(o.default.createElement(p.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},o.default.createElement("div",{className:"app-action-row-content"},o.default.createElement(_.IconDocument,{className:"app-action-popover-icon-svg",name:"signature-small"}),o.default.createElement("span",{className:"app-action-legacy-option-text"},e.text))))}),{copyTo:a,openWith:r,unity:s,download:c,slack:m,esignature:d}},t.prototype.renderActions=function(e){var t={};this.props.extensionsConfig.actionCategories.map(function(e){t[e.categoryId]=e});var n=[];return I.map(function(o,a){for(var i=[],r=0,p=o.entries;r<p.length;r++){var s=p[r];A(s)?i.push.apply(i,e[s.legacyOptionName]):t[s.categoryId]&&i.push.apply(i,t[s.categoryId].actions)}i.length>0&&n.push({displayName:o.displayName||null,key:"category-"+a,actions:i})}),n.map(this.renderCategory)},t.prototype.isApiAppAction=function(e){return void 0!==e.url},t.prototype.render=function(){this.props.telemetryContext?this.currentSession=this.telemetryClient.session({surface:this.props.telemetryContext.surface,ext:d.getPiiSafeExtension(this.props.file.ext)}):delete this.currentSession;var e=s.getOpenOptions({file:this.props.file,hasOpenInPaperSupport:!!this.props.hasOpenInPaperSupport,isOpenWithDisabled:!!this.props.isOpenWithDisabled,unityInfo:this.props.unityInfo||[],extraOptions:this.props.extraOptions,user:this.props.user,isSlackEnabled:this.props.showGeminiActions}),t=e.length>0,n=!1;if(t&&1===e.length&&(n=e[0].type===u.OpenButtonAction.DOWNLOAD,t=!n),0!==this.props.extensionsConfig.actionCategories.length||t){var a=this.renderLegacyOpenOptions(e);return this.renderMenu(a)}return this.props.showAsButtonIfDownloadOnly&&n?o.default.createElement(r.Button,{className:"app-actions-download-button",variant:"secondary",onClick:this.onDownloadClick(e[0])},i._("Download")):null},t.defaultProps={buttonText:i._("Open with ▾"),hasOpenInPaperSupport:!1,isOpenWithDisabled:!1,showAsButtonIfDownloadOnly:!1,triggerType:"button",unityInfo:{}},t})(o.default.Component),T=function(e){return o.default.createElement(N.WithUnity,{file:e.file,user:e.user,render:function(t){return o.default.createElement(D,n.__assign({},e,{unityInfo:t}))}})};t.AppActionsMenu=a.requireCssWithComponent(T,["/static/css/app_actions/index-vfl6C6JFW.css"]),t.AppActionsMenuNoUnity=a.requireCssWithComponent(D,["/static/css/app_actions/index-vfl6C6JFW.css"])});
//# sourceMappingURL=app_actions_menu_component.min.js-vflk5U1s_.map