define(["require","exports","modules/clean/previews/constants","modules/clean/react/file_viewer/file_viewer_interface_controller","modules/clean/activity/constants","modules/clean/react/comments2/data/actions","modules/clean/react/comments2/convert_annotation_coordinates","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/utils","modules/clean/react/comments2/data/sidebar_watcher"],function(t,n,e,o,i,a,s,r,c,d){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=(function(){function t(t,n){var e=this;this.dispatch=t,this.previewType=n,this.mostRecentlySyncedAnnotations=[],this.justPlacedDefaultAnnotation=!1,this.sendAnnotationsToSync=function(){e.interfaceController.dispatchEvent("update-annotations",{annotations:e.mostRecentlySyncedAnnotations})},this.onAnnotationPlaced=function(t){e.updatePendingAnnotation(t.annotation);var n=s.fromFileViewToComments2Annotation(t.annotation);"document"===n.type&&"highlight"===n.regionType||e.dispatch(a.Actions.requestEditorFocus());var o;e.justPlacedDefaultAnnotation?(o="annotation_created_automatically",e.justPlacedDefaultAnnotation=!1):o="annotation_created_manually",e.dispatch(a.Actions.logEvent(o))},this.onAnnotationStartDrag=function(t){},this.onAnnotationEndDrag=function(t){e.updatePendingAnnotation(t.annotation),e.dispatch(a.Actions.logEvent("annotation_adjusted"))},this.onAnnotationEnter=function(t){var n=t.commentActivity,o=n&&n.activity_key;e.dispatch(a.Actions.hoverThread(o))},this.onAnnotationLeave=function(t){e.dispatch(a.Actions.hoverThread(void 0))},this.onAnnotationClick=function(t){e.dispatch(a.Actions.activateNextThread(t.rankedActivityKeys))},this.onCommentsVisible=function(){e.dispatch(a.Actions.trackSidebarCommentsVisibility(!0)),e.interfaceController.dispatchEvent("enable-annotation-creation")},this.onCommentsHidden=function(){e.dispatch(a.Actions.trackSidebarCommentsVisibility(!1)),e.interfaceController.dispatchEvent("disable-annotation-creation")},this.docMetadataLoad=function(t){var n=t.metadata;e.dispatch(a.Actions.docMetadataLoad(n))},this.onCurrentPageUpdate=function(t){var n=t.current_page;t.doc_type===r.DocType.ppt&&e.dispatch(a.Actions.clearPendingNumberedAnnotation()),e.dispatch(a.Actions.updateDocumentCurrentPage(n))},this.eventListenerMap={"annotation-placed":this.onAnnotationPlaced,"annotation-start-drag":this.onAnnotationStartDrag,"annotation-end-drag":this.onAnnotationEndDrag,"annotation-ui-click":this.onAnnotationClick,"annotation-ui-enter":this.onAnnotationEnter,"annotation-ui-leave":this.onAnnotationLeave,"doc-metadata-load":this.docMetadataLoad,"page-rendered":this.sendAnnotationsToSync,"page-change":this.onCurrentPageUpdate},this.sideChannelListenerMap=(o={},o[d.COMMENTS_VISIBLE_SIGNAL]=this.onCommentsVisible,o[d.COMMENTS_HIDDEN_SIGNAL]=this.onCommentsHidden,o);var o}return t.prototype.handleMount=function(){this.interfaceController=new o.FileViewerInterfaceController(c.getFileViewerInterfaceType(i.ActivityContext.BROWSE_FILE_VIEWER,this.previewType));for(var t in this.eventListenerMap)this.interfaceController.addListener(t,this.eventListenerMap[t]);for(var t in this.sideChannelListenerMap)d.sideChannelEventEmitter.addListener(t,this.sideChannelListenerMap[t]);this.mostRecentlySyncedAnnotations=[],this.interfaceController.dispatchEvent("enable-annotation-creation"),this.interfaceController.dispatchEvent("enable-region-creation"),this.interfaceController.dispatchEvent("request-doc-metadata"),this.previewType===e.PreviewType.SsrDoc&&this.dispatch(a.Actions.updateDocumentCurrentPage(1))},t.prototype.handleUnmount=function(){this.interfaceController.dispatchEvent("disable-annotation-creation"),this.interfaceController.dispatchEvent("disable-region-creation"),this.interfaceController.destroy(),d.sideChannelEventEmitter.removeAllListeners()},t.prototype.focusAnnotation=function(t){this.interfaceController.dispatchEvent("focus-annotation",{id:t})},t.prototype.hoverAnnotation=function(t){this.interfaceController.dispatchEvent("hover-annotation",{id:t})},t.prototype.syncPdfAnnotations=function(t,n){return this.syncAnnotations(t,function(t){return s.fromComments2ToPdfFileViewAnnotations(t,n)})},t.prototype.syncImageAnnotations=function(t){return this.syncAnnotations(t,s.fromComments2ToImageFileViewAnnotations)},t.prototype.syncAnnotations=function(t,n){this.mostRecentlySyncedAnnotations=t.map(function(t){var e=t.annotation,o=void 0!==e.label?e.label:-1;return{annotation:n(e),commentActivity:{activity_key:t.id},options:{isGhostAnnotation:!1,isAnnotationNumberingEnabled:o!==-1,annotationNumber:o}}}),this.sendAnnotationsToSync()},t.prototype.addAnnotationHiddenListener=function(t){this.interfaceController.addListener("annotation-hidden",t)},t.prototype.removeAnnotationHiddenListener=function(t){this.interfaceController.removeListener("annotation-hidden",t)},t.prototype.placeDefaultAnnotation=function(){this.justPlacedDefaultAnnotation=!0,this.interfaceController.dispatchEvent("place-default-annotation")},t.prototype.scrollToAnnotation=function(t,n){this.interfaceController.dispatchEvent("scroll-to-annotation",{page:t,commentActivity:{activity_key:n}})},t.prototype.clearSelection=function(t){var n=this,e=n.dispatch;n.interfaceController.dispatchEvent("hide-annotation"),e(a.Actions.clearPendingNumberedAnnotation()),t&&e(a.Actions.logEvent("annotation_cancelled"))},t.prototype.updatePendingAnnotation=function(t){var n=s.fromFileViewToComments2Annotation(t);this.dispatch(a.Actions.setPendingNumberedAnnotation(n)),"document"===n.type&&this.interfaceController.dispatchEvent("hide-annotation",{excludePage:n.regions[0].page})},t})();n.FrameMessageListener=l});
//# sourceMappingURL=frame_message_listener.min.js-vfljIy8Gw.map